@* File: Areas/JobSeeker/Views/Inbox/Thread.cshtml *@
@model JobPortal.Areas.JobSeeker.Models.InboxThreadVM

@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = "Conversation";

    // NEW: block state
    bool isBlocked = false;
    try { isBlocked = (bool)(ViewBag.IsBlocked ?? false); } catch { isBlocked = false; }
    string blockedReason = (string)(ViewBag.BlockedReason ?? "");
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>@Model.JobTitle</h3>
</div>

<a asp-area="JobSeeker" asp-controller="Inbox" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
    &leftarrow; Back to Inbox
</a>
<div id="aiWarn" class="alert alert-warning d-none" role="alert"></div>


@if (isBlocked)
{
    <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="bi bi-shield-exclamation me-2"></i>
        <div>
            <strong>Chat is blocked by admin.</strong>
            @if (!string.IsNullOrWhiteSpace(blockedReason))
            {
                <span class="ms-1">@blockedReason</span>
            }
        </div>
    </div>
}

<div class="card mb-3">
    <div class="card-header">Conversation with @Model.RecruiterName</div>
    <div class="card-body">
        @foreach (var m in Model.Messages)
        {
            <div class="mb-3 @(m.FromRecruiter ? "text-start" : "text-end")">
                <div class="d-inline-block border rounded p-2">
                    <div class="small text-muted">@m.SenderName • @m.SentAt</div>
                    <div>@m.MessageText</div>
                </div>
            </div>
        }
    </div>
</div>

<form asp-action="SendMessage" asp-controller="Inbox" asp-area="JobSeeker" method="post" class="card">
    @Html.AntiForgeryToken()
    <input type="hidden" name="ThreadId" value="@Model.ThreadId" />
    <div class="card-body">
        <textarea name="MessageText" class="form-control" rows="3" maxlength="200"
            placeholder="@(isBlocked ? "Chat is blocked by admin." : "Write your reply...")" @(isBlocked ? "readonly            disabled" : "")>
@(!string.IsNullOrEmpty(ViewBag.PrefillMessage) ? ViewBag.PrefillMessage : Model.ReplyText)
        </textarea>
    </div>
    <div class="card-footer d-flex justify-content-end align-items-center gap-2">
        <span id="sendStatus" class="small text-muted d-none me-2">Sending…</span>
        <button id="sendBtn" class="btn btn-primary" type="submit" @(isBlocked ? "disabled aria-disabled=\"true\"" :
                                                                               "")>
            <span class="js-send-text">Send</span>
            <span class="spinner-border spinner-border-sm ms-1 d-none js-send-spin" role="status"
                aria-hidden="true"></span>
        </button>
    </div>

</form>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const message = @Html.Raw(Json.Serialize(TempData["Message"]));
            if (message) {
                Swal.fire({
                    icon: 'success',
                    title: message,
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        });
    </script>

    <script>
        (() => {
            const IS_BLOCKED = @(isBlocked ? "true" : "false");
            const form = document.querySelector('form[asp-action="SendMessage"]');
            const composer = form ? form.querySelector('textarea[name="MessageText"]') : null;
            const aiWarn = document.getElementById('aiWarn');
            const sendBtn = document.getElementById('sendBtn');
            const sendSpin = sendBtn ? sendBtn.querySelector('.js-send-spin') : null;
            const sendTxt = sendBtn ? sendBtn.querySelector('.js-send-text') : null;
            const sendStatus = document.getElementById('sendStatus');

            async function moderate() {
                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenInput ? tokenInput.value : '';
                const payload = { threadId: @Model.ThreadId, text: composer.value || '' };

                const resp = await fetch('@Url.Action("Moderate", "Inbox", new { area = "JobSeeker" })', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) return { allowed: true, reason: 'AI check unavailable.' };
                return await resp.json();
            }

            form.addEventListener('submit', async (e) => {
                if (IS_BLOCKED === true || IS_BLOCKED === 'true') return;
                e.preventDefault();

                aiWarn.classList.add('d-none'); aiWarn.textContent = '';
                const text = (composer.value || '').trim();
                if (!text) {
                    aiWarn.textContent = 'Message is empty.'; aiWarn.classList.remove('d-none'); composer.focus(); return;
                }

                // start UI
                if (sendBtn) sendBtn.disabled = true;
                if (sendSpin) sendSpin.classList.remove('d-none');
                if (sendTxt) sendTxt.textContent = 'Sending';
                if (sendStatus) { sendStatus.classList.remove('d-none'); sendStatus.textContent = 'Checking…'; }

                // 1) AI check
                try {
                    const result = await moderate();
                    if (result && result.allowed === false) {
                        aiWarn.innerHTML = `<strong>Message blocked:</strong> ${result.reason || 'Not allowed.'} ${result.category ? `<span class="badge bg-warning text-dark ms-2">${result.category}</span>` : ''}`;
                        aiWarn.classList.remove('d-none');

                        if (sendSpin) sendSpin.classList.add('d-none');
                        if (sendTxt) sendTxt.textContent = 'Send';
                        if (sendBtn) sendBtn.disabled = false;
                        if (sendStatus) { sendStatus.textContent = 'Blocked'; sendStatus.classList.add('text-danger'); setTimeout(() => sendStatus.classList.add('d-none'), 2000); }
                        composer.focus();
                        return;
                    }
                } catch { /* fail-open */ }

                if (sendStatus) sendStatus.textContent = 'Sending…';

                // 2) POST message via AJAX
                try {
                    const fd = new FormData(form);
                    const body = new URLSearchParams(fd);

                    const resp = await fetch('@Url.Action("SendMessage", "Inbox", new { area = "JobSeeker" })', {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body
                    });

                    let ok = false;
                    try { const data = await resp.json(); ok = !!data.ok; } catch { ok = resp.ok; }

                    if (ok) {
                        if (sendStatus) { sendStatus.textContent = 'Delivered'; sendStatus.classList.remove('text-muted'); sendStatus.classList.add('text-success'); }
                        setTimeout(() => window.location.reload(), 150);
                    } else {
                        if (sendStatus) { sendStatus.textContent = 'Failed to send'; sendStatus.classList.add('text-danger'); }
                    }
                } catch {
                    if (sendStatus) { sendStatus.textContent = 'Failed to send'; sendStatus.classList.add('text-danger'); }
                } finally {
                    if (sendSpin) sendSpin.classList.add('d-none');
                    if (sendTxt) sendTxt.textContent = 'Send';
                    if (sendBtn) sendBtn.disabled = false;
                }
            });
        })();
    </script>

}