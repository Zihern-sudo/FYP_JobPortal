@using JobPortal.Areas.JobSeeker.Models
@model JobPortal.Areas.JobSeeker.Models.InboxIndexVM

@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = "Inbox";
    var q = Model.Query;
    var filter = Model.Filter;

    string RoutePreserve(int page) => Url.Action("Index", new
    {
        q = q,
        filter = filter,
        page = page,
        pageSize = Model.PageSize
    })!;
}

<!-- Toast for system notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast-notify" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message"></div>
    </div>
</div>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="fw-semibold fs-5">Inbox</div>
</div>

<!-- Search + Filter -->
<form method="get" class="row g-2 mb-3">
    <div class="col-md-6">
        <input type="text" name="q" value="@q" class="form-control" placeholder="Search job, recruiter, message..." />
    </div>
    <div class="col-md-3">
        <select class="form-select" name="filter">
            <option value="">All messages</option>
            <option value="unread" selected="@(filter == "unread" ? "selected" : null)">Unread only</option>
        </select>
    </div>
    <div class="col-md-3 text-end">
        <button class="btn btn-primary" type="submit">Filter</button>
        <a asp-area="JobSeeker" asp-controller="Inbox" asp-action="Index" class="btn btn-outline-secondary">Reset</a>
    </div>
</form>

<!-- Message List -->
<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table mb-0 align-middle">
            <thead>
                <tr>
                    <th>Job</th>
                    <th>Recruiter</th>
                    <th>Last message</th>
                    <th>When</th>
                    <th class="text-end"></th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Threads.Count == 0)
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted">No conversations found.</td>
                    </tr>
                }
                else
                {
                    foreach (var t in Model.Threads)
                    {
                        <tr class="@(t.UnreadCount > 0 ? "fw-bold" : "")">
                            <td>@t.JobTitle</td>
                            <td>@t.RecruiterName</td>
                            <td class="text-muted">@t.LastMessageSnippet</td>
                            <td class="text-nowrap">@t.LastMessageAt</td>
                            <td class="text-end">
                                @if (t.UnreadCount > 0)
                                {
                                    <span class="badge text-bg-primary">@t.UnreadCount</span>
                                }
                                <a class="btn btn-sm btn-outline-primary" asp-area="JobSeeker" asp-controller="Inbox"
                                    asp-action="Thread" asp-route-id="@t.Id">
                                    Open
                                </a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<nav aria-label="paging" class="mt-3">
    <ul class="pagination justify-content-end">
        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
            <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(1))">First</a>
        </li>
        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
            <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(Model.Page - 1))">Prev</a>
        </li>

        @{
            var start = Math.Max(1, Model.Page - 2);
            var end = Math.Min(Model.TotalPages, Model.Page + 2);
            for (int p = start; p <= end; p++)
            {
                <li class="page-item @(p == Model.Page ? "active" : "")">
                    <a class="page-link" href="@RoutePreserve(p)">@p</a>
                </li>
            }
        }

        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
            <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.Page + 1))">Next</a>
        </li>
        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
            <a class="page-link"
                href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.TotalPages))">Last</a>
        </li>
    </ul>
</nav>

<div class="text-muted small">
    Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> &bull;
    Total <strong>@Model.TotalCount</strong> conversations
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var message = '@(TempData["Message"] as string)';
            if (message) {
                var toastEl = document.getElementById('toast-notify');
                var toastBody = document.getElementById('toast-message');
                toastBody.textContent = message;
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
    </script>
}