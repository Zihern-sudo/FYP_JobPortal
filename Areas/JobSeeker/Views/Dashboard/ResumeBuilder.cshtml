@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = "Resume Builder";
}
<link rel="stylesheet" href="~/css/dashboard.css" />

<div class="resume-builder-container">
    <h1>Resume Builder</h1>

    <form id="resumeForm" method="post" action="/JobSeeker/Dashboard/SaveResumePDF" enctype="multipart/form-data">
        <h3>Personal Information</h3>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">
                @TempData["Error"]
            </div>
        }

        <label for="template">Choose Resume Template</label>
        <select id="template" name="template" class="form-select" required>
            <option value="classic">Classic</option>
            <option value="modern">Modern</option>
        </select>

        <!-- Profile Picture Upload -->
        <label>Profile Picture</label>
        <input type="file" id="profilePic" name="profilePic" accept=".jpg,.jpeg,.png,.webp" />
        <div id="profilePreview" style="margin-top:10px;">
            <img id="previewImg" src="#" alt="Preview"
                style="display:none; width:120px; height:120px; border-radius:50%; object-fit:cover;" />
        </div>


        <label>Full Name</label>
        <input type="text" id="fullName" name="fullName" value="@Model.FullName" placeholder="John Doe" readonly />

        <label>Email</label>
        <input type="email" id="email" name="email" value="@Model.Email" placeholder="john@example.com" readonly />

        <label>Phone</label>
        <input type="text" name="phone" class="form-control" value="@(Model.Phone ?? "")" placeholder="+60 123 45678"
            maxlength="20" @(string.IsNullOrEmpty(Model.Phone) ? "" : "readonly") />

        <label>Address</label>
        <input type="text" id="address" name="address" value="@Model.Address" placeholder="Kuala Lumpur, Malaysia" />

        <h3>Professional Summary</h3>
        <textarea id="summary" name="summary" rows="4"
            placeholder="Briefly describe your background...">@Model.Summary</textarea>


        <h3>Education</h3>
        <label>School / University</label>
        <input type="text" id="school" name="school" placeholder="University of XYZ" title="Cannot contain only numbers"
            maxlength="100" />

        <label>Degree</label>
        <input type="text" id="degree" name="degree" placeholder="Bachelor of Science in Computer Science"
            title="Cannot contain only numbers" maxlength="100" />

        <label>Year</label>
        <input type="text" id="eduYear" name="eduYear" placeholder="2020-2024" maxlength="9" />
        <div id="eduError" style="color:red; margin-top:5px;"></div>

        <h3>Work Experience</h3>
        <div id="experienceContainer">
            <div class="experience-entry">
                <label>Company</label>
                <input type="text" id="company" name="company" placeholder="ABC Corp"
                    title="Cannot contain only numbers" maxlength="100" />

                <label>Position</label>
                <input type="text" id="position" name="position" placeholder="Software Intern"
                    title="Cannot contain only numbers" maxlength="50" />

                <label>Duration</label>
                <input type="text" id="duration" name="duration" placeholder="2 years, 6 months" maxlength="30" />

                <label>Responsibilities / Achievements</label>
                <textarea id="achievements" name="achievements" placeholder="Describe your contributions..."
                    maxlength="300" rows="3"></textarea>
            </div>
        </div>

        <!-- Add new experience button -->
        <button type="button" id="addExperienceBtn" style="margin-top:10px;">+ Add Another Experience</button>

        <h3>Projects</h3>
        <div id="projectContainer">
            <div class="project-entry">
                <label>Project Title</label>
                <input type="text" name="projectTitle" placeholder="Hospital Appointment System"
                    title="Cannot contain only numbers" maxlength="50" />

                <label>Tech Stack</label>
                <input type="text" name="projectTech" placeholder="C#, ASP.NET, SQL, Azure"
                    title="Cannot contain only numbers" maxlength="100" />

                <label>Description / Achievements</label>
                <textarea name="projectDesc" placeholder="Built a full-stack appointment booking system..."
                    maxlength="300" rows="3"></textarea>
            </div>
        </div>

        <button type="button" id="addProjectBtn" style="margin-top:10px;">+ Add Another Project</button>

        <input type="hidden" id="projects" name="projects" />




        <h3>Skills & Certifications</h3>
        <input type="text" id="skills" name="skills" placeholder="C#, ASP.NET, SQL" title="Cannot contain only numbers"
            maxlength="50" />
        <input type="text" id="certifications" name="certifications"
            placeholder="Microsoft Certified: Azure Fundamentals" title="Cannot contain only numbers" maxlength="100" />

        <button type="submit" id="downloadServerPDF" style="margin-left:10px;">Generate PDF</button>

        <input type="hidden" id="education" name="education" />
        <input type="hidden" id="experience" name="experience" />
    </form>
</div>

<script>
    // ðŸ–¼ï¸ Profile image upload + validation + preview
    document.getElementById("profilePic").addEventListener("change", function (e) {
        const file = e.target.files[0];
        const img = document.getElementById("previewImg");

        if (!file) {
            // No file selected -> hide preview
            img.src = "#";
            img.style.display = "none";
            return;
        }

        // ---- Validate file type (must be an image) ----
        const allowedTypes = ["image/jpeg", "image/png", "image/jpg", "image/webp"];
        if (!allowedTypes.includes(file.type)) {
            Swal.fire({
                icon: "error",
                title: "Invalid File",
                text: "Please upload an image file (JPG, PNG, WebP)."
            });
            this.value = "";
            return;
        }

        // ---- Validate size (2MB max) ----
        if (file.size > 2 * 1024 * 1024) {
            Swal.fire({
                icon: "error",
                title: "File Too Large",
                text: "Maximum file size is 2MB."
            });
            this.value = "";
            return;
        }

        // ---- Show preview ----
        const reader = new FileReader();
        reader.onload = function (event) {
            const img = document.getElementById("previewImg");
            img.src = event.target.result;
            img.style.display = "block";
        };

        reader.readAsDataURL(file);
    });

    // âž• Add new experience entry
    document.getElementById("addExperienceBtn").addEventListener("click", function () {
        const container = document.getElementById("experienceContainer");

        const newEntry = document.createElement("div");
        newEntry.classList.add("experience-entry");
        newEntry.style.marginTop = "15px";
        newEntry.innerHTML = `
        <hr style="margin:10px 0;">
        <button type="button" class="removeExperienceBtn" style="margin-bottom:10px;">Remove</button>

        <label>Company</label>
        <input type="text" name="company" placeholder="ABC Corp" maxlength="100"  title="Cannot contain only numbers" />

        <label>Position</label>
        <input type="text" name="position" placeholder="Software Intern" maxlength="50"  title="Cannot contain only numbers" />

        <label>Duration</label>
        <input type="text" name="duration" placeholder="2 years, 6 months" maxlength="30" />

        <label>Responsibilities / Achievements</label>
        <textarea name="achievements" placeholder="Describe your contributions..." maxlength="300" rows="3"></textarea>
    `;
        container.appendChild(newEntry);

        // âœ… Attach remove event properly
        newEntry.querySelector(".removeExperienceBtn").addEventListener("click", function () {
            container.removeChild(newEntry);
        });
    });
    document.getElementById("addProjectBtn").addEventListener("click", function () {
        const container = document.getElementById("projectContainer");

        const newEntry = document.createElement("div");
        newEntry.classList.add("project-entry");
        newEntry.style.marginTop = "15px";

        newEntry.innerHTML = `
        <hr style="margin:10px 0;">
        <button type="button" class="removeProjectBtn" style="margin-bottom:10px;">Remove</button>

        <label>Project Title</label>
        <input type="text" name="projectTitle" placeholder="Hospital Appointment System" maxlength="50"  title="Cannot contain only numbers" />

        <label>Tech Stack</label>
        <input type="text" name="projectTech" placeholder="C#, ASP.NET, SQL, Azure" maxlength="100" title="Cannot contain only numbers" />

        <label>Description / Achievements</label>
        <textarea name="projectDesc" placeholder="Built a full-stack appointment booking system..." maxlength="300" rows="3"></textarea>
    `;

        container.appendChild(newEntry);

        newEntry.querySelector(".removeProjectBtn").addEventListener("click", function () {
            container.removeChild(newEntry);
        });
    });



    // ðŸ§© Combine for submission (for PDF generation)
    document.getElementById("resumeForm").addEventListener("submit", function (e) {
        const school = document.getElementById("school").value.trim();
        const degree = document.getElementById("degree").value.trim();
        const eduYear = document.getElementById("eduYear").value.trim();
        const errorDiv = document.getElementById("eduError");
        errorDiv.textContent = "";

        if (eduYear) {
            const match = eduYear.match(/^(\d{4})(-(\d{4}))?$/);
            if (match) {
                const startYear = parseInt(match[1]);
                if (startYear > new Date().getFullYear()) {
                    errorDiv.textContent = `Start year cannot be later than ${new Date().getFullYear()}.`;
                    e.preventDefault(); // stop form submission
                    errorDiv.scrollIntoView({ behavior: "smooth", block: "center" });
                    return;
                }
                if (match[3]) {
                    const endYear = parseInt(match[3]);
                    if (endYear > new Date().getFullYear()) {
                        errorDiv.textContent = `End year cannot be later than ${new Date().getFullYear()}.`;
                        e.preventDefault();
                        errorDiv.scrollIntoView({ behavior: "smooth", block: "center" });
                        return;
                    }
                }
            } else {
                errorDiv.textContent = "Invalid format. Use YYYY or YYYY-YYYY.";
                e.preventDefault();
                errorDiv.scrollIntoView({ behavior: "smooth", block: "center" });
                return;
            }
        }

        // ðŸŽ“ Education
        if (degree || school || eduYear) {
            document.getElementById("education").value = `${degree} at ${school} (${eduYear})`;
        } else {
            document.getElementById("education").value = "";
        }

        // ðŸ’¼ Collect all experiences
        const experiences = [];
        document.querySelectorAll(".experience-entry").forEach(entry => {
            const company = entry.querySelector('[name="company"]').value.trim();
            const position = entry.querySelector('[name="position"]').value.trim();
            const duration = entry.querySelector('[name="duration"]').value.trim();
            const achievements = entry.querySelector('[name="achievements"]').value.trim();

            if (company || position || duration || achievements) {
                let durationText = duration;
                if (/less than|<\s*1\s*year/i.test(duration)) {
                    durationText = "<1 year";
                } else if (/^\d+\s*(months?|mo)$/i.test(duration)) {
                    durationText = "Less than 1 year";
                }
                experiences.push(`${position} at ${company} (${durationText}) â€” ${achievements}`);
            }
        });

        // Combine all experiences into one hidden field
        document.getElementById("experience").value = experiences.join("\n");

        const projects = [];
        document.querySelectorAll(".project-entry").forEach(entry => {
            const title = entry.querySelector('[name="projectTitle"]').value.trim();
            const tech = entry.querySelector('[name="projectTech"]').value.trim();
            const desc = entry.querySelector('[name="projectDesc"]').value.trim();

            if (title || tech || desc) {
                projects.push(`${title} â€” ${tech}\n${desc}`);
            }
        });

        document.getElementById("projects").value = projects.join("\n\n");
        const fileInput = document.getElementById("profilePic");
        const img = document.getElementById("previewImg");
        const removeBtn = document.getElementById("removeProfilePicBtn");

        fileInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) {
                // No file selected, hide preview & button
                img.style.display = "none";
                removeBtn.style.display = "none";
                return;
            }

            // Validate type and size (keep your existing code here)
            const allowedTypes = ["image/jpeg", "image/png", "image/jpg", "image/webp"];
            if (!allowedTypes.includes(file.type) || file.size > 2 * 1024 * 1024) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid file",
                    text: "File must be JPG, PNG, or WebP and â‰¤ 2MB"
                });
                fileInput.value = "";
                img.style.display = "none";
                removeBtn.style.display = "none";
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function (event) {
                img.src = event.target.result;
                img.style.display = "block";
                removeBtn.style.display = "block"; // show X button
            };
            reader.readAsDataURL(file);
        });

        removeBtn.addEventListener("click", function () {
            fileInput.value = ""; // clear selection
            img.src = "#";
            img.style.display = "none";
            removeBtn.style.display = "none";
        });

    });
</script>