@model JobPortal.Areas.JobSeeker.Models.ProfileViewModel
@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = "My Profile";
}

<link rel="stylesheet" href="~/css/dashboard.css" />

<section class="profile-section">
    <h1 class="page-title">Personal Information</h1>

    <form asp-action="Settings" asp-controller="Dashboard" method="post" enctype="multipart/form-data"
        class="profile-form">
        <input type="hidden" asp-for="UserId" />
        @Html.AntiForgeryToken()
        <!-- Name -->
        <div class="form-group-row">
            <div class="form-group">
                <label>First Name</label>
                <input asp-for="FirstName" type="text" class="form-control" placeholder="Enter first name"
                    maxlength="30" />
                <span asp-validation-for="FirstName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input asp-for="LastName" type="text" class="form-control" placeholder="Enter last name"
                    maxlength="30" />
                <span asp-validation-for="LastName" class="text-danger"></span>
            </div>
        </div>

        <!-- Email + 2FA -->
        <div class="form-group-row">
            <div class="form-group">
                <label>Email</label>
                <input asp-for="Email" type="email" class="form-control" placeholder="example@email.com" readonly />
            </div>

            <div class="form-group switch-group">
                <label>Two-Factor Authentication</label>
                <label class="switch">
                    <input asp-for="TwoFAEnabled" type="checkbox" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Password -->
        <div class="form-group-row">
            <div class="form-group">
                <label>Password</label>
                <input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20" readonly />
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button type="button" class="change-btn">Change Password</button>
            </div>
        </div>
        <div class="form-group mb-3 text-center">
            <label for="ProfileImage" class="form-label fw-bold">Profile Picture</label><br />
            <img src="@(string.IsNullOrEmpty(Model.ProfilePicturePath) 
                                                                                                                                                     ? Url.Content("~/images/profile.png") 
                                                                                                                                                     : Url.Content($"{Model.ProfilePicturePath}?v={Guid.NewGuid()}"))"
                alt="Profile Picture" id="profilePreview"
                style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:10px;border:2px solid #ccc;" />
            <!-- Hidden File Input -->
            <input asp-for="ProfileImage" type="file" class="form-control d-none" id="ProfileImage" accept="image/*" />

            <!-- Upload Button -->
            <button type="button" class="btn btn-secondary mt-2" id="uploadBtn">
                <i class="bi bi-upload"></i> Upload New Picture
            </button>
        </div>


        <!-- Contact Info -->
        <div class="form-group-row">
            <div class="form-group small-field">
                <label>Phone Number</label>
                <input asp-for="Phone" type="text" class="form-control" placeholder="+60 123-456789" maxlength="20" />
                <span asp-validation-for="Phone" class="text-danger"></span>
            </div>
        </div>

        <div class="form-group">
            <label>Address</label>
            <textarea asp-for="Address" class="form-control" rows="4" placeholder="Enter your address"></textarea>
        </div>

        <div class="d-flex justify-content-center mt-3">
            <a asp-area="JobSeeker" asp-controller="Dashboard" asp-action="ManageResume"
                class="btn btn-outline-primary">
                Manage My Resumes
            </a>
        </div>

        <!-- Experience & Education -->
        <div class="form-group">
            <label>Work Experience</label>
            <textarea asp-for="WorkExperience" class="form-control" rows="3" maxlength="200"
                placeholder="Describe your work experience..."></textarea>
        </div>

        <div class="form-group mt-3">
            <label>Preferred Industry</label>
            <select asp-for="TargetIndustry" class="form-control">
                <option value="">-- Select Industry --</option>
                <option>Information Technology</option>
                <option>Finance & Banking</option>
                <option>Healthcare</option>
                <option>Retail & E-Commerce</option>
                <option>Manufacturing</option>
                <option>Food & Beverage</option>
                <option>Education</option>
                <option>Logistics & Transportation</option>
                <option>Construction & Engineering</option>
                <option>Hospitality & Tourism</option>
                <option>Staffing</option>
            </select>
        </div>


        <div class="form-group">
            <label>Education</label>
            <textarea asp-for="Education" class="form-control" rows="3" maxlength="50"
                placeholder="List your education background..."></textarea>
        </div>

        <div class="form-group">
            <label>Skills</label>
            <textarea asp-for="Skills" class="form-control" rows="2" maxlength="50"
                placeholder="e.g., C#, SQL, ASP.NET, UI Design"></textarea>
        </div>

        <!-- Notification Preferences -->
        <h2 class="section-title">Notification Preferences</h2>
        <div class="notification-options">
            <label>
                <input asp-for="notif_inapp" type="checkbox" /> In-App
            </label>
        </div>

        <!-- Notification Types -->
        <h2 class="section-title">Notification Types</h2>
        <div class="toggle-list">
            <div><span>Job Application Updates</span>
                <label class="switch">
                    <input asp-for="notif_job_updates" type="checkbox" />
                    <span class="slider"></span>
                </label>
            </div>

            <div><span>Messages from Recruiters</span>
                <label class="switch">
                    <input asp-for="notif_messages" type="checkbox" />
                    <span class="slider"></span>
                </label>
            </div>

            <div><span>Saved Job Reminders</span>
                <label class="switch">
                    <input asp-for="notif_reminders" type="checkbox" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Save Button -->
        <div class="form-actions">
            <button type="submit" class="save-btn">Save Changes</button>
        </div>
        <!-- Danger Zone -->
        <hr class="mt-5">
        <div class="form-actions danger-zone">
            <button type="button" class="delete-btn">Delete Account</button>
        </div>

    </form>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // ðŸ”¹ Handle Change Password popup
            document.querySelector(".change-btn")?.addEventListener("click", function () {
                Swal.fire({
                    title: "Change Password",
                    html: `
                                                                                                            <input type="password" id="currentPassword" class="swal2-input" placeholder="Current Password">
                                                                                                            <input type="password" id="newPassword" class="swal2-input" placeholder="New Password">
                                                                                                            <input type="password" id="confirmPassword" class="swal2-input" placeholder="Confirm New Password">
                                                                                                        `,
                    confirmButtonText: "Update Password",
                    focusConfirm: false,
                    preConfirm: () => {
                        const currentPassword = document.getElementById("currentPassword").value;
                        const newPassword = document.getElementById("newPassword").value;
                        const confirmPassword = document.getElementById("confirmPassword").value;

                        if (!currentPassword || !newPassword || !confirmPassword) {
                            Swal.showValidationMessage("Please fill in all fields.");
                            return false;
                        }

                        // Send AJAX request
                        return fetch("/JobSeeker/Dashboard/ChangePassword", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: new URLSearchParams({ currentPassword, newPassword, confirmPassword })
                        })
                            .then(async response => {
                                const text = await response.text();
                                if (!response.ok) {
                                    Swal.showValidationMessage(text); // Show the actual error
                                    return false;
                                }
                                return text;
                            })
                            .catch(() => {
                                Swal.showValidationMessage("Error connecting to server.");
                            });
                    }

                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            icon: "success",
                            title: "Password Updated!",
                            text: "Your password has been changed successfully.",
                            confirmButtonColor: "#28a745"
                        });
                    }
                });
            });

            // ðŸ”¹ Display TempData messages (save changes, delete, etc.)
            const message = '@TempData["Message"]';
            if (message && message.length > 0) {
                Swal.fire({
                    icon: message.includes("deleted") ? "warning" :
                        message.includes("successfully") ? "success" : "info",
                    title: "Notification",
                    text: message,
                    confirmButtonColor: "#007bff"
                });
            }
        });
        // ðŸ”¹ Handle Two-Factor Authentication toggle
        const twoFASwitch = document.querySelector("input[name='TwoFAEnabled']");

        if (twoFASwitch) {
            const is2FAEnabled = '@Model.TwoFAEnabled.ToString().ToLower()';
            twoFASwitch.checked = (is2FAEnabled === "true");

            twoFASwitch.addEventListener("change", function () {
                const enabled = this.checked;

                if (enabled) {
                    // ðŸ”¸ Step 1: Generate QR & secret
                    fetch("/JobSeeker/Dashboard/Generate2FA", { method: "POST" })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    title: "Enable Two-Factor Authentication",
                                    html: `
                                                                                            <p>Scan this QR code with <b>Google Authenticator</b>:</p>
                                                                                            <img src="${data.qrImage}" style="width:200px; margin:10px;">
                                                                                            <p>Secret Key: <b>${data.secret}</b></p>
                                                                                            <input type="text" id="verifyCode" class="swal2-input" placeholder="Enter 6-digit code">
                                                                                        `,
                                    confirmButtonText: "Verify Code",
                                    showCancelButton: true,
                                    cancelButtonText: "Cancel",
                                    focusConfirm: false,
                                    preConfirm: () => {
                                        const code = document.getElementById("verifyCode").value;
                                        if (!code) {
                                            Swal.showValidationMessage("Please enter the 6-digit code.");
                                            return false;
                                        }
                                        return fetch("/JobSeeker/Dashboard/Verify2FA", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                            body: new URLSearchParams({ code })
                                        })
                                            .then(res => res.json())
                                            .then(result => {
                                                if (!result.success) {
                                                    Swal.showValidationMessage("Invalid code, please try again.");
                                                    return false;
                                                }
                                                return true;
                                            });
                                    }
                                }).then(result => {
                                    if (result.isConfirmed) {
                                        // ðŸ”¸ Step 2: Mark 2FA as enabled in DB only after verification
                                        fetch("/JobSeeker/Dashboard/Toggle2FA", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                            body: new URLSearchParams({ enabled: true })
                                        });

                                        Swal.fire({
                                            icon: "success",
                                            title: "2FA Enabled!",
                                            text: "Two-Factor Authentication is now active.",
                                            confirmButtonColor: "#28a745"
                                        });
                                    } else {
                                        // âŒ User cancelled or closed popup -> revert toggle
                                        twoFASwitch.checked = false;
                                        fetch("/JobSeeker/Dashboard/Toggle2FA", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                            body: new URLSearchParams({ enabled: false })
                                        });
                                    }
                                });
                            }
                        })
                        .catch(() => {
                            Swal.fire("Error", "Unable to generate QR code.", "error");
                            twoFASwitch.checked = false;
                        });
                } else {
                    // ðŸ”¹ Disable 2FA
                    fetch("/JobSeeker/Dashboard/Toggle2FA", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ enabled: false })
                    });
                    Swal.fire({
                        icon: "info",
                        title: "2FA Disabled",
                        text: "Two-Factor Authentication has been turned off.",
                        confirmButtonColor: "#007bff"
                    });
                }
            });
        }

        // ðŸ”¹ Handle Delete Account button
        document.querySelector(".delete-btn")?.addEventListener("click", function () {
            Swal.fire({
                title: "Are you sure?",
                text: "This action will permanently delete your account and all related data. This cannot be undone.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete it!",
                cancelButtonText: "Cancel",
                confirmButtonColor: "#dc3545",
                cancelButtonColor: "#6c757d"
            }).then((result) => {
                if (result.isConfirmed) {
                    // âœ… Send POST request to backend
                    fetch("/JobSeeker/Dashboard/DeleteAccount", {
                        method: "POST"
                    })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire({
                                    icon: "success",
                                    title: "Account Deleted",
                                    text: "Your account has been permanently removed.",
                                    confirmButtonColor: "#28a745"
                                }).then(() => {
                                    // âœ… Redirect to login after confirmation
                                    window.location.href = "/JobSeeker/Account/Login";
                                });
                            } else {
                                Swal.fire("Error", "Failed to delete account.", "error");
                            }
                        })
                        .catch(() => Swal.fire("Error", "Server connection failed.", "error"));
                }
            });
        });
        // When button clicked, open the file dialog
        document.getElementById("uploadBtn").addEventListener("click", function () {
            document.getElementById("ProfileImage").click();
        });

        // When file selected, show preview
        document.getElementById("ProfileImage").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById("profilePreview").src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
}