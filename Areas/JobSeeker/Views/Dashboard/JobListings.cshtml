@model IEnumerable<JobPortal.Areas.Shared.Models.job_listing>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@using Microsoft.AspNetCore.Http



@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = "Job Listings";
}

<link rel="stylesheet" href="~/css/dashboard.css" />
<link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" rel="stylesheet">

<section class="job-listings-section">
    <div class="header-bar">
        <h1 class="page-title">Available Job Listings</h1>
        <form method="get" class="d-inline">
            <input type="hidden" name="favouritesOnly" value="@(ViewBag.FavouritesOnly ? "false" : "true")" />
            <button type="submit" class="favourite-btn">
                @(ViewBag.FavouritesOnly ? "‚≠ê All Jobs" : "‚≠ê Favourites")
            </button>
        </form>

    </div>

    <!-- üîç Filter Bar -->
    <form asp-action="JobListings" method="get" class="job-filter-bar d-flex flex-wrap gap-2 align-items-center">
        <!-- Keyword Search -->
        <input type="text" name="search" class="form-control w-auto" placeholder="Search jobs or companies..."
            maxlength="60" value="@ViewBag.Search" />

        <!-- üìç Location Filter -->
        <select name="location" class="form-select w-auto">
            <option value="">All Locations</option>
            @foreach (var loc in ViewBag.Locations as List<string>)
            {
                <option value="@loc" selected="@(ViewBag.Location == loc ? "selected" : null)">@loc</option>

            }
        </select>

        <!-- üí∞ Salary Range -->
        <div class="mb-3">
            <label class="form-label fw-bold">Salary Range</label>

            <!-- noUiSlider -->
            <div id="salarySlider" style="margin: 20px 0;"></div>

            <!-- Linked Inputs -->
            <div class="d-flex align-items-center justify-content-center mt-2 gap-2">
                <input type="number" id="minSalary" name="minSalary" min="0" max="20000" step="500"
                    value="@ViewBag.MinSalary" class="form-control w-auto text-center" style="width:100px;">
                <span class="mx-2 fw-semibold">-</span>
                <input type="number" id="maxSalary" name="maxSalary" min="0" max="20000" step="500"
                    value="@ViewBag.MaxSalary" class="form-control w-auto text-center" style="width:100px;">
            </div>
        </div>



        <!-- üéì Internship Type (placeholder) -->
        <select name="jobCategory" class="form-select w-auto">
            <option value="">All Categories</option>
            <option value="Full Time" selected="@(ViewBag.JobCategory == "Full Time" ? "selected" : null)">Full Time
            </option>
            <option value="Part Time" selected="@(ViewBag.JobCategory == "Part Time" ? "selected" : null)">Part Time
            </option>
            <option value="Contract" selected="@(ViewBag.JobCategory == "Contract" ? "selected" : null)">Contract
            </option>
            <option value="Freelance" selected="@(ViewBag.JobCategory == "Freelance" ? "selected" : null)">Freelance
            </option>
            <option value="Internship" selected="@(ViewBag.JobCategory == "Internship" ? "selected" : null)">Internship
            </option>
        </select>

        <!-- üè† Work Mode (placeholder) -->
        <select name="workMode" class="form-select w-auto">
            <option value="">All Work Modes</option>
            <option value="On-site" selected="@(ViewBag.WorkMode == "On-site" ? "selected" : null)">On-site</option>
            <option value="WFH" selected="@(ViewBag.WorkMode == "WFH" ? "selected" : null)">WFH</option>
            <option value="Hybrid" selected="@(ViewBag.WorkMode == "Hybrid" ? "selected" : null)">Hybrid</option>
        </select>

        <button type="submit" class="btn btn-primary">Filter</button>
    </form>


    <!-- üß© Dynamic Job Listings -->
    <div class="job-listings-container">
        @if (!Model.Any())
        {
            <p>No job listings available.</p>
        }
        else
        {
            @foreach (var job in Model)
            {
                <div class="job-item d-flex align-items-center p-3 mb-3 shadow-sm rounded">
                    <!-- üè¢ Company Logo -->
                    <div class="job-logo">
                        <img src="~/images/default-company.png" alt="Company Logo" class="company-logo" />
                    </div>

                    <!-- üìÑ Job Info -->
                    <div class="job-info flex-grow-1">
                        <h3 class="fw-bold mb-1">@job.job_title</h3>
                        <p class="company mb-1">
                            @job.company.company_name
                            <span class="industry text-muted">¬∑ @job.job_category</span>
                        </p>
                        <p class="details text-muted mb-2">
                            @job.company.company_location ¬∑ @job.date_posted.ToString("MMM dd, yyyy") ¬∑ @job.job_status
                        </p>

                        <div class="tags mb-2">
                            <span class="tag tag-blue">@job.job_type</span>
                            <span class="tag tag-orange">@job.work_mode</span>
                            <span class="tag tag-green">RM @(job.salary_min?.ToString("N0") ?? "0") - RM
                                @(job.salary_max?.ToString("N0") ?? "0")</span>
                            @if (ViewBag.AppliedJobs.Contains(job.job_listing_id))
                            {
                                <span class="badge bg-secondary">Already Applied</span>
                            }
                        </div>

                        <p class="description text-muted">@job.job_description</p>
                    </div>

                    <!-- üîò View & Favourite Button -->
                    <div class="text-end ms-3 d-flex gap-1 align-items-center">
                        <button type="button" class="btn btn-sm p-1 favourite-toggle" data-job-id="@job.job_listing_id"
                            style="font-size:1.2rem;">
                            @(ViewBag.FavouriteJobs.Contains(job.job_listing_id) ? "‚≠ê" : "‚òÜ")
                        </button>

                        <a asp-controller="Dashboard" asp-action="JobDetails" asp-route-id="@job.job_listing_id"
                            class="apply-btn btn btn-primary btn-sm">View Details</a>
                    </div>


                </div>
            }


        }
    </div>

    <!-- üìÑ Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <div class="pagination">
            <button disabled="@((ViewBag.CurrentPage == 1))"
                onclick="location.href='@Url.Action("JobListings", new { page = ViewBag.CurrentPage - 1, search = ViewBag.Search })'">
                ‚¨Ö Previous
            </button>

            <span>Page @ViewBag.CurrentPage of @ViewBag.TotalPages</span>

            <button disabled="@((ViewBag.CurrentPage == ViewBag.TotalPages))"
                onclick="location.href='@Url.Action("JobListings", new { page = ViewBag.CurrentPage + 1, search = ViewBag.Search })'">
                Next ‚û°
            </button>
        </div>
    }

    else
    {
        <div class="pagination">
            <span>Showing all @Model.Count() jobs</span>
        </div>
    }

</section>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    <script>
        const slider = document.getElementById('salarySlider');
        const minInput = document.getElementById('minSalary');
        const maxInput = document.getElementById('maxSalary');

        const initialMin = parseInt(minInput.value) || 0;
        const initialMax = parseInt(maxInput.value) || 5000;

        noUiSlider.create(slider, {
            start: [initialMin, initialMax],
            connect: true,
            step: 500,
            range: {
                'min': 0,
                'max': 10000
            },
            tooltips: false
        });

        // Update inputs when slider changes
        slider.noUiSlider.on('update', function (values, handle) {
            const value = Math.round(values[handle]);
            if (handle === 0) minInput.value = value;
            else maxInput.value = value;
        });

        // Update slider when inputs change
        function updateSliderFromInputs() {
            const min = parseInt(minInput.value) || 0;
            const max = parseInt(maxInput.value) || 0;
            if (min <= max) slider.noUiSlider.set([min, max]);
        }

        minInput.addEventListener('change', updateSliderFromInputs);
        maxInput.addEventListener('change', updateSliderFromInputs);
        document.querySelectorAll('.favourite-toggle').forEach(btn => {
            btn.addEventListener('click', async function () {
                const jobId = this.dataset.jobId;

                const response = await fetch('@Url.Action("ToggleFavourite", "Dashboard")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': '@Antiforgery.GetAndStoreTokens(ViewContext.HttpContext).RequestToken'
                    },
                    body: JSON.stringify({ jobId })
                });

                const result = await response.json();

                if (result.success) {
                    this.textContent = result.isFavourite ? '‚≠ê' : '‚òÜ';
                }
            });
        });
        document.querySelector("form").addEventListener("submit", function (e) {
            const minInput = document.getElementById("minSalary").value.trim();
            const maxInput = document.getElementById("maxSalary").value.trim();

            const min = parseInt(minInput, 10);
            const max = parseInt(maxInput, 10);

            if (isNaN(min) || isNaN(max)) {
                e.preventDefault();
                document.getElementById("salaryError").textContent = "Please enter valid numbers for salary.";
                document.getElementById("salaryError").style.display = "block";
                return false;
            }

            if (min > max) {
                e.preventDefault();
                document.getElementById("salaryError").textContent = "Minimum salary cannot be higher than maximum.";
                document.getElementById("salaryError").style.display = "block";
                return false;
            }

            if ((min + max) > 20000) {
                e.preventDefault();
                document.getElementById("salaryError").textContent = "Combined salary range cannot exceed 20,000.";
                document.getElementById("salaryError").style.display = "block";
                return false;
            }

            document.getElementById("salaryError").style.display = "none"; // hide error if valid
        });





    </script>
}