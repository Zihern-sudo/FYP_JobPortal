@model IEnumerable<JobPortal.Areas.Shared.Models.notification>

@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = "Notifications Center";
}

<h2 class="mb-4">Notification Center</h2>

<form id="markReadForm">
    @Html.AntiForgeryToken()
    <div class="d-flex justify-content-between mb-3">
        <div>
            <button type="button" id="markSelectedBtn" class="btn btn-success btn-sm" disabled>
                Mark Selected as Read
            </button>
        </div>
    </div>

    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" />
                </th>
                <th>Title</th>
                <th>Message</th>
                <th>Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var n in Model)
            {
                <tr class="@(n.notification_read_status ? "table-light" : "table-warning")">
                    <td>
                        <input type="checkbox" name="selectedNotifications" value="@n.notification_id"
                            class="notif-checkbox" @(n.notification_read_status ? "disabled" : "") />
                    </td>
                    <td>@n.notification_title</td>
                    <td>@n.notification_msg</td>
                    <td>@n.notification_date_created.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@(n.notification_read_status ? "Read" : "Unread")</td>
                </tr>
            }
        </tbody>
    </table>
    @{
        int totalPages = (int)Math.Ceiling((double)ViewBag.TotalNotifications / ViewBag.PageSize);
        int currentPage = ViewBag.CurrentPage;
    }

    @if (totalPages > 1)
    {
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Notifications", new { page = currentPage - 1 })">Previous</a>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Notifications", new { page = i })">@i</a>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Notifications", new { page = currentPage + 1 })">Next</a>
                </li>
            </ul>
        </nav>
    }

</form>

@section Scripts {
    <script>
        const markBtn = document.getElementById("markSelectedBtn");
        const selectAll = document.getElementById("selectAll");

        function updateButtonState() {
            const checkboxes = document.querySelectorAll(".notif-checkbox:not([disabled])");
            markBtn.disabled = ![...checkboxes].some(cb => cb.checked);
        }

        // Handle individual checkbox change via delegation
        document.addEventListener("change", function (e) {
            if (e.target.classList.contains("notif-checkbox")) {
                updateButtonState();

                const checkboxes = document.querySelectorAll(".notif-checkbox:not([disabled])");
                selectAll.checked = [...checkboxes].every(cb => cb.checked);
            }
        });

        // Select all toggle
        selectAll.addEventListener("change", function (e) {
            const checkboxes = document.querySelectorAll(".notif-checkbox:not([disabled])");
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateButtonState();
        });

        // Mark Selected click
        markBtn.addEventListener("click", function () {
            const checkboxes = document.querySelectorAll(".notif-checkbox:not([disabled])");
            const selectedIds = [...checkboxes].filter(cb => cb.checked).map(cb => cb.value);
            if (!selectedIds.length) return;

            fetch('@Url.Action("MarkSelectedAsRead", "Dashboard")', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify(selectedIds)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert("Something went wrong.");
            })
            .catch(console.error);
        });

        // Initial button state
        updateButtonState();
    </script>
}
