<!-- File: Areas/Recruiter/Views/Company/Setup.cshtml -->
@model JobPortal.Areas.Recruiter.Models.CompanyProfileVm
@{
    Layout = null; /* no topbar/sidebar */
}

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Company Setup • JobPortal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            min-height: 100vh;
            background: #f6f7fb;
            display: grid;
            place-items: center;
            padding: 24px 12px;
        }

        .card-auth {
            width: 100%;
            max-width: 980px;
            border-radius: 16px;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
        }

        @@media (max-width: 768px) {
            .setup-grid {
                grid-template-columns: 1fr;
            }
        }

        .logo-upload {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            border: 2px dashed #cfd6e4;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #fff;
            transition: border-color .15s;
        }

        .logo-upload.dragover {
            border-color: #0d6efd;
        }

        .logo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #companyPhoto {
            display: block;
        }

        .logo-actions .btn {
            height: 42px;
        }
    </style>
</head>

<body>
    <div class="card card-auth shadow-sm">
        <div class="card-body p-4 p-md-5">
            <h1 class="h4 mb-3">Company Profile</h1>
            <p class="text-muted">Complete your company details. Submit for admin approval.</p>

            @if (ViewBag.CompanyStatus is string s && !string.IsNullOrWhiteSpace(s))
            {
                <div class="alert alert-info py-2 mb-4">Status: <strong>@s</strong></div>
            }

            <form asp-area="Recruiter" asp-controller="Company" asp-action="Manage" method="post"
                enctype="multipart/form-data" novalidate>
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <!-- Identify source so Submit redirects to JobSeeker/Account/StaffLogin -->
                <input type="hidden" name="source" value="setup" />

                <div class="setup-grid">
                    <!-- Left: Logo -->
                    <div>
                        <div class="logo-upload mb-2" id="logoPreviewBox">
                            @if (ViewBag.CompanyPhotoUrl is string url && !string.IsNullOrWhiteSpace(url))
                            {
                                <img id="logoPreview" src="@url" alt="Company Logo" />
                            }
                            else
                            {
                                <span class="text-muted">Company Photo</span>
                            }
                        </div>
                        <div class="logo-actions d-flex gap-2 align-items-center">
                            <div class="flex-grow-1">
                                <label for="companyPhoto" class="form-label fw-semibold">Upload Photo</label>
                                <input id="companyPhoto" name="companyPhoto" type="file" accept=".jpg,.jpeg,.png,.webp"
                                    class="form-control" />
                                <div class="form-text">Max 2 MB; jpg, jpeg, png, webp.</div>
                                <span class="text-danger" id="companyPhotoError"></span>
                                @* NEW: surface server-side photo errors from ModelState ("companyPhoto") *@
                                <span class="text-danger">@Html.ValidationMessage("companyPhoto")</span>
                                <button type="button" id="btnCancelPhoto"
                                    class="btn btn-outline-secondary mt-4">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Fields -->
                    <div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="company_name" class="form-label"></label>
                                <input asp-for="company_name" class="form-control" maxlength="160" />
                                <span asp-validation-for="company_name" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="company_industry" class="form-label"></label>
                                <input asp-for="company_industry" class="form-control" maxlength="120" />
                                <span asp-validation-for="company_industry" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="company_location" class="form-label"></label>
                                <input asp-for="company_location" class="form-control" maxlength="120" />
                                <span asp-validation-for="company_location" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="company_description" class="form-label"></label>
                                <textarea asp-for="company_description" rows="6" class="form-control"></textarea>
                                <span asp-validation-for="company_description" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-3 mt-4">
                    <!-- Submit goes to Submit action -->
                    <button type="submit" formaction="@(Url.Action("Submit", "Company", new { area = "Recruiter" }))"
                        class="btn btn-success px-4">
                        Submit for Approval
                    </button>
                </div>
            </form>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script>
        // DnD + preview + validation (≤2MB; jpg/jpeg/png/webp) + ensure dropped file is bound to <input type="file">
        (function () {
            const input = document.getElementById('companyPhoto');
            const box = document.getElementById('logoPreviewBox');
            const err = document.getElementById('companyPhotoError');
            const MAX = 2 * 1024 * 1024;
            const OK_EXT = ['jpg', 'jpeg', 'png', 'webp'];
            const OK_MIME = ['image/jpeg', 'image/png', 'image/webp'];

            function setFileInputFromDrop(file) {
                // Why: make the dropped file submit with the form (not just preview).
                try {
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    input.files = dt.files;
                    // Trigger a change event so UI updates "No file chosen"
                    const ev = new Event('change', { bubbles: true });
                    input.dispatchEvent(ev);
                } catch { /* older browsers: input label might not reflect, but form will still post */ }
            }

            box.addEventListener('click', () => input.click());

            ['dragenter', 'dragover'].forEach(ev => {
                box.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); box.classList.add('dragover'); });
            });
            ['dragleave', 'dragend', 'drop'].forEach(ev => {
                box.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); box.classList.remove('dragover'); });
            });

            box.addEventListener('drop', (e) => {
                const f = e.dataTransfer.files && e.dataTransfer.files[0];
                if (f) {
                    if (handleFile(f)) setFileInputFromDrop(f);
                }
            });

            input?.addEventListener('change', () => {
                const f = input.files?.[0];
                if (f) handleFile(f);
            });

            function handleFile(f) {
                err.textContent = '';
                const ext = (f.name.split('.').pop() || '').toLowerCase();
                if (!OK_EXT.includes(ext) || !OK_MIME.includes(f.type)) {
                    err.textContent = 'Only JPG, JPEG, PNG, or WEBP are allowed.';
                    input.value = '';
                    return false;
                }
                if (f.size > MAX) {
                    err.textContent = 'Image must be ≤ 2 MB.';
                    input.value = '';
                    return false;
                }

                const img = document.getElementById('logoPreview') || Object.assign(document.createElement('img'), { id: 'logoPreview' });
                img.onload = () => URL.revokeObjectURL(img.src);
                img.src = URL.createObjectURL(f);
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                box.innerHTML = '';
                box.appendChild(img);
                return true;
            }
        })();

        // Cancel: clear current selection/preview
        (function () {
            const input = document.getElementById('companyPhoto');
            const box = document.getElementById('logoPreviewBox');
            const btn = document.getElementById('btnCancelPhoto');
            const err = document.getElementById('companyPhotoError');

            btn?.addEventListener('click', () => {
                err.textContent = '';
                input.value = '';
                const hasDefault = !!("@(ViewBag.CompanyPhotoUrl ?? "")");
                if (hasDefault) {
                    box.innerHTML = '<img id="logoPreview" src="@((ViewBag.CompanyPhotoUrl ?? "").ToString())" alt="Company Logo" />';
                } else {
                    box.innerHTML = '<span class="text-muted">Company Photo</span>';
                }
            });
        })();
    </script>
</body>

</html>