@* File: Areas/Recruiter/Views/Jobs/Pipeline.cshtml *@
@using JobPortal.Areas.Recruiter.Models
@{
  var job = ViewBag.Job as JobItemVM ?? new JobItemVM(0, "", "", JobStatus.Draft, "");
  var cands = ViewBag.Cands as List<CandidateItemVM> ?? new List<CandidateItemVM>();
  string[] cols = new[] { "New", "AI-Screened", "Shortlisted", "Interview", "Offer", "Hired/Rejected" };
  var by = cols.ToDictionary(c => c, c => cands.Where(x => string.Equals(x.Stage ?? "", c,
  StringComparison.OrdinalIgnoreCase)).ToList());

  // NEW: requirements (if controller populated ViewBag.Reqs)
  var reqs = ViewBag.Reqs as string[] ?? Array.Empty<string>();

  // NOTE: We no longer disable "AI Evaluate All" even if there are AI-Screened cards.
}

@if (ViewBag.DebugAppsCount != null)
{
  <div class="text-muted small">apps: @ViewBag.DebugAppsCount, cards: @ViewBag.DebugCandsCount</div>
}

<style>
  .kanban-col.drop-hover {
    background: #f1f5ff;
    border-color: #9ec5fe;
  }

  .btn-xxs {
    padding: 2px 6px;
    font-size: .72rem;
  }

  /* ===== Progress overlay (AI evaluation) ===== */
  #aiProgressOverlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, .7);
    backdrop-filter: blur(2px);
    display: none;
    z-index: 2000;
  }

  #aiProgressOverlay .box {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: .75rem;
    padding: 1rem 1.25rem;
    min-width: 260px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, .08);
  }
</style>

<a asp-area="Recruiter" asp-controller="Jobs" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
  &leftarrow; Back to Jobs
</a>

<div class="mb-2 d-flex align-items-center gap-2">
  <span class="chip">@job.Title</span> • <span class="chip">@job.Location</span>

  @* ==== AI: Evaluate All candidates for this job + Scoring Rules ==== *@
  @if (job.Id > 0)
  {
    <form id="evalAllForm" method="post" asp-area="Recruiter" asp-controller="AiEvaluation" asp-action="EvaluateJob"
      class="ms-2">
      @Html.AntiForgeryToken()
      <input type="hidden" name="jobId" value="@job.Id" />
      <div class="dropdown d-inline">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          Scoring Rules
        </button>
        <div class="dropdown-menu p-3" style="min-width:320px; max-height:300px; overflow:auto;">
          <div class="small text-muted mb-2">Tick items to count them <strong>x2</strong> during scoring.</div>
          @if (reqs.Length == 0)
          {
            <div class="text-muted small">No requirements found.</div>
          }
          else
          {
            foreach (var r in reqs)
            {
              var id = "w_" + r.GetHashCode();
              <div class="form-check">
                <input class="form-check-input weight2" type="checkbox" id="@id" name="weight2" value="@r">
                <label class="form-check-label" for="@id">@r</label>
              </div>
            }
          }
          <div class="d-flex justify-content-end mt-2">
            <button type="button" id="btnSaveRules" class="btn btn-sm btn-outline-secondary">Save</button>
          </div>
        </div>
      </div>

      @* Always enabled now *@
      <button type="submit" class="btn btn-sm btn-outline-primary" title="Run AI scoring for all applicants">
        AI Evaluate All
      </button>

      <button type="button" id="btnRescore" class="btn btn-sm btn-primary" title="Re-score using saved rules">
        Re-score
      </button>
    </form>
  }
</div>

@* Needed by JS when posting *@
<input type="hidden" id="jobId" value="@job.Id" />

<div class="kanban" id="board">
  @foreach (var col in cols)
  {
    <div class="kanban-col" data-stage="@col">
      <div class="fw-semibold mb-2">@col (@by[col].Count)</div>
      @foreach (var x in by[col])
      {
        <div class="candidate-card" draggable="true" data-id="@x.Id" data-stage="@col">
          <div class="d-flex justify-content-between align-items-center">
            <div>@x.Name</div>
            <div class="d-flex align-items-center gap-2">
              <div class="score">@x.Score</div>

              @* ==== AI: Evaluate this single candidate; inherits weights from Scoring Rules ==== *@
              <form method="post" asp-area="Recruiter" asp-controller="AiEvaluation" asp-action="EvaluateOne"
                class="m-0 p-0 eval-one-form">
                @Html.AntiForgeryToken()
                <input type="hidden" name="applicationId" value="@x.Id" />
                <button type="submit" class="btn btn-xxs btn-outline-secondary" title="AI Evaluate this candidate">
                  AI
                </button>
              </form>

              @* ==== Manual rank note (up/down) ==== *@
              <button type="button" class="btn btn-xxs btn-outline-dark" title="Boost (note required)"
                onclick="openRank('@x.Id','up')">▲</button>
              <button type="button" class="btn btn-xxs btn-outline-dark" title="Demote (note required)"
                onclick="openRank('@x.Id','down')">▼</button>
            </div>
          </div>
          <div class="small text-muted">@x.AppliedAt</div>
          <div class="mt-1">
            @if (x.LowConfidence)
            {
              <span class="badge text-bg-warning">Low confidence</span>
            }
            @if (x.Override)
            {
              <span class="badge text-bg-info">Former employee</span>
            }
          </div>
          <div class="mt-2 d-flex gap-2">
            <a class="btn btn-sm btn-outline-primary" asp-area="Recruiter" asp-controller="Candidates" asp-action="Detail"
              asp-route-id="@x.Id">Open</a>
          </div>

        </div>
      }
    </div>
  }
</div>

@* --- OFFER MODAL (unchanged UI) --- *@
<style>
  /* Position close button at top-right of the header */
  #offer-modal .modal-header {
    position: relative;
  }

  #offer-modal .modal-header .btn-close,
  #offer-modal .modal-header .close {
    position: absolute;
    top: .75rem;
    right: .75rem;
    margin: 0;
  }
</style>

<div id="offer-modal" class="modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="offer-form" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ApplicationId" id="offer-ApplicationId" />

        <div class="modal-header">
          <h5 class="modal-title">Send Offer</h5>
          <button type="button" class="btn-close" aria-label="Close" onclick="OfferUI.close()"></button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Salary Offer</label>
            <input name="SalaryOffer" type="number" step="0.01" class="form-control" />
          </div>

          <div class="form-group">
            <label>Start Date</label>
            <input name="StartDate" type="date" class="form-control" />
          </div>

          <div class="form-group">
            <label>Contract Type</label>
            <select name="ContractType" class="form-control" required>
              <option value="" selected disabled>Select contract type</option>
              <option>Full Time</option>
              <option>Part Time</option>
              <option>Contract</option>
              <option>Freelance</option>
              <option>Internship</option>
            </select>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea name="Notes" class="form-control"></textarea>
          </div>

          <small class="text-muted">
            Submitting will send the offer and move the candidate to <strong>Offer</strong>.
          </small>
        </div>

        <div class="modal-footer d-flex justify-content-end">
          <button type="button" class="btn btn-light me-2" onclick="OfferUI.close()">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Offer</button>
        </div>
      </form>
    </div>
  </div>
</div>

@* --- Rank Note Modal (wired for AJAX to Jobs/OverrideRank) --- *@
<div class="modal fade" id="rankModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      @* keep asp-route (unchanged), JS intercepts submit to call Jobs/OverrideRank *@
      <form id="rankForm" method="post" asp-area="Recruiter" asp-controller="AiEvaluation" asp-action="RankNote">
        @Html.AntiForgeryToken()
        <input type="hidden" id="rankAppId" name="applicationId" />
        <input type="hidden" id="rankDir" name="direction" />
        <div class="modal-header">
          <h5 class="modal-title">Add ranking note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" id="rankReason" name="reason" rows="3" placeholder="e.g. Good culture fit"
            required></textarea>
          <small class="text-muted">This note is saved to the candidate’s thread.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

@* ===== AI progress overlay ===== *@
<div id="aiProgressOverlay" role="dialog" aria-live="polite" aria-busy="true">
  <div class="box">
    <div class="d-flex align-items-center gap-2">
      <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
      <div><strong>AI evaluation in progress…</strong></div>
    </div>
    <div class="small text-muted mt-2">Please keep this tab open. This may take a few seconds.</div>
  </div>
</div>

@section Scripts {
  <script>
    (function () {
      function antiForgery() {
        const input = document.querySelector('input[name="__RequestVerificationToken"]');
        return input ? input.value : '';
      }

      function showOverlay() { const el = document.getElementById('aiProgressOverlay'); if (el) el.style.display = 'block'; }
      function hideOverlay() { const el = document.getElementById('aiProgressOverlay'); if (el) el.style.display = 'none'; }

      function toast(msg, isError) {
        if (window.toastr) { isError ? toastr.error(msg) : toastr.success(msg); return; }
        console[isError ? 'error' : 'log'](msg);
      }

      // ===== Scoring Rules: auto-save (debounced) + Save button =====
      const jobId = document.getElementById('jobId')?.value || '0';
      const ruleBoxes = Array.from(document.querySelectorAll('#evalAllForm input.weight2'));
      let saveTimer = null;

      async function saveRules(explicitClick) {
        const payload = new URLSearchParams();
        ruleBoxes.filter(b => b.checked).forEach(b => payload.append('weight2', b.value));
        const res = await fetch(`@Url.Action("ScoringRules", "Jobs", new { area = "Recruiter" })/${jobId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'RequestVerificationToken': antiForgery()
          },
          body: payload.toString()
        });
        const json = await res.json().catch(() => ({}));
        if (json && json.ok) {
          if (explicitClick) toast('Scoring Rules saved.');
        } else if (explicitClick) {
          toast(json?.error || 'Failed to save rules', true);
        }
      }

      ruleBoxes.forEach(b => {
        b.addEventListener('change', function () {
          clearTimeout(saveTimer);
          saveTimer = setTimeout(saveRules, 500);
        });
      });

      document.getElementById('btnSaveRules')?.addEventListener('click', function () { saveRules(true); });

      // ===== Evaluate All: show overlay during submit =====
      const evalForm = document.getElementById('evalAllForm');
      if (evalForm) {
        evalForm.addEventListener('submit', function () {
          // ensure single-candidate forms inherit latest checks
          document.querySelectorAll('.eval-one-form').forEach(function (f) {
            f.querySelectorAll('input[name="weight2"]').forEach(x => x.remove());
            ruleBoxes.filter(b => b.checked).forEach(function (src) {
              const h = document.createElement('input');
              h.type = 'hidden'; h.name = 'weight2'; h.value = src.value;
              f.appendChild(h);
            });
          });
          showOverlay();
        });
      }

      // ===== Re-score: uses saved rules =====
      const btnRescore = document.getElementById('btnRescore');
      if (btnRescore) {
        btnRescore.addEventListener('click', async function () {
          showOverlay();
          try {
            const res = await fetch(`@Url.Action("ReScore", "Jobs", new { area = "Recruiter" })/${jobId}`, {
              method: 'POST',
              headers: { 'RequestVerificationToken': antiForgery() }
            });
            const json = await res.json();
            if (!json.ok) { hideOverlay(); toast(json.error || 'Failed to load saved rules', true); return; }
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `@Url.Action("EvaluateJob", "AiEvaluation", new { area = "Recruiter" })`;
            const tok = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
            const t = document.createElement('input'); t.type = 'hidden'; t.name = '__RequestVerificationToken'; t.value = tok; form.appendChild(t);
            const j = document.createElement('input'); j.type = 'hidden'; j.name = 'jobId'; j.value = jobId; form.appendChild(j);
            (json.weight2 || []).forEach(function (w) { const h = document.createElement('input'); h.type = 'hidden'; h.name = 'weight2'; h.value = w; form.appendChild(h); });
            document.body.appendChild(form);
            form.submit();
          } catch (e) {
            hideOverlay();
            toast('Re-score failed.', true);
          }
        });
      }

      // ===== Manual Ranking Override (AJAX) =====
      window.openRank = function (appId, dir) {
        document.getElementById('rankAppId').value = appId;
        document.getElementById('rankDir').value = dir;
        document.getElementById('rankReason').value = '';
        const m = new bootstrap.Modal(document.getElementById('rankModal'));
        m.show();
      };

      document.getElementById('rankForm')?.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        const appId = document.getElementById('rankAppId').value;
        const dir = document.getElementById('rankDir').value;
        const reason = document.getElementById('rankReason').value.trim();
        const jobId = document.getElementById('jobId').value;
        if (!reason) { toast('Reason is required.', true); return; }

        const payload = new URLSearchParams();
        payload.append('id', jobId);
        payload.append('applicationId', appId);
        payload.append('direction', dir);
        payload.append('reason', reason);

        try {
          const res = await fetch(`@Url.Action("OverrideRank", "Jobs", new { area = "Recruiter" })/${jobId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
              'RequestVerificationToken': antiForgery()
            },
            body: payload.toString()
          });
          const json = await res.json();
          if (!json.ok) { toast(json.error || 'Failed to update ranking', true); return; }

          const card = document.querySelector(`.candidate-card[data-id="${appId}"]`);
          if (card) {
            const col = card.closest('.kanban-col');
            const siblings = Array.from(col.querySelectorAll('.candidate-card'));
            const idx = siblings.indexOf(card);
            if (dir === 'up' && idx > 0) col.insertBefore(card, siblings[idx - 1]);
            else if (dir === 'down' && idx < siblings.length - 1) col.insertBefore(siblings[idx + 1], card);
          }

          toast('Ranking updated…');
          bootstrap.Modal.getInstance(document.getElementById('rankModal'))?.hide();
        } catch (e) {
          toast('Failed to update ranking', true);
        }
      });

      // ===== Drag & drop (existing) =====
      const stages = ["AI-Screened", "Shortlisted", "Interview", "Offer"];
      const nextStage = { "AI-Screened": "Shortlisted", "Shortlisted": "Interview", "Interview": "Offer" };

      document.querySelectorAll('.candidate-card').forEach(card => {
        card.addEventListener('dragstart', e => {
          if (!card.dataset.stage) {
            const col = card.closest('.kanban-col');
            if (col) card.dataset.stage = (col.dataset.stage || '').trim();
          }
          e.dataTransfer.setData('text/plain', card.dataset.id);
          e.dataTransfer.effectAllowed = 'move';
        });
      });

      document.querySelectorAll('.kanban-col').forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drop-hover'); });
        col.addEventListener('dragleave', () => col.classList.remove('drop-hover'));
        col.addEventListener('drop', onDrop);
      });

      async function onDrop(e) {
        e.preventDefault();
        const column = e.currentTarget;
        column.classList.remove('drop-hover');

        const toStage = (column.dataset.stage || '').trim();
        if (!stages.includes(toStage)) { return; }

        const appId = e.dataTransfer.getData('text/plain');
        const card = document.querySelector(`.candidate-card[data-id="${appId}"]`);
        if (!card) return;

        const fromStage = (card.dataset.stage || '').trim();
        if (!nextStage[fromStage] || nextStage[fromStage] !== toStage) {
          toast(`Invalid move: ${fromStage || 'Unknown'} → ${toStage}`, true);
          return;
        }

        const jobId = document.getElementById('jobId')?.value || '0';

        if (toStage === "Offer") {
          OfferUI.open(appId, async function (formData) {
            const res = await fetch(`@Url.Action("CreateOffer", "Jobs", new { area = "Recruiter" })`, {
              method: 'POST',
              headers: { 'RequestVerificationToken': antiForgery() },
              body: formData
            });
            const json = await res.json();
            if (!json.ok) { toast(json.error || 'Failed to send offer', true); return; }
            moveCard(card, column, toStage);
            toast('Offer sent and candidate moved to Offer.');
          });
          return;
        }

        const payload = new URLSearchParams();
        payload.append('jobId', jobId);
        payload.append('applicationId', appId);
        payload.append('toStage', toStage);

        const res = await fetch(`@Url.Action("MoveCandidate", "Jobs", new { area = "Recruiter" })`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'RequestVerificationToken': antiForgery()
          },
          body: payload.toString()
        });
        const json = await res.json();
        if (!json.ok) { toast(json.error || 'Failed to move candidate', true); return; }

        moveCard(card, column, toStage);
        toast(`Moved to ${toStage}.`);
      }

      function moveCard(card, column, toStage) {
        column.appendChild(card);
        card.dataset.stage = toStage;
      }

      // Simple Offer modal helper
      window.OfferUI = {
        open(appId, onSubmit) {
          const modal = document.getElementById('offer-modal');
          const form = document.getElementById('offer-form');
          document.getElementById('offer-ApplicationId').value = appId;

          const handler = async function (ev) {
            ev.preventDefault();
            const fd = new FormData(form);
            await onSubmit(fd);
            form.removeEventListener('submit', handler);
            OfferUI.close();
          };
          form.addEventListener('submit', handler);
          modal.style.display = 'block';
        },
        close() { document.getElementById('offer-modal').style.display = 'none'; }
      };
    })();
  </script>
}