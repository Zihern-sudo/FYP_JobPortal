@* File: Areas/Recruiter/Views/Jobs/Edit.cshtml *@
@model JobPortal.Areas.Recruiter.Models.JobEditVm


<a asp-area="Recruiter" asp-controller="Jobs" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
  &leftarrow; Back to Jobs
</a>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Edit Job</h2>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#applyTplModal"
      onclick="loadTplModal(@Model.job_listing_id, '');">
      Apply Template…
    </button>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveAsTemplateModal">
      Save As Template
    </button>
  </div>
</div>

@* Toast for messages & approval status updates *@
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-notify" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-message"></div>
  </div>
</div>

<form id="editForm" asp-area="Recruiter" asp-controller="Jobs" asp-action="Edit" method="post">
  @Html.AntiForgeryToken()
  <input type="hidden" asp-for="job_listing_id" />

  @* Removed job_status field (recruiters cannot set status) *@

  <div class="mb-3">
    <label asp-for="job_title" class="form-label">Job Title</label>
    <input asp-for="job_title" class="form-control" />
    <span asp-validation-for="job_title" class="text-danger"></span>
  </div>

  <div class="mb-3">
    <label asp-for="job_description" class="form-label">Job Description</label>
    <textarea asp-for="job_description" class="form-control" rows="6"></textarea>
    <span asp-validation-for="job_description" class="text-danger"></span>
  </div>

  <div class="mb-3">
    <label asp-for="job_requirements" class="form-label">Must-have Requirements</label>
    <textarea asp-for="job_requirements" class="form-control" rows="4"></textarea>
    <span asp-validation-for="job_requirements" class="text-danger"></span>
  </div>

  <div class="mb-3">
    <label asp-for="job_requirements_nice" class="form-label">Nice-to-have Requirements</label>
    <textarea asp-for="job_requirements_nice" class="form-control" rows="4"></textarea>
    <span asp-validation-for="job_requirements_nice" class="text-danger"></span>
  </div>

  <div class="mb-3">
    <div class="row g-3">
      <div class="col-md-6">
        <label asp-for="salary_min" class="form-label"></label>
        <input asp-for="salary_min" class="form-control" />
        <span asp-validation-for="salary_min" class="text-danger"></span>
      </div>
      <div class="col-md-6">
        <label asp-for="salary_max" class="form-label"></label>
        <input asp-for="salary_max" class="form-control" />
        <span asp-validation-for="salary_max" class="text-danger"></span>
      </div>

      <div class="col-md-6">
        <label asp-for="job_type" class="form-label"></label>
        <select asp-for="job_type" class="form-select"
          asp-items="new SelectList(JobPortal.Areas.Recruiter.Models.JobCatalog.Categories)">
        </select>
        <span asp-validation-for="job_type" class="text-danger"></span>
      </div>

      <div class="col-md-6">
        <label asp-for="work_mode" class="form-label"></label>
        <select asp-for="work_mode" class="form-select"
          asp-items="new SelectList(JobPortal.Areas.Recruiter.Models.JobCatalog.WorkModes)">
        </select>
        <span asp-validation-for="work_mode" class="text-danger"></span>
      </div>
    </div>
  </div>

  <div class="mb-4">
    <label asp-for="expiry_date" class="form-label">Application Deadline</label>
    <input asp-for="expiry_date" class="form-control" type="date" />
    <span asp-validation-for="expiry_date" class="text-danger"></span>
  </div>
</form>

@* Single right-aligned toolbar: Green Save + Submit for Approval side-by-side *@
<div class="d-flex justify-content-end gap-2">
  <button type="submit" form="editForm" class="btn btn-success">Save</button>
  <form method="post" asp-area="Recruiter" asp-controller="Jobs" asp-action="SubmitForApproval" asp-antiforgery="true"
    class="d-inline">
    <input type="hidden" name="id" value="@Model.job_listing_id" />
    @{
      var latestStatus = (string)(ViewBag.ApprovalStatus ?? "");
      var disableSubmit = string.Equals(latestStatus, "Pending", StringComparison.OrdinalIgnoreCase);
    }
    <button id="btnSubmitApproval" type="submit" class="btn btn-outline-primary" @(disableSubmit ? "disabled" : null)>
      Submit for Approval
    </button>
  </form>
</div>

@* Approval info + progress *@
@if (ViewBag.ApprovalStatus != null)
{
  var st = ((string)ViewBag.ApprovalStatus)?.Trim() ?? "None";
  string badgeClass = st switch
  {
    "Approved" => "bg-success",
    "Rejected" => "bg-danger",
    "ChangesRequested" => "bg-warning text-dark",
    "Pending" => "bg-secondary",
    _ => "bg-light text-dark"
  };
  var pct = st == "Approved" ? 100
  : st == "ChangesRequested" ? 66
  : st == "Pending" ? 50
  : st == "Rejected" ? 100
  : 0;
  var barClass = st == "Approved" ? "bg-success"
  : st == "ChangesRequested" ? "bg-warning"
  : st == "Pending" ? "bg-info"
  : st == "Rejected" ? "bg-danger"
  : "bg-secondary";

  <div class="card mt-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Approval Progress</strong>
        <span class="badge @badgeClass px-3 py-2" id="approvalStatusVal">@st</span>
      </div>
      <div class="progress" style="height:6px;">
        <div class="progress-bar @barClass" role="progressbar" style="width:@pct%"></div>
      </div>
      <div class="d-flex flex-wrap gap-3 mt-2">
        @if (!string.IsNullOrWhiteSpace((string)ViewBag.ApprovalComments))
        {
          <div><strong>Admin feedback:</strong> <span id="approvalCommentsVal">@ViewBag.ApprovalComments</span></div>
        }
        @if (ViewBag.ApprovalUpdatedAt != null)
        {
          <div class="small text-muted" id="approvalUpdatedVal">
            Updated: @(((DateTime)ViewBag.ApprovalUpdatedAt).ToString("yyyy-MM-dd HH:mm"))
          </div>
        }
        <div class="text-muted small ms-auto">
          Approval is required before the job can be Open.
        </div>
      </div>
    </div>
  </div>
}

<!-- Apply Template Modal -->
<div class="modal fade" id="applyTplModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-body p-3" id="applyTplModalBody">
        <div class="d-flex align-items-center">
          <div class="spinner-border me-2" role="status" aria-hidden="true"></div>
          Loading templates…
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Save As Template Modal -->
<div class="modal fade" id="saveAsTemplateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Save Job As Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form asp-area="Recruiter" asp-controller="Jobs" asp-action="SaveAsTemplate" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.job_listing_id" />
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Template Name</label>
            <input class="form-control" name="name" placeholder="This will be saved under Templates → Job Templates." />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Template</button>
        </div>
      </form>
    </div>
  </div>
</div>

@* SAFE bridge for JS *@
<div id="js-data" data-job-id="@Model.job_listing_id"
  data-approval-info-url="@Url.Action("ApprovalInfo", "Jobs", new { area = "Recruiter" })"
  data-message="@TempData["Message"]" data-status="@((string)(ViewBag.ApprovalStatus ?? ""))">
</div>

@section Scripts {
  <script>
    function showToast(msg) {
      const el = document.getElementById('toast-notify');
      const body = document.getElementById('toast-message');
      if (!el || !body) return;
      body.textContent = msg;
      new bootstrap.Toast(el).show();
    }

    (function () {
      const dataEl = document.getElementById('js-data');
      if (!dataEl) return;

      const message = dataEl.dataset.message || '';
      if (message) showToast(message);

      const jobId = dataEl.dataset.jobId;
      const baseUrl = dataEl.dataset.approvalInfoUrl;
      const statusEl = document.getElementById('approvalStatusVal');
      const submitBtn = document.getElementById('btnSubmitApproval');
      if (!statusEl || !jobId || !baseUrl) return;

      // Disable submit while Pending or Approved
      let current = (statusEl.textContent || '').trim();
      if (submitBtn) submitBtn.disabled = (current === 'Pending' || current === 'Approved');

      if (current !== 'Pending') return;

      let tries = 0, maxTries = 45; // ~6 minutes at 8s
      const interval = setInterval(async () => {
        tries++;
        try {
          const res = await fetch(`${baseUrl}/${jobId}`, { credentials: 'same-origin' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const next = (data && data.status ? String(data.status) : 'None').trim();

          if (next && next !== current) {
            // Update UI
            statusEl.textContent = next;
            const cmtEl = document.getElementById('approvalCommentsVal');
            if (cmtEl && typeof data.comments === 'string') cmtEl.textContent = data.comments ?? '';
            const updEl = document.getElementById('approvalUpdatedVal');
            if (updEl && data.updatedAt) {
              const dt = new Date(data.updatedAt);
              const pad = n => String(n).padStart(2, '0');
              updEl.textContent = `Updated: ${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
            }

            // Enable/disable submit accordingly
            if (submitBtn) submitBtn.disabled = (next === 'Pending' || next === 'Approved');

            // Notify
            const msg = (next === 'Approved')
              ? 'Your job was approved. Status is now Open.'
              : (next === 'ChangesRequested')
                ? 'Admin requested changes. See feedback.'
                : (next === 'Rejected')
                  ? 'Job was rejected. See feedback.'
                  : `Approval status changed: ${next}`;
            showToast(msg);

            clearInterval(interval);
          }
        } catch { }
        if (tries >= maxTries) clearInterval(interval);
      }, 8000);
    })();

    async function loadTplModal(jobId, q) {
      try {
        const box = document.getElementById('applyTplModalBody');
        box.innerHTML =
          '<div class="d-flex align-items-center"><div class="spinner-border me-2" role="status"></div>Loading templates…</div>';
        const url = new URL('@Url.Action("Modal", "JobPostTemplates", new { area = "Recruiter" })', window.location.origin);
        url.searchParams.set('jobId', jobId);
        if (q) url.searchParams.set('q', q);
        const res = await fetch(url, { credentials: 'same-origin' });
        box.innerHTML = await res.text();
      } catch {
        document.getElementById('applyTplModalBody').innerHTML =
          '<div class="text-danger">Failed to load templates. Please refresh.</div>';
      }
      return false;
    }
  </script>
}