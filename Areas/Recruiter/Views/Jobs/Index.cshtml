@using JobPortal.Areas.Shared.Models
@using JobPortal.Areas.Recruiter.Models
@model JobPortal.Areas.Recruiter.Models.JobsIndexVM

@functions {
  string ChipClass(string status) => status switch
  {
    "Approved" => "badge text-bg-success",
    "Rejected" => "badge text-bg-danger",
    "ChangesRequested" => "badge text-bg-warning",
    "Pending" => "badge text-bg-secondary",
    _ => "badge text-bg-light"
  };

  string CompanyChipClass(string? s) => (s ?? "").Trim() switch
  {
    "Active" => "badge text-bg-success",
    "Verified" => "badge text-bg-success",
    "Pending" => "badge text-bg-warning",
    "Suspended" => "badge text-bg-danger",
    _ => "badge text-bg-secondary"
  };

  string JobStatusChip(string? s) => (s ?? "").Trim() switch
  {
    "Open" => "badge text-bg-success",
    "Draft" => "badge text-bg-secondary",
    "Paused" => "badge text-bg-warning",
    "Closed" => "badge text-bg-dark",
    _ => "badge text-bg-light"
  };
}

@{
  var jobs = Model.Items ?? Enumerable.Empty<job_listing>();
  var order = Model.Order;

  string RoutePreserve(int page) => Url.Action("Index", new
  {
    q = Model.Query,
    status = Model.Status,
    order = Model.Order,
    page = page,
    pageSize = Model.PageSize
  })!;

  var pendingIds = new List<int>();
  bool allowPost = (bool)(ViewBag.AllowPost ?? false);
}

<style>
  /* spacing/readability */
  .jobs-table th,
  .jobs-table td {
    padding: .75rem 1rem;
    vertical-align: middle;
  }

  .jobs-table th.min {
    width: 86px;
  }

  .jobs-table td.title {
    min-width: 280px;
    white-space: normal;
  }

  .jobs-table td.nowrap,
  .jobs-table th.nowrap {
    white-space: nowrap;
  }
</style>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-notify" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-message"></div>
  </div>
</div>

<form method="get" class="d-flex gap-2 align-items-center mb-3">
  <input name="q" value="@Model.Query" class="form-control" placeholder="Search title or location…"
    style="max-width:320px" />
  <select name="status" class="form-select" style="max-width:180px">
    <option value="">All statuses</option>
    @foreach (var s in new[] { "Open", "Paused", "Draft", "Closed" })
    {
      <option value="@s" selected="@(Model.Status == s ? "selected" : null)">@s</option>
    }
  </select>
  <input type="hidden" name="order" value="@Model.Order" />
  <button type="submit" class="btn btn-primary">Search</button>
  <a asp-action="Index" class="btn btn-outline-secondary">Reset</a>

  @if (allowPost)
  {
    <a class="btn btn-primary btn-sm ms-auto" asp-area="Recruiter" asp-controller="Jobs" asp-action="Add">New Job</a>
    <a class="btn btn-outline-primary btn-sm" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Index">
      New Job using Template
    </a>
  }
  else
  {
    <span class="badge text-bg-warning ms-auto" title="Your company must be Verified or Active to post jobs.">
      Company not verified
    </span>
  }
</form>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table mb-0 align-middle jobs-table">
        <thead>
          <tr>
            <th class="min nowrap">
              <a asp-area="Recruiter" asp-controller="Jobs" asp-action="Index"
                asp-route-order="@(order == "asc" ? "desc" : "asc")" asp-route-q="@Model.Query"
                asp-route-status="@Model.Status" class="text-decoration-none text-body" title="Toggle sort by ID">
                <span class="me-1">ID</span>
                <span class="small">@((order == "asc") ? "▲" : "▼")</span>
              </a>
            </th>
            <th>Title</th>
            <th class="nowrap">Category</th>
            <th>Approval</th>
            <th class="nowrap">Deadline</th>
            <th class="nowrap">Location</th>
            <th class="nowrap">Company Status</th>
            <th class="nowrap">Job Status</th>
            <th class="nowrap">Job Category</th>
            <th class="nowrap">Work Mode</th>
            <th class="nowrap">Created</th>
            <th class="nowrap"></th>
          </tr>
        </thead>
        <tbody id="jobRows">
          @if (jobs.Any())
          {
            foreach (var j in jobs)
            {
              var statusEnum = Enum.TryParse<JobStatus>(j.job_status ?? "", true, out var s) ? s : JobStatus.Open;
              string deadline = j.expiry_date.HasValue ? j.expiry_date.Value.ToString("yyyy-MM-dd") : "—";

              string stText = "None";
              if (Model.LatestApprovalStatuses != null &&
              Model.LatestApprovalStatuses.TryGetValue(j.job_listing_id, out var approvalRawValue) &&
              !string.IsNullOrWhiteSpace(approvalRawValue))
              {
                stText = approvalRawValue;
              }
              if (string.Equals(j.job_status, "Draft", StringComparison.OrdinalIgnoreCase) &&
              string.Equals(stText, "Approved", StringComparison.OrdinalIgnoreCase))
              {
                stText = "ChangesRequested";
              }
              if (string.Equals(stText, "Pending", StringComparison.OrdinalIgnoreCase))
              {
                pendingIds.Add(j.job_listing_id);
              }

              bool isOpen = string.Equals(j.job_status, "Open", StringComparison.OrdinalIgnoreCase);
              bool isClosed = string.Equals(j.job_status, "Closed", StringComparison.OrdinalIgnoreCase);

              var pct = stText == "Approved" ? 100
              : stText == "ChangesRequested" ? 66
              : stText == "Pending" ? 50
              : stText == "Rejected" ? 100
              : 0;

              var barClass = stText == "Approved" ? "bg-success"
              : stText == "ChangesRequested" ? "bg-warning"
              : stText == "Pending" ? "bg-info"
              : stText == "Rejected" ? "bg-danger"
              : "bg-secondary";

              var tipText =
              stText == "Approved" ? "Approved by admin. Job can be Open."
              : stText == "ChangesRequested" ? "Admin requested changes. Edit and resubmit for approval."
              : stText == "Pending" ? "Submitted for approval. Waiting for admin review."
              : stText == "Rejected" ? "Rejected by admin. See comments and update."
              : "No approval request yet.";

              var companyStatus = (j.company?.company_status ?? "").Trim();
              var companyBadgeClass = CompanyChipClass(companyStatus);
              var companyLabel = string.IsNullOrWhiteSpace(companyStatus) ? "Unknown" : companyStatus;

              <tr>
                <td class="nowrap">@j.job_listing_id</td>

                <td class="title">@j.job_title</td>
                <td class="nowrap">@j.job_category</td>

                <td style="min-width:220px">
                  <div class="progress" style="height:6px;" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="@tipText" aria-label="@tipText">
                    <div class="progress-bar @barClass" role="progressbar" style="width:@pct%"></div>
                  </div>
                  <small class="@ChipClass(stText) mt-1 d-inline-block" data-bs-toggle="tooltip" data-bs-placement="top"
                    title="@tipText">@stText</small>
                </td>

                <td class="nowrap">@deadline</td>
                <td class="nowrap">@(
                  string.IsNullOrWhiteSpace(j.company?.company_location) ? "—" : j.company!.company_location
                            )</td>

                <td class="nowrap">
                  <span class="@companyBadgeClass">@companyLabel</span>
                </td>

                <td class="nowrap">
                  <span class="@JobStatusChip(j.job_status)">@statusEnum</span>
                </td>

                <td class="nowrap">@j.job_type</td>
                <td class="nowrap">@j.work_mode</td>
                <td class="nowrap">@(
                  j.date_posted == default(DateTime) ? "-" : j.date_posted.ToString("yyyy-MM-dd HH:mm")
                            )</td>

                <td class="text-end nowrap">
                  <a class="btn btn-sm btn-outline-secondary" asp-area="Recruiter" asp-controller="Jobs" asp-action="Edit"
                    asp-route-id="@j.job_listing_id">Edit</a>

                  @if (isOpen)
                  {
                    <a class="btn btn-sm btn-outline-primary" asp-area="Recruiter" asp-controller="Jobs" asp-action="Preview"
                      asp-route-id="@j.job_listing_id">Preview</a>
                    <a class="btn btn-sm btn-primary" asp-area="Recruiter" asp-controller="Jobs" asp-action="Pipeline"
                      asp-route-id="@j.job_listing_id">Pipeline</a>

                    @* Close button *@
                    <form method="post" asp-area="Recruiter" asp-controller="Jobs" asp-action="Close" asp-antiforgery="true"
                      class="d-inline">
                      <input type="hidden" name="id" value="@j.job_listing_id" />
                      <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Close this job? Applicants will no longer be able to apply.');">
                        Close
                      </button>
                    </form>
                  }
                  else if (isClosed)
                  {
                    <button type="button" class="btn btn-sm btn-outline-primary" disabled data-bs-toggle="tooltip"
                      title="This job is Closed. Preview disabled.">Preview</button>
                    <button type="button" class="btn btn-sm btn-primary" disabled data-bs-toggle="tooltip"
                      title="This job is Closed. Pipeline disabled.">Pipeline</button>
                  }
                </td>
              </tr>
            }
          }
          else
          {
            <tr>
              <td colspan="12" class="text-center text-muted">No jobs found.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="js-index" data-approval-info-url="@Url.Action("ApprovalInfo", "Jobs", new { area = "Recruiter" })"
  data-pending-ids="@string.Join(",", pendingIds)">
</div>

<nav aria-label="paging" class="mt-3">
  <ul class="pagination justify-content-end">
    <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(1))">First</a>
    </li>
    <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(Model.Page - 1))">Prev</a>
    </li>
    @{
      var start = Math.Max(1, Model.Page - 2);
      var end = Math.Min(Model.TotalPages, Model.Page + 2);
      for (int p = start; p <= end; p++)
      {
        <li class="page-item @(p == Model.Page ? "active" : "")">
          <a class="page-link" href="@RoutePreserve(p)">@p</a>
        </li>
      }
    }
    <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.Page + 1))">Next</a>
    </li>
    <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.TotalPages))">Last</a>
    </li>
  </ul>
</nav>

<div class="text-muted small">
  Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> • Total
  <strong>@Model.TotalCount</strong> jobs
</div>

@section Scripts {
  <script>
    (function () {
      const bridge = document.getElementById('js-index');
      if (!bridge) return;
      const baseUrl = bridge.dataset.approvalInfoUrl || '';
      const raw = (bridge.dataset.pendingIds || '').trim();
      if (!baseUrl || !raw) return;

      const ids = raw.split(',').map(x => parseInt(x, 10)).filter(n => !isNaN(n));
      if (!ids.length) return;

      let tries = 0, maxTries = 60;
      const tick = async () => {
        tries++;
        try {
          for (const id of ids) {
            const res = await fetch(`${baseUrl}/${id}`, { credentials: 'same-origin' });
            if (!res.ok) continue;
            const data = await res.json();
            if ((data && data.status) && String(data.status).trim() === 'Approved') {
              window.location.reload(); return;
            }
          }
        } catch { }
        if (tries < maxTries) setTimeout(tick, 10000);
      };
      setTimeout(tick, 10000);
    })();

    (function () {
      var el = document.getElementById('toast-notify');
      var body = document.getElementById('toast-message');
      var message = '@(TempData["Message"] as string)';
      if (message && el && body) {
        body.textContent = message;
        new bootstrap.Toast(el).show();
      }
    })();

    (function () {
      var triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      triggers.forEach(function (el) { new bootstrap.Tooltip(el); });
    })();
  </script>
}