@using JobPortal.Areas.Shared.Models
@using JobPortal.Areas.Recruiter.Models
@model JobPortal.Areas.Recruiter.Models.JobsIndexVM

@functions {
  string ChipClass(string status) => status switch
  {
    "Approved" => "badge text-bg-success",
    "Rejected" => "badge text-bg-danger",
    "ChangesRequested" => "badge text-bg-warning",
    "Pending" => "badge text-bg-secondary",
    _ => "badge text-bg-light"
  };
}

@{

  var jobs = Model.Items ?? Enumerable.Empty<job_listing>();
  var order = Model.Order;

  string RoutePreserve(int page) => Url.Action("Index", new
  {
    q = Model.Query,
    status = Model.Status,
    order = Model.Order,
    page = page,
    pageSize = Model.PageSize
  })!;

  // Build pending IDs for auto-refresh polling
  var pendingIds = new List<int>();
  bool allowPost = (bool)(ViewBag.AllowPost ?? false);
}

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-notify" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-message"></div>
  </div>
</div>

<form method="get" class="d-flex gap-2 align-items-center mb-3">
  <input name="q" value="@Model.Query" class="form-control" placeholder="Search title or location…"
    style="max-width:320px" />
  <select name="status" class="form-select" style="max-width:180px">
    <option value="">All statuses</option>
    @foreach (var s in new[] { "Open", "Paused", "Draft", "Closed" })
    {
      <option value="@s" selected="@(Model.Status == s ? "selected" : null)">@s</option>
    }
  </select>
  <input type="hidden" name="order" value="@Model.Order" />
  <button type="submit" class="btn btn-primary">Search</button>
  <a asp-action="Index" class="btn btn-outline-secondary">Reset</a>

  @if (allowPost)
  {
    <a class="btn btn-primary btn-sm ms-auto" asp-area="Recruiter" asp-controller="Jobs" asp-action="Add">New Job</a>
    <a class="btn btn-outline-primary btn-sm" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Index">
      New Job using Template
    </a>
  }
  else
  {
    <span class="badge text-bg-warning ms-auto" title="Your company must be Verified or Active to post jobs.">
      Company not verified
    </span>
  }
</form>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <thead>
          <tr>
            <th style="width:90px;">
              <a asp-area="Recruiter" asp-controller="Jobs" asp-action="Index"
                asp-route-order="@(order == "asc" ? "desc" : "asc")" asp-route-q="@Model.Query"
                asp-route-status="@Model.Status" class="text-decoration-none text-body" title="Toggle sort by ID">
                <span class="me-1">ID</span>
                <span class="small">@((order == "asc") ? "▲" : "▼")</span>
              </a>
            </th>
            <th>Title</th>
            <th>Category</th>
            <th>Approval</th>
            <th>Deadline</th>
            <th>Location</th>
            <th>Status</th>
            <th>Job Category</th>
            <th>Work Mode</th>
            <th>Created</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="jobRows">
          @if (jobs.Any())
          {
            foreach (var j in jobs)
            {
              var status = Enum.TryParse<JobStatus>(j.job_status ?? "", true, out var s) ? s : JobStatus.Open;
              string deadline = j.expiry_date.HasValue ? j.expiry_date.Value.ToString("yyyy-MM-dd") : "—";

              string stText = "None";
              if (Model.LatestApprovalStatuses != null &&
              Model.LatestApprovalStatuses.TryGetValue(j.job_listing_id, out var approvalRawValue) &&
              !string.IsNullOrWhiteSpace(approvalRawValue))
              {
                stText = approvalRawValue;
              }
              if (string.Equals(stText, "Pending", StringComparison.OrdinalIgnoreCase))
              {
                pendingIds.Add(j.job_listing_id);
              }

              bool isOpen = string.Equals(j.job_status, "Open", StringComparison.OrdinalIgnoreCase);

              var pct = stText == "Approved" ? 100
              : stText == "ChangesRequested" ? 66
              : stText == "Pending" ? 50
              : stText == "Rejected" ? 100
              : 0;
              var barClass = stText == "Approved" ? "bg-success"
              : stText == "ChangesRequested" ? "bg-warning"
              : stText == "Pending" ? "bg-info"
              : stText == "Rejected" ? "bg-danger"
              : "bg-secondary";

              <tr>
                <td>@j.job_listing_id</td>

                <td>@j.job_title</td>
                <td>@j.job_category</td>
                <td style="min-width:200px">
                  <div class="progress" style="height:6px;">
                    <div class="progress-bar @barClass" role="progressbar" style="width:@pct%"></div>
                  </div>
                  <small class="@ChipClass(stText) mt-1 d-inline-block" title="Admin approval status">@stText</small>
                </td>
                <td>@deadline</td>
                <td>@(j.company?.company_location ?? "")</td>
                <td>
                  <span class="chip">@status</span>
                  @if (j.expiry_date.HasValue && j.expiry_date.Value.Date < DateTime.Today)
                  {
                    <span class="badge bg-secondary ms-2">Expired</span>
                  }
                  else
                  {
                    <span class="badge bg-success ms-2">Active</span>
                  }
                </td>
                <td>@j.job_type</td>
                <td>@j.work_mode</td>
                <td>@(j.date_posted == default(DateTime) ? "-" : j.date_posted.ToString("yyyy-MM-dd HH:mm"))</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" asp-area="Recruiter" asp-controller="Jobs" asp-action="Edit"
                    asp-route-id="@j.job_listing_id">Edit</a>

                  @if (isOpen)
                  {
                    <a class="btn btn-sm btn-outline-primary" asp-area="Recruiter" asp-controller="Jobs" asp-action="Preview"
                      asp-route-id="@j.job_listing_id">Preview</a>
                    <a class="btn btn-sm btn-primary" asp-area="Recruiter" asp-controller="Jobs" asp-action="Pipeline"
                      asp-route-id="@j.job_listing_id">Pipeline</a>
                  }
                </td>
              </tr>
            }
          }
          else
          {
            <tr>
              <td colspan="10" class="text-center text-muted">No jobs found.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

@* Safe bridge for auto-refresh polling *@
<div id="js-index" data-approval-info-url="@Url.Action("ApprovalInfo", "Jobs", new { area = "Recruiter" })"
  data-pending-ids="@string.Join(",", pendingIds)">
</div>

<nav aria-label="paging" class="mt-3">
  <ul class="pagination justify-content-end">
    <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(1))">First</a>
    </li>
    <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(Model.Page - 1))">Prev</a>
    </li>
    @{
      var start = Math.Max(1, Model.Page - 2);
      var end = Math.Min(Model.TotalPages, Model.Page + 2);
      for (int p = start; p <= end; p++)
      {
        <li class="page-item @(p == Model.Page ? "active" : "")">
          <a class="page-link" href="@RoutePreserve(p)">@p</a>
        </li>
      }
    }
    <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.Page + 1))">Next</a>
    </li>
    <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
      <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.TotalPages))">Last</a>
    </li>
  </ul>
</nav>

<div class="text-muted small">
  Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> &bull; Total
  <strong>@Model.TotalCount</strong> jobs
</div>

@section Scripts {
  <script>
    (function () {
      const bridge = document.getElementById('js-index');
      if (!bridge) return;
      const baseUrl = bridge.dataset.approvalInfoUrl || '';
      const raw = (bridge.dataset.pendingIds || '').trim();
      if (!baseUrl || !raw) return;

      const ids = raw.split(',').map(x => parseInt(x, 10)).filter(n => !isNaN(n));
      if (!ids.length) return;

      let tries = 0, maxTries = 60;
      const tick = async () => {
        tries++;
        try {
          for (const id of ids) {
            const res = await fetch(`${baseUrl}/${id}`, { credentials: 'same-origin' });
            if (!res.ok) continue;
            const data = await res.json();
            if ((data && data.status) && String(data.status).trim() === 'Approved') {
              window.location.reload();
              return;
            }
          }
        } catch { }
        if (tries < maxTries) setTimeout(tick, 10000);
      };
      setTimeout(tick, 10000);
    })();

    (function () {
      var el = document.getElementById('toast-notify');
      var body = document.getElementById('toast-message');
      var message = '@(TempData["Message"] as string)';
      if (message && el && body) {
        body.textContent = message;
        new bootstrap.Toast(el).show();
      }
    })();
  </script>
}