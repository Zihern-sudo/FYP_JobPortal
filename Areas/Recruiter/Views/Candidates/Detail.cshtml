@using JobPortal.Areas.Recruiter.Models
@using Microsoft.AspNetCore.Mvc.Rendering

@{
  ViewData["Title"] = ViewData["Title"] ?? "Candidate";
  var p = (CandidateVM)ViewBag.Profile;
  var notes = ViewBag.Messages as List<NoteVM> ?? new List<NoteVM>();
  var offerVm = (OfferFormVM)ViewBag.OfferForm;

  // ---- stage-aware UI rules ----
  var s = (p.Status ?? "").Trim().ToLowerInvariant();
  bool isSubmitted = s == "submitted";
  bool isAIScreened = s == "ai-screened";
  bool isShortlisted = s == "shortlisted";
  bool isInterview = s == "interview";
  bool isOffer = s == "offer";
  bool isHired = s == "hired";
  bool isRejected = s == "rejected";

  // Only allow moving to Interview from earlier stages; not from Interview/Offer/Hired/Rejected
  bool showMoveToInterview = (isSubmitted || isAIScreened || isShortlisted);

  // Per request: when Hired, hide Move to Interview, Send Offer, Mark Hired, Reject
  bool showSendOffer = !(isHired || isRejected);
  bool showHire = !(isHired || isRejected);
  bool showReject = !(isHired || isRejected);
}

<a asp-area="Recruiter" asp-controller="Candidates" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
  &leftarrow; Back to Candidates
</a>

<div class="d-flex align-items-start justify-content-between mb-3">
  <div>
    <h3 class="mb-1">@p.Name</h3>
    <div class="text-muted">
      <span class="me-3">@p.Email</span>
      @if (!string.IsNullOrWhiteSpace(p.Phone))
      {
        <span class="me-3">@p.Phone</span>
      }
      <span>Status: <span class="badge bg-secondary">@p.Status</span></span>
    </div>
  </div>

  <div class="btn-group">
    @if (showMoveToInterview)
    {
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="Interview" method="post" class="me-1">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@p.ApplicationId" />
        <button class="btn btn-outline-secondary btn-sm" type="submit">Move to Interview</button>
      </form>
    }

    @if (showSendOffer)
    {
      <button class="btn btn-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#offerModal">
        Send Offer
      </button>
    }

    @if (showHire)
    {
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="Hire" method="post" class="me-1">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@p.ApplicationId" />
        <button class="btn btn-success btn-sm" type="submit">Mark Hired</button>
      </form>
    }

    @if (showReject)
    {
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="Reject" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@p.ApplicationId" />
        <button class="btn btn-outline-danger btn-sm" type="submit">Reject</button>
      </form>
    }
  </div>
</div>

@if (TempData["Message"] != null)
{
  <div class="alert alert-info">@TempData["Message"]</div>
}

<div class="card mb-3">
  <div class="card-body">
    <h6 class="text-uppercase text-muted mb-2">Summary</h6>
    <p class="mb-0">@p.Summary</p>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h6 class="text-uppercase text-muted mb-3">Thread</h6>

    @if (notes.Count == 0)
    {
      <div class="text-muted">No messages yet.</div>
    }
    else
    {
      <div class="list-group">
        @foreach (var n in notes)
        {
          <div class="list-group-item">
            <div class="d-flex justify-content-between">
              <div>
                <strong>@n.Author</strong>
                <span class="text-muted">â€¢ @n.CreatedAt</span>
              </div>
              @if (n.FromRecruiter)
              {
                <span class="badge bg-primary">Recruiter</span>
              }
              else
              {
                <span class="badge bg-secondary">Candidate</span>
              }
            </div>
            <div class="mt-1" style="white-space:pre-line">@n.Text</div>
          </div>
        }
      </div>
    }

    <hr class="my-3" />

    <form asp-area="Recruiter" asp-controller="Candidates" asp-action="SendMessage" method="post">
      @Html.AntiForgeryToken()
      <input type="hidden" name="id" value="@p.ApplicationId" />
      <div class="input-group">
        <input class="form-control" name="text" placeholder="Write a quick note..." />
        <button class="btn btn-outline-primary" type="submit">Send</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= Offer Modal ================= -->
<div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="SendOffer" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-header">
          <h5 class="modal-title" id="offerModalLabel">Send Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" asp-for="@offerVm.ApplicationId" name="ApplicationId" value="@offerVm.ApplicationId" />

          <div class="mb-3">
            <label class="form-label">Salary Offer</label>
            <input type="number" step="0.01" class="form-control" name="SalaryOffer" />
          </div>

          <div class="mb-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" name="StartDate" />
          </div>

          <!-- Contract Type: switched to dropdown -->
          <div class="mb-3">
            <label class="form-label">Contract Type</label>
            @{
              var selectedCt = offerVm?.ContractType ?? "";
              var contractItems = new List<SelectListItem>
                        {
                        new("Full Time", "Full Time", selectedCt == "Full Time"),
                        new("Part Time", "Part Time", selectedCt == "Part Time"),
                        new("Contract", "Contract", selectedCt == "Contract"),
                        new("Freelance", "Freelance", selectedCt == "Freelance"),
                        new("Internship", "Internship", selectedCt == "Internship"),
                        };
            }
            @Html.DropDownList(
            "ContractType", // must match your VM property name
                        contractItems,
                        "Select contract type",
                        new { @class = "form-select", required = "required" }
                        )
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="3" name="Notes"
              placeholder="Add any special terms or instructions..."></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Offer</button>
        </div>
      </form>
    </div>
  </div>
</div>