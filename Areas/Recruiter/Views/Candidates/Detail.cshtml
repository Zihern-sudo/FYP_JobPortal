@using JobPortal.Areas.Recruiter.Models
@using Microsoft.AspNetCore.Mvc.Rendering

@{
  var p = (CandidateVM)ViewBag.Profile;
  var notes = ViewBag.Messages as List<NoteVM> ?? new List<NoteVM>();
  var offerVm = (OfferFormVM)ViewBag.OfferForm;

  var s = (p.Status ?? "").Trim().ToLowerInvariant();
  bool isSubmitted = s == "submitted";
  bool isAIScreened = s == "ai-screened";
  bool isShortlisted = s == "shortlisted";
  bool isInterview = s == "interview";
  bool isOffer = s == "offer";
  bool isHired = s == "hired";
  bool isRejected = s == "rejected";

  bool showMoveToInterview = (isSubmitted || isAIScreened || isShortlisted);
  bool showSendOffer = !(isHired || isRejected);
  bool showHire = !(isHired || isRejected);
  bool showReject = !(isHired || isRejected);

  // NEW: from DB job_application.expected_salary & job_application.description
  int? expectedSalary = ViewBag.ExpectedSalary as int?;
  string? candidateDesc = ViewBag.Description as string;
}

<a asp-area="Recruiter" asp-controller="Candidates" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
  &leftarrow; Back to Candidates
</a>

<div class="d-flex align-items-start justify-content-between mb-3">
  <div>
    <h3 class="mb-1">@p.Name</h3>
    <div class="text-muted">
      <span class="me-3">@p.Email</span>
      @if (!string.IsNullOrWhiteSpace(p.Phone))
      {
        <span class="me-3">@p.Phone</span>
      }
      <span>Status: <span class="badge bg-secondary">@p.Status</span></span>
      @if (ViewBag.AiScore != null)
      {
        <span class="ms-2">• AI Score: <span class="badge bg-primary">@ViewBag.AiScore</span></span>
        @if (ViewBag.AiEvaluated is DateTime dt)
        {
          <span class="text-muted small ms-1">(as of @dt.ToString("yyyy-MM-dd HH:mm"))</span>
        }
      }
    </div>
  </div>

  <div class="btn-group">
    @if (showMoveToInterview)
    {
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="Interview" method="post" class="me-1">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@p.ApplicationId" />
        <button class="btn btn-outline-secondary btn-sm" type="submit">Move to Interview</button>
      </form>
    }

    @* ==== AI: Tools ==== *@
    <div class="btn-group me-1">
      <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
        AI Tools
      </button>
      <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 280px;">
        <button class="dropdown-item" type="button" onclick="openParsed(@p.ApplicationId)">View/Edit Parsed
          Resume</button>
        <div class="dropdown-divider"></div>
        <form id="evalOneForm" asp-area="Recruiter" asp-controller="AiEvaluation" asp-action="EvaluateOne" method="post"
          class="px-2">
          @Html.AntiForgeryToken()
          <input type="hidden" name="applicationId" value="@p.ApplicationId" />
          <div class="small text-muted mb-1">Scoring Rules (x2 weight)</div>
          <div id="weightsContainer" class="border rounded p-2 mb-2 small">
            <div class="text-muted">Weights come from the Job’s Pipeline page.</div>
          </div>
          <button type="submit" class="btn btn-sm btn-outline-primary w-100">Re-score</button>
        </form>
      </div>
    </div>

    @if (showSendOffer)
    {
      <button class="btn btn-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#offerModal">
        Send Offer
      </button>
    }
    @if (showHire)
    {
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="Hire" method="post" class="me-1">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@p.ApplicationId" />
        <button class="btn btn-success btn-sm" type="submit">Mark Hired</button>
      </form>
    }
    @if (showReject)
    {
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="Reject" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@p.ApplicationId" />
        <button class="btn btn-outline-danger btn-sm" type="submit">Reject</button>
      </form>
    }
  </div>
</div>

@if (TempData["Message"] != null)
{
  <div class="alert alert-info">@TempData["Message"]</div>
}

<div class="card mb-3">
  <div class="card-body">
    <h6 class="text-uppercase text-muted mb-2">Summary</h6>


    @* NEW: Candidate extra details from job_application *@
    <dl class="row mb-0">
      <dt class="col-sm-3">Description</dt>
      <dd class="col-sm-9">
        @(!string.IsNullOrWhiteSpace(candidateDesc) ? candidateDesc : "Not provided")
      </dd>

      <dt class="col-sm-3">Expected Salary</dt>
      <dd class="col-sm-9">
        @(expectedSalary.HasValue ? $"RM {expectedSalary.Value:N0}" : "Not provided")
      </dd>
    </dl>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h6 class="text-uppercase text-muted mb-3">Thread</h6>

    @if (notes.Count == 0)
    {
      <div class="text-muted">No messages yet.</div>
    }
    else
    {
      <div class="list-group">
        @foreach (var n in notes)
        {
          <div class="list-group-item">
            <div class="d-flex justify-content-between">
              <div>
                <strong>@n.Author</strong>
                <span class="text-muted">• @n.CreatedAt</span>
              </div>
              @if (n.FromRecruiter)
              {
                <span class="badge bg-primary">Recruiter</span>
              }
              else
              {

                <span class="badge bg-secondary">Candidate</span>
              }
            </div>
            <div class="mt-1" style="white-space:pre-line">@n.Text</div>
          </div>
        }
      </div>
    }

    <hr class="my-3" />

    <form asp-area="Recruiter" asp-controller="Candidates" asp-action="SendMessage" method="post">
      @Html.AntiForgeryToken()
      <input type="hidden" name="id" value="@p.ApplicationId" />
      <div class="input-group">
        <input class="form-control" name="text" placeholder="Write a quick note..." />
        <button class="btn btn-outline-primary" type="submit">Send</button>
      </div>
    </form>
  </div>
</div>

@* ================= Edit Parsed Resume Modal ================= *@
<div class="modal fade" id="parsedModal" tabindex="-1" aria-labelledby="parsedLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="parsedForm" method="post" asp-area="Recruiter" asp-controller="AiEvaluation" asp-action="EvaluateOne">
        @Html.AntiForgeryToken()
        <input type="hidden" name="applicationId" value="@p.ApplicationId" />
        <div class="modal-header">
          <h5 class="modal-title" id="parsedLabel">Parsed Resume (editable)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea id="parsedJson" name="resumeJsonOverride" class="form-control" rows="18"
            spellcheck="false"></textarea>
          <small class="text-muted">Keep the structure; fix only obvious mistakes (skills, highlights, degree).</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save & Re-score</button>
        </div>
      </form>
    </div>
  </div>
</div>

@* ================= Offer Modal (unchanged) ================= *@
<div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form asp-area="Recruiter" asp-controller="Candidates" asp-action="SendOffer" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-header">
          <h5 class="modal-title" id="offerModalLabel">Send Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" asp-for="@offerVm.ApplicationId" name="ApplicationId" value="@offerVm.ApplicationId" />

          <div class="mb-3">
            <label class="form-label">Salary Offer</label>
            <input type="number" step="0.01" class="form-control" name="SalaryOffer" />
          </div>

          <div class="mb-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" name="StartDate" />
          </div>

          <div class="mb-3">
            <label class="form-label">Contract Type</label>
            @{
              var selectedCt = offerVm?.ContractType ?? "";
              var contractItems = new List<SelectListItem>
                        {
                        new("Full Time", "Full Time", selectedCt == "Full Time"),
                        new("Part Time", "Part Time", selectedCt == "Part Time"),
                        new("Contract", "Contract", selectedCt == "Contract"),
                        new("Freelance", "Freelance", selectedCt == "Freelance"),
                        new("Internship", "Internship", selectedCt == "Internship"),
                        };
            }
            @Html.DropDownList("ContractType", contractItems, "Select contract type", new { @class = "form-select",
            required = "required" })
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" rows="3" name="Notes"
              placeholder="Add any special terms or instructions..."></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Offer</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    // Pull parsed JSON and open the editor modal
    async function openParsed(appId) {
      const res = await fetch(`@Url.Action("ParsedJson", "AiEvaluation", new { area = "Recruiter" })?applicationId=${appId}`, {
        headers: { 'Accept': 'application/json' }
      });
      const txt = await res.text();
      try {
        document.getElementById('parsedJson').value = JSON.stringify(JSON.parse(txt), null, 2);
      } catch { document.getElementById('parsedJson').value = txt; }
      const m = new bootstrap.Modal(document.getElementById('parsedModal'));
      m.show();
    }
  </script>
}