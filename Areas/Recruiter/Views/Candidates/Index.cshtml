@* ======================================================
   File: Areas/Recruiter/Views/Candidates/Index.cshtml
   ====================================================== *@
@model JobPortal.Areas.Recruiter.Models.CandidatesIndexVM
@{

    var q = Model.Query;
    var stage = Model.Stage;

    // --- Sorting state (ID ASC/DESC) ---
    var sort = string.IsNullOrWhiteSpace(Model.Sort) ? "id_desc" : Model.Sort;
    var idNext = sort == "id_desc" ? "id_asc" : "id_desc";
    var arrow = sort == "id_asc" ? "▲" : "▼";

    string RoutePreserve(int page) => Url.Action("Index", new
    {
        q = q,
        stage = stage,
        page = page,
        pageSize = Model.PageSize,
        sort = sort
    })!;
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<form method="get" class="row g-2 mb-3">
    <div class="col-md-6">
        <input type="text" name="q" value="@q" class="form-control" placeholder="Search name, email, job title..." />
    </div>
    <div class="col-md-3">
        <select class="form-select" name="stage">
            <option value="">All stages</option>
            @* MODIFIED: Removed "Hired" from this list as per requirement *@
            @foreach (var s in new[] { "Submitted", "AI-Screened", "Shortlisted", "Interview", "Offer", "Rejected" })
            {

                <option value="@s" selected="@(stage == s ? "selected" : null)">@s</option>
            }
        </select>
    </div>
    <div class="col-md-3 text-end">
        <button class="btn btn-primary" type="submit">Filter</button>
        <a asp-area="Recruiter" asp-controller="Candidates" asp-action="Index"
            class="btn btn-outline-secondary">Reset</a>
        <a asp-area="Recruiter" asp-controller="Candidates" asp-action="Export" asp-route-q="@q"
            asp-route-stage="@stage" class="btn btn-success">Export CSV</a>
    </div>
    @* Preserve current sort when filtering *@
    <input type="hidden" name="sort" value="@sort" />
</form>

<table class="table table-hover align-middle">
    <thead class="table-light">
        <tr>
            @* MODIFIED: ID sort toggle (cell-wide clickable, non-blue arrow) *@
            <th class="position-relative" style="width:90px;">
                <span>ID</span>
                <span class="ms-1">@arrow</span>
                <a class="stretched-link text-decoration-none" asp-area="Recruiter" asp-controller="Candidates"
                    asp-action="Index" asp-route-q="@q" asp-route-stage="@stage" asp-route-page="@Model.Page"
                    asp-route-pageSize="@Model.PageSize" asp-route-sort="@idNext" aria-label="Sort by ID"></a>
            </th>
            <th>Candidate</th>
            <th>Stage</th>
            <th>Score</th>
            <th>Applied</th>

            <th class="text-end">Action</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Items.Count == 0)
        {
            <tr>
                <td colspan="6" class="text-muted">No candidates found.</td>
            </tr>
        }

        else
        {
            foreach (var c in Model.Items)
            {
                <tr>
                    <td>@c.Id</td>
                    <td>

                        <div class="fw-semibold">@c.Name</div>
                        <div class="text-muted small">@c.AppliedAt</div>
                    </td>
                    <td>

                        <span class="badge bg-secondary">@c.Stage</span>
                        @if (c.Override)
                        {
                            <span class="badge bg-warning">Manual</span>

                        }
                        @if (c.LowConfidence)
                        {
                            <span class="badge bg-danger">Low confidence</span>

                        }
                    </td>
                    <td>@c.Score</td>
                    <td>@c.AppliedAt</td>
                    <td class="text-end">

                        <a asp-area="Recruiter" asp-controller="Candidates" asp-action="Detail" asp-route-id="@c.Id"
                            class="btn btn-sm btn-outline-primary">Open</a>

                        <form class="d-inline js-start-conv-form">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="ApplicationId" value="@c.Id" />
                            <button type="button" class="btn btn-sm btn-outline-secondary js-new-conv" data-app-id="@c.Id"
                                data-bs-toggle="tooltip" title="Start a new conversation with this candidate">
                                <span class="js-new-conv-text">New Conversation</span>
                                <span class="spinner-border spinner-border-sm ms-1 d-none js-new-conv-spin" role="status"
                                    aria-hidden="true"></span>
                            </button>
                        </form>



                    </td>
                </tr>

            }
        }
    </tbody>
</table>

<nav aria-label="paging">
    <ul class="pagination justify-content-end">
        <li
            class="page-item @(Model.Page <= 1 ?
                                                                                                                                    "disabled" : "")">
            <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(1))">First</a>
        </li>
        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
            <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(Model.Page - 1))">Prev</a>
        </li>

        @{
            var start = Math.Max(1,
            Model.Page - 2);
            var end = Math.Min(Model.TotalPages, Model.Page + 2);
            for (int p = start; p <= end; p++)
            {
                <li class="page-item @(p == Model.Page ? "active" : "")">
                    <a class="page-link" href="@RoutePreserve(p)">@p</a>

                </li>
            }
        }

        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
            <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.Page + 1))">Next</a>
        </li>
        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
            <a class="page-link"
                href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.TotalPages))">Last</a>
        </li>
    </ul>
</nav>

<div class="text-muted small">
    Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> • Total
    <strong>@Model.TotalCount</strong> candidates
</div>

<script>
    (function () {
        if (window.bootstrap) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
        }

        const createUrl = '@Url.Action("StartFromApplication", "Inbox", new { area = "Recruiter" })';
        const existsUrl = '@Url.Action("ExistsForApplication", "Inbox", new { area = "Recruiter" })';

        // PRE-CHECK: rename button to "Open Conversation" when a thread exists
        document.querySelectorAll('.js-new-conv').forEach(async (btn) => {
            const form = btn.closest('.js-start-conv-form');
            const appId = form.querySelector('input[name="ApplicationId"]').value;
            try {
                const r = await fetch(`${existsUrl}?applicationId=${encodeURIComponent(appId)}`, { headers: { 'Accept': 'application/json' } });
                const d = await r.json();
                if (d.exists) {
                    const t = btn.querySelector('.js-new-conv-text');
                    if (t) t.textContent = 'Open Conversation';
                    btn.title = 'Open existing conversation';
                    if (btn.getAttribute('data-bs-toggle') === 'tooltip' && window.bootstrap) {
                        const tip = bootstrap.Tooltip.getInstance(btn) || new bootstrap.Tooltip(btn);
                        btn.setAttribute('data-bs-original-title', btn.title);
                        tip.update();
                    }
                }
            } catch { }
        });



        document.querySelectorAll('.js-new-conv').forEach(btn => {
            btn.addEventListener('click', async () => {
                const form = btn.closest('.js-start-conv-form');
                const token = form.querySelector('input[name="__RequestVerificationToken"]').value;
                const appId = form.querySelector('input[name="ApplicationId"]').value;
                const spin = btn.querySelector('.js-new-conv-spin');
                const txt = btn.querySelector('.js-new-conv-text');

                btn.disabled = true; spin.classList.remove('d-none'); txt.textContent = 'Opening…';

                let exists = {};
                try {
                    const r = await fetch(`${existsUrl}?applicationId=${encodeURIComponent(appId)}`, { headers: { 'Accept': 'application/json' } });
                    exists = await r.json();
                } catch (_) { }

                if (exists.exists && exists.url) {
                    const t = btn.querySelector('.js-new-conv-text');
                    if (t) t.textContent = 'Open Conversation';
                    window.location.href = exists.url; // go straight to thread, same tab
                    return;
                }

                const body = new URLSearchParams({ ApplicationId: appId });
                try {
                    const r = await fetch(createUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': token
                        },
                        body
                    });
                    const data = await r.json();
                    if (data.ok && data.url) { window.location.href = data.url; return; }
                } catch (_) { }

                spin.classList.add('d-none'); txt.textContent = 'New Conversation'; btn.disabled = false;
            });
        });
    })();
</script>