@* File: Areas/Recruiter/Views/JobPostTemplates/Index.cshtml *@
@model JobPortal.Areas.Recruiter.Models.TemplatesIndexVM
@{
    var items = Model.Items;
    bool isArchived = Model.IsArchivedList;
    int? jobId = Model.ThreadId; // Using ThreadId to hold JobId from VM
    var q = Model.Query;

    // --- Sorting by ID (default: latest on top -> DESC) ---
    var order = (Context.Request.Query["order"].ToString() ?? "").ToLowerInvariant();
    bool asc = order == "asc";
    // Sort locally to avoid controller change
    items = (asc ? items.OrderBy(t => t.Id) : items.OrderByDescending(t => t.Id)).ToList();
    string NextOrder() => asc ? "desc" : "asc";
    string Arrow() => asc ? "▲" : "▼";

    string RoutePreserve(int page) => Url.Action(isArchived ? "Archived" : "Index", new
    {
        q = q,
        page = page,
        pageSize = Model.PageSize,
        jobId = jobId,
        order = order
    })!;
}

@* MODIFIED: Added Toast container for pop-up notifications *@
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="toast-notify" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message"></div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex gap-2">
        <a class="btn btn-primary" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Create">
            Create
        </a>

        @if (!isArchived)
        {
            <a class="btn btn-outline-secondary" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Archived">
                Archived
            </a>
        }
        else
        {
            <a class="btn btn-outline-secondary" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Index">
                Back to Active
            </a>
        }
    </div>
</div>

@* MODIFIED: Added Search Form *@
<form method="get" asp-action="@(isArchived ? "Archived" : "Index")" class="row g-2 mb-3">
    @if (jobId.HasValue)
    {
        <input type="hidden" name="jobId" value="@jobId" />
    }
    <input type="hidden" name="order" value="@order" />
    <div class="col-md-9">
        <input type="text" name="q" value="@q" class="form-control" placeholder="Search name or content..." />
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary" type="submit">Search</button>
        <a asp-controller="JobPostTemplates" asp-action="@(isArchived ? "Archived" : "Index")" asp-route-jobId="@jobId" class="btn btn-outline-secondary">Reset</a>
    </div>
</form>

@if (!items.Any())
{
    <div class="text-muted">No job templates found.</div>
}
else
{
    <div class="table-responsive">
        <table class="table align-middle jobtpl-table">
            <thead>
                <tr>
                    @* NEW: ID sortable with arrow *@
                    <th style="width:90px;">
                        <a asp-area="Recruiter"
                           asp-controller="JobPostTemplates"
                           asp-action="@(isArchived ? "Archived" : "Index")"
                           asp-route-q="@q"
                           asp-route-page="@Model.Page"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-jobId="@jobId"
                           asp-route-order="@NextOrder()"
                           class="text-decoration-none text-body" title="Toggle sort by ID">
                            <span class="me-1">ID</span>
                            <span class="small">@Arrow()</span>
                        </a>
                    </th>
                    <th style="width:26%">Name</th>
                    <th>Snippet</th>
                    <th class="text-end actions-col" style="width:360px">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in items)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.Name</td>
                        <td>@t.Snippet</td>

                        <td class="text-end actions-cell">
                            <div class="actions-toolbar">
                                @* Create a job directly from this template (no preview) *@
                                <a class="btn btn-success btn-sm"
                                   asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Fill"
                                   asp-route-id="@t.Id">Create from template</a>

                                <a class="btn btn-outline-secondary btn-sm"
                                   asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Preview"
                                   asp-route-id="@t.Id" asp-route-jobId="@jobId">Preview</a>

                                @if (!isArchived)
                                {
                                    <a class="btn btn-outline-secondary btn-sm"
                                       asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Edit"
                                       asp-route-id="@t.Id">Edit</a>

                                    <form method="post" class="d-inline"
                                          asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Archive"
                                          asp-route-id="@t.Id">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Archive</button>
                                    </form>
                                }
                                else
                                {
                                    <form method="post" class="d-inline"
                                          asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Unarchive"
                                          asp-route-id="@t.Id">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-success btn-sm">Unarchive</button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* MODIFIED: Added Pagination Controls *@
    <nav aria-label="paging">
        <ul class="pagination justify-content-end">
            <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(1))">First</a>
            </li>
            <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(Model.Page - 1))">Prev</a>
            </li>

            @{
                var start = Math.Max(1, Model.Page - 2);
                var end = Math.Min(Model.TotalPages, Model.Page + 2);
                for (int p = start; p <= end; p++)
                {
                    <li class="page-item @(p == Model.Page ? "active" : "")">
                        <a class="page-link" href="@RoutePreserve(p)">@p</a>
                    </li>
                }
            }

            <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.Page + 1))">Next</a>
            </li>
            <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.TotalPages))">Last</a>
            </li>
        </ul>
    </nav>

    <div class="text-muted small">
        Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> &bull; Total
        <strong>@Model.TotalCount</strong> templates
    </div>
}

@* MODIFIED: Added script for Toast pop-up *@
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var message = '@(TempData["Message"] as string)';
            if (message) {
                var toastEl = document.getElementById('toast-notify');
                var toastBody = document.getElementById('toast-message');
                toastBody.textContent = message;
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
    </script>
}
