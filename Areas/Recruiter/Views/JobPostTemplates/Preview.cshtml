@* ===============================================
   File: Areas/Recruiter/Views/JobPostTemplates/Preview.cshtml
   Side-by-side only when jobId>0; otherwise single-pane.
   =============================================== *@
@{
    int tplId = (int)ViewBag.TemplateId;
    string name = ViewBag.Name ?? "";

    // Use pattern match to read JobId safely
    int? jobId = ViewBag.JobId is int v ? v : (int?)null;
    bool hasJob = jobId.HasValue && jobId.Value > 0;

    // Template fields (aligned with job listing)
    string tTitle = ViewBag.Title ?? "";
    string tDesc = ViewBag.Description ?? "";
    string tMust = ViewBag.Must ?? "";
    string tNice = ViewBag.Nice ?? "";
    string tJobType = ViewBag.JobType ?? "Full Time";
    string tWorkMode = ViewBag.WorkMode ?? "On-site";
    string tJobCategory = ViewBag.JobCategory ?? "Marketing";
    decimal? tSmin = ViewBag.SalaryMin as decimal?;
    decimal? tSmax = ViewBag.SalaryMax as decimal?;
    DateTime? tDeadline = ViewBag.ExpiryDate as DateTime?;

    // Current job fields (for compare view)
    string cTitle = ViewBag.CurTitle ?? "";
    string cDesc = ViewBag.CurDescription ?? "";
    string cMust = ViewBag.CurMust ?? "";
    string cNice = ViewBag.CurNice ?? "";
    string cJobType = ViewBag.CurJobType ?? "";
    string cWorkMode = ViewBag.CurWorkMode ?? "";
    string cJobCategory = ViewBag.CurJobCategory ?? "";
    decimal? cSmin = ViewBag.CurSalaryMin as decimal?;
    decimal? cSmax = ViewBag.CurSalaryMax as decimal?;
    DateTime? cDeadline = ViewBag.CurExpiryDate as DateTime?;

    // Diffs
    bool diffTitle = hasJob && !string.Equals(cTitle, tTitle, StringComparison.Ordinal);
    bool diffDesc = hasJob && !string.Equals(cDesc, tDesc, StringComparison.Ordinal);
    bool diffMust = hasJob && !string.Equals(cMust, tMust, StringComparison.Ordinal);
    bool diffNice = hasJob && !string.Equals(cNice, tNice, StringComparison.Ordinal);
    bool diffType = hasJob && !string.Equals(cJobType, tJobType, StringComparison.Ordinal);
    bool diffMode = hasJob && !string.Equals(cWorkMode, tWorkMode, StringComparison.Ordinal);
    bool diffCat = hasJob && !string.Equals(cJobCategory, tJobCategory, StringComparison.Ordinal);
    bool diffSal = hasJob && (cSmin != tSmin || cSmax != tSmax);
    bool diffDead = hasJob && cDeadline != tDeadline;

    string SalaryText(decimal? mn, decimal? mx)
    => (mn.HasValue || mx.HasValue) ? $"{mn?.ToString("C0")} â€“ {mx?.ToString("C0")}" : "Not specified";
}

<a asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Index"
    class="d-inline-block text-decoration-none mb-3">
    &leftarrow; Back to JobPostTemplates
</a>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <div class="small text-muted">Template: <strong>@name</strong></div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Edit"
            asp-route-id="@tplId">Edit</a>

        @if (hasJob)
        {
            <a class="btn btn-primary" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Apply"
                asp-route-id="@tplId" asp-route-jobId="@jobId">Apply to this job</a>
        }
        else
        {
            <a class="btn btn-primary" asp-area="Recruiter" asp-controller="JobPostTemplates" asp-action="Apply"
                asp-route-id="@tplId" asp-route-jobId="0">Use this template</a>
        }
    </div>
</div>

@if (!hasJob)
{
    <div class="diff-card">
        <div class="diff-head d-flex justify-content-between">
            <span>Template Details</span>
        </div>
        <div class="field">
            <div class="field-label">JOB TITLE</div>
            <div>@tTitle</div>
        </div>
        <div class="field">
            <div class="field-label">JOB DESCRIPTION</div>
            <div>@tDesc</div>
        </div>
        <div class="field">
            <div class="field-label">MUST-HAVE</div>
            <div>@tMust</div>
        </div>
        <div class="field">
            <div class="field-label">NICE-TO-HAVE</div>
            <div>@tNice</div>
        </div>

        <div class="field">
            <div class="field-label">EMPLOYMENT TYPE</div>
            <div>@tJobType</div>
        </div>
        <div class="field">
            <div class="field-label">WORK MODE</div>
            <div>@tWorkMode</div>
        </div>
        <div class="field">
            <div class="field-label">JOB CATEGORY</div>
            <div>@tJobCategory</div>
        </div>
        <div class="field">
            <div class="field-label">SALARY RANGE</div>
            <div>@SalaryText(tSmin, tSmax)</div>
        </div>
        <div class="field">
            <div class="field-label">APPLICATION DEADLINE</div>
            <div>@(tDeadline.HasValue? tDeadline.Value.ToString("yyyy-MM-dd") : "None")</div>
        </div>
    </div>
}
else
{
    <div class="diff-grid">
        <div class="diff-card">
            <div class="diff-head d-flex justify-content-between">
                <span>Current Job</span>
            </div>

            <div class="field @(diffTitle ? "changed" : "")">
                <div class="field-label">TITLE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cTitle</div>
                    @if (diffTitle)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffDesc ? "changed" : "")">
                <div class="field-label">DESCRIPTION</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cDesc</div>
                    @if (diffDesc)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffMust ? "changed" : "")">
                <div class="field-label">MUST-HAVE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cMust</div>
                    @if (diffMust)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffNice ? "changed" : "")">
                <div class="field-label">NICE-TO-HAVE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cNice</div>
                    @if (diffNice)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffType ? "changed" : "")">
                <div class="field-label">EMPLOYMENT TYPE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cJobType</div>
                    @if (diffType)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffMode ? "changed" : "")">
                <div class="field-label">WORK MODE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cWorkMode</div>
                    @if (diffMode)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffCat ? "changed" : "")">
                <div class="field-label">JOB CATEGORY</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@cJobCategory</div>
                    @if (diffCat)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffSal ? "changed" : "")">
                <div class="field-label">SALARY RANGE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@SalaryText(cSmin, cSmax)</div>
                    @if (diffSal)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="field @(diffDead ? "changed" : "")">
                <div class="field-label">APPLICATION DEADLINE</div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>@(cDeadline.HasValue? cDeadline.Value.ToString("yyyy-MM-dd") : "None")</div>
                    @if (diffDead)
                    {
                        <span class="badge rounded-pill text-bg-warning">WILL CHANGE</span>
                    }
                </div>
            </div>

            <div class="small text-muted mt-2">Highlighted sections indicate values that will change if you apply the
                template.</div>
        </div>

        <div class="diff-card">
            <div class="diff-head d-flex justify-content-between">
                <span>Template</span>
            </div>
            <div class="field changed">
                <div class="field-label">TITLE</div>
                <div>@tTitle</div>
            </div>
            <div class="field changed">
                <div class="field-label">DESCRIPTION</div>
                <div>@tDesc</div>
            </div>
            <div class="field changed">
                <div class="field-label">MUST-HAVE</div>
                <div>@tMust</div>
            </div>
            <div class="field changed">
                <div class="field-label">NICE-TO-HAVE</div>
                <div>@tNice</div>
            </div>
            <div class="field changed">
                <div class="field-label">EMPLOYMENT TYPE</div>
                <div>@tJobType</div>
            </div>
            <div class="field changed">
                <div class="field-label">WORK MODE</div>
                <div>@tWorkMode</div>
            </div>
            <div class="field changed">
                <div class="field-label">JOB CATEGORY</div>
                <div>@tJobCategory</div>
            </div>
            <div class="field changed">
                <div class="field-label">SALARY RANGE</div>
                <div>@SalaryText(tSmin, tSmax)</div>
            </div>
            <div class="field changed">
                <div class="field-label">APPLICATION DEADLINE</div>
                <div>@(tDeadline.HasValue? tDeadline.Value.ToString("yyyy-MM-dd") : "None")</div>
            </div>
        </div>
    </div>
}