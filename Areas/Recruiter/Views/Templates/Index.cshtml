@model JobPortal.Areas.Recruiter.Models.TemplatesIndexVM
@{
  bool isArchived = Model.IsArchivedList;
  bool isJobPost = Model.IsJobPost;
  int? threadId = Model.ThreadId;
  var q = Model.Query;

  // read values passed from Thread (if any)
  var qFirst = Context.Request.Query["firstName"].ToString();
  var qJob = Context.Request.Query["jobTitle"].ToString();
  var pageTitle = isJobPost
  ? (isArchived ? "Archived Job Post Templates" : "Job Post Templates")
  : (isArchived ? "Archived Templates" : "Message Templates");

  // Helper for pagination links
  string RoutePreserve(int page) => Url.Action(isArchived ? "Archived" : "Index", new
  {
    q = q,
    page = page,
    pageSize = Model.PageSize,
    threadId = threadId
  })!;
}

@* MODIFIED: Added Toast container for pop-up notifications *@
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-notify" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-message">
    </div>
  </div>
</div>


<h3 class="mb-3">@pageTitle</h3>

<div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
  @if (!isArchived)
  {
    <a class="btn btn-primary" asp-area="Recruiter" asp-controller="@(isJobPost ? "JobPostTemplates" : "Templates")"
      asp-action="Create">Create</a>

    <a class="btn btn-outline-secondary" asp-area="Recruiter"
      asp-controller="@(isJobPost ? "JobPostTemplates" : "Templates")" asp-action="Archived">Archived</a>

    <div class="vr mx-1 d-none d-sm-block"></div>

    <button type="button" class="btn btn-outline-primary" id="btnMarkFav" title="Mark selected templates as favourite">
      Mark as favourite
    </button>
    <button type="button" class="btn btn-outline-secondary" id="btnUnmarkFav" title="Remove favourite from selected">
      Unmark favourite
    </button>
  }
  else
  {
    <a class="btn btn-outline-secondary" asp-area="Recruiter"
      asp-controller="@(isJobPost ? "JobPostTemplates" : "Templates")" asp-action="Index">Back to Active</a>
  }
</div>

@* MODIFIED: Added Search Form *@
<form method="get" asp-action="@(isArchived ? "Archived" : "Index")" class="row g-2 mb-3">
  @if (threadId.HasValue)
  {
    <input type="hidden" name="threadId" value="@threadId" />
  }
  <div class="col-md-9">
    <input type="text" name="q" value="@q" class="form-control" placeholder="Search name, subject, body..." />
  </div>
  <div class="col-md-3">
    <button class="btn btn-primary" type="submit">Search</button>
    <a asp-controller="Templates" asp-action="@(isArchived ? "Archived" : "Index")" asp-route-threadId="@threadId"
      class="btn btn-outline-secondary">Reset</a>
  </div>
</form>

@if (Model.Items.Count == 0)
{
  <div class="text-muted">No templates found.</div>
}
else
{
  <div class="table-responsive">
    <table class="table align-middle" id="tplTable">
      <thead>
        <tr>
          <th style="width:34px">
            <input type="checkbox" id="chkAll" title="Select all" />
          </th>
          <th style="width:26%">Name</th>
          <th style="width:24%">Subject</th>
          <th>Snippet</th>
          <th class="text-end" style="width:230px">Actions</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var t in Model.Items)
        {
          <tr data-tpl-id="@t.Id">
            <td>
              <input type="checkbox" class="form-check-input fav-check" data-id="@t.Id"
                aria-label="select template @t.Name" />
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <span class="fav-indicator badge bg-light text-muted d-none">Favourite</span>
                <span>@t.Name</span>
              </div>
            </td>
            <td>@t.Subject</td>
            <td>@t.Snippet</td>
            <td class="text-end">
              @* Only Message templates (not JobPost), only when threadId is present, only on Active list *@
              @if (!isJobPost && threadId.HasValue && !isArchived)
              {
                <a class="btn btn-outline-primary btn-sm me-1" asp-area="Recruiter" asp-controller="Templates"
                  asp-action="Fill" asp-route-id="@t.Id" asp-route-threadId="@threadId" asp-route-firstName="@qFirst"
                  asp-route-jobTitle="@qJob">Use</a>
              }

              @if (!isArchived)
              {
                <a class="btn btn-outline-secondary btn-sm me-1" asp-area="Recruiter"
                  asp-controller="@(isJobPost ? "JobPostTemplates" : "Templates")" asp-action="Edit"
                  asp-route-id="@t.Id">Edit</a>

                <form method="post" class="d-inline" asp-area="Recruiter"
                  asp-controller="@(isJobPost ? "JobPostTemplates" : "Templates")" asp-action="Archive" asp-route-id="@t.Id">
                  @Html.AntiForgeryToken()
                  <button type="submit" class="btn btn-outline-danger btn-sm">Archive</button>
                </form>
              }
              else
              {
                <form method="post" class="d-inline" asp-area="Recruiter"
                  asp-controller="@(isJobPost ? "JobPostTemplates" : "Templates")" asp-action="Unarchive"
                  asp-route-id="@t.Id">
                  @Html.AntiForgeryToken()
                  <button type="submit" class="btn btn-outline-success btn-sm">Unarchive</button>
                </form>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @* MODIFIED: Added Pagination Controls *@
  <nav aria-label="paging">
    <ul class="pagination justify-content-end">
      <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
        <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(1))">First</a>
      </li>
      <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
        <a class="page-link" href="@(Model.Page <= 1 ? "#" : RoutePreserve(Model.Page - 1))">Prev</a>
      </li>

      @{
        var start = Math.Max(1, Model.Page - 2);
        var end = Math.Min(Model.TotalPages, Model.Page + 2);
        for (int p = start; p <= end; p++)
        {
          <li class="page-item @(p == Model.Page ? "active" : "")">
            <a class="page-link" href="@RoutePreserve(p)">@p</a>
          </li>
        }
      }

      <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
        <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.Page + 1))">Next</a>
      </li>
      <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
        <a class="page-link" href="@(Model.Page >= Model.TotalPages ? "#" : RoutePreserve(Model.TotalPages))">Last</a>
      </li>
    </ul>
  </nav>

  <div class="text-muted small">
    Showing page <strong>@Model.Page</strong> of <strong>@Model.TotalPages</strong> &bull; Total
    <strong>@Model.TotalCount</strong> templates
  </div>
}

@section Scripts {
  <script>
    // MODIFIED: Added script for Toast pop-up
    document.addEventListener("DOMContentLoaded", function () {
      // Check for TempData message
      var message = '@(TempData["Message"] as string)';
      if (message) {
        // Get toast elements
        var toastEl = document.getElementById('toast-notify');
        var toastBody = document.getElementById('toast-message');

        // Set message and show toast
        toastBody.textContent = message;
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
      }
    });
  </script>
  <script>
    // Client-side favourites using localStorage.
    // WHY: quick UX without DB changes.
    (function () {
      const KEY = 'favTemplates';
      const table = document.getElementById('tplTable');
      if (!table) return;
      const body = table.querySelector('tbody');
      const chkAll = document.getElementById('chkAll');
      const btnMark = document.getElementById('btnMarkFav');
      const btnUnmark = document.getElementById('btnUnmarkFav');

      function getFavs() {
        try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; }
      }
      function setFavs(arr) {
        localStorage.setItem(KEY, JSON.stringify(arr));
      }
      function setFav(id, fav) {
        const list = getFavs();
        const idx = list.indexOf(id);
        if (fav && idx < 0) list.push(id);
        if (!fav && idx >= 0) list.splice(idx, 1);
        setFavs(list);
      }
      function isFav(id) { return getFavs().includes(id); }

      function applyFavUI() {
        body.querySelectorAll('tr').forEach(tr => {
          const id = parseInt(tr.getAttribute('data-tpl-id'));
          const ind = tr.querySelector('.fav-indicator');
          if (!ind) return;
          const fav = isFav(id);
          ind.classList.toggle('d-none', !fav);
          tr.classList.toggle('table-warning', fav);
          // keep checkbox checked state independent; it's for bulk actions
        });
      }

      function reorder() {
        const rows = Array.from(body.querySelectorAll('tr'));
        const favs = getFavs();
        rows.sort((a, b) => {
          const ida = parseInt(a.getAttribute('data-tpl-id'));
          const idb = parseInt(b.getAttribute('data-tpl-id'));
          const af = favs.includes(ida) ? 1 : 0;
          const bf = favs.includes(idb) ? 1 : 0;
          if (af !== bf) return bf - af; // favourites first
          return 0;
        });
        rows.forEach(r => body.appendChild(r));
      }

      function selectedIds() {
        return Array.from(body.querySelectorAll('.fav-check:checked')).map(i => parseInt(i.getAttribute('data-id')));
      }

      // Bulk mark/unmark
      if (btnMark) btnMark.addEventListener('click', () => {
        const ids = selectedIds();
        ids.forEach(id => setFav(id, true));
        applyFavUI(); reorder();
      });
      if (btnUnmark) btnUnmark.addEventListener('click', () => {
        const ids = selectedIds();
        ids.forEach(id => setFav(id, false));
        applyFavUI(); reorder();
      });
      // Select all checkbox
      if (chkAll) chkAll.addEventListener('change', () => {
        const checked = chkAll.checked;
        body.querySelectorAll('.fav-check').forEach(cb => cb.checked = checked);
      });
      // Init
      document.addEventListener('DOMContentLoaded', () => {
        applyFavUI();
        reorder();
      });
    })();
  </script>
}