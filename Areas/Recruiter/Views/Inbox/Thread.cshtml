@* ============================================
   File: Areas/Recruiter/Views/Inbox/Thread.cshtml
   CHANGES: add warning div + JS to intercept submit and call /Recruiter/Inbox/Moderate
   ============================================ *@
@{
  ViewData["Title"] = ViewData["Title"] ?? "Thread";
  var messages = (IEnumerable<JobPortal.Areas.Recruiter.Models.NoteVM>)ViewBag.Messages;
  var threadId = (int)ViewBag.ThreadId;
  string otherFirst = ViewBag.OtherUserFirst ?? "there";
  string jobTitle = ViewBag.JobTitle ?? "";
  string recruiterName = ViewBag.RecruiterNameFirst ?? "";
  string company = ViewBag.Company ?? "";
  string? draft = ViewBag.Draft as string;

  bool isBlocked = false;
  try { isBlocked = (bool)(ViewBag.IsBlocked ?? false); } catch { isBlocked = false; }
  string blockedReason = (string)(ViewBag.BlockedReason ?? "");
}

<div class="d-flex justify-content-between align-items-center mb-3">
  <a asp-area="Recruiter" asp-controller="Inbox" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
    &leftarrow; Back to Inbox
  </a>
  <a class="btn btn-outline-secondary"
    href="@(Url.Action("Index", "Templates", new { area = "Recruiter", threadId = threadId, firstName = otherFirst, jobTitle = jobTitle }))">
    Open Templates
  </a>
</div>

@if (isBlocked)
{
  <div class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="bi bi-shield-exclamation me-2"></i>
    <div>
      <strong>Chat is blocked by admin.</strong>
      @if (!string.IsNullOrWhiteSpace(blockedReason))
      {
        <span class="ms-1">@blockedReason</span>
      }
    </div>
  </div>
}

<div id="aiWarn" class="alert alert-warning d-none" role="alert"></div> @* NEW: AI policy warning *@

<div class="card mb-3">
  <div class="card-header">Conversation with @ViewBag.OtherUser</div>
  <div class="card-body">
    @foreach (var m in messages)
    {
      <div class="mb-3 @(m.FromRecruiter ? "text-end" : "text-start")">
        <div class="d-inline-block border rounded p-2">
          <div class="small text-muted">@m.Author • @m.CreatedAt</div>
          <div>@m.Text</div>
        </div>
      </div>
    }
  </div>
</div>

<form asp-action="Send" asp-controller="Inbox" asp-area="Recruiter" method="post" class="card" id="sendForm">
  @Html.AntiForgeryToken()
  <input type="hidden" name="id" value="@threadId" />
  <div id="token-helper" class="card-header d-none">
    <div class="row g-2 align-items-end" id="token-fields">
      <div class="col-auto">
        <span class="small text-muted">Placeholders detected. Fill to auto-merge.</span>
      </div>
    </div>
  </div>
  <div class="card-body">
    <textarea name="text" id="composer" class="form-control" rows="3"
      placeholder="@(isBlocked ? "Chat is blocked by admin." : "Type a message…")" @(isBlocked ? "readonly disabled" :
      "")>@(isBlocked ? "" : draft)</textarea>
  </div>
  <div class="card-footer d-flex justify-content-end gap-2">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#saveTplModal">
      Save as Template
    </button>
    <button class="btn btn-primary" type="submit" @(isBlocked ? "disabled aria-disabled=\"true\"" : "")>Send</button>
  </div>
</form>

<!-- (modal markup unchanged) -->

@section Scripts {
  <script>
    (function () {
      const composer = document.getElementById('composer');
      const helper = document.getElementById('token-helper');
      const fields = document.getElementById('token-fields');
      const sendForm = document.getElementById('sendForm');
      const aiWarn = document.getElementById('aiWarn');

      const ctx = {
        FirstName: '@otherFirst',
        JobTitle: '@jobTitle',
        RecruiterName: '@recruiterName',
        Company: '@company'
      };

      const IS_BLOCKED = @(isBlocked ? "true" : "false");

      function replaceAllCaseInsensitive(s, find, repl) {
        const esc = find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return s.replace(new RegExp(esc, 'ig'), repl);
      }

      function ensureFriendlyDefaults() {
        if (IS_BLOCKED === true || IS_BLOCKED === 'true') return;
        let v = composer.value || '';
        if (/hi\s+user/i.test(v)) v = v.replace(/hi\s+user/ig, 'Hi ' + ctx.FirstName);
        v = replaceAllCaseInsensitive(v, '{{FirstName}}', ctx.FirstName);
        v = replaceAllCaseInsensitive(v, '{{JobTitle}}', ctx.JobTitle);
        v = replaceAllCaseInsensitive(v, '{{RecruiterName}}', ctx.RecruiterName);
        v = replaceAllCaseInsensitive(v, '{{Company}}', ctx.Company);
        composer.value = v;
      }

      function scanTokens() {
        if (IS_BLOCKED === true || IS_BLOCKED === 'true') { helper.classList.add('d-none'); return; }
        const v = composer.value || '';
        const re = /\{\{\s*([A-Za-z0-9_]+)\s*\}\}/g;
        const found = new Set();
        let m;
        while ((m = re.exec(v)) !== null) found.add(m[1]);

        fields.innerHTML = '<div class="col-auto"><span class="small text-muted">Placeholders detected. Fill to auto-merge.</span></div>';

        const needs = Array.from(found);
        const visible = needs.length > 0;
        helper.classList.toggle('d-none', !visible);
        if (!visible) return;

        needs.forEach(tok => {
          if (['FirstName', 'JobTitle', 'RecruiterName', 'Company'].includes(tok)) {
            const hint = document.createElement('div');
            hint.className = 'col-auto';
            hint.innerHTML = `<span class="badge bg-light text-dark"> ${tok}: ${ctx[tok] || '(auto)'} </span>`;
            fields.appendChild(hint);
            return;
          }
          const col = document.createElement('div');
          col.className = 'col-auto';
          let inputType = 'text';
          if (tok.toLowerCase() === 'date' || tok.toLowerCase() === 'duedate') inputType = 'date';
          else if (tok.toLowerCase() === 'time') inputType = 'time';
          col.innerHTML = `
                <label class="form-label mb-0 small">${tok}</label>
                <input class="form-control form-control-sm" type="${inputType}" name="tokens[${tok}]" />
              `;
          fields.appendChild(col);
        });
      }

      async function moderateText() {
        // why: pass anti-forgery header for JSON AJAX
        const tokenInput = sendForm.querySelector('input[name="__RequestVerificationToken"]');
        const token = tokenInput ? tokenInput.value : '';

        const payload = {
          threadId: @threadId,
          text: composer.value || ''
        };

        const resp = await fetch('@Url.Action("Moderate", "Inbox", new { area = "Recruiter" })', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': token
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          return { allowed: true, reason: 'AI check unavailable.' }; // fail open
        }
        return await resp.json();
      }

      // Intercept send
      sendForm.addEventListener('submit', async function (e) {
        if (@(isBlocked ? "true" : "false")) return;
        e.preventDefault();

        aiWarn.classList.add('d-none');
        aiWarn.textContent = '';

        const txt = (composer.value || '').trim();
        if (!txt) {
          aiWarn.textContent = 'Message is empty.';
          aiWarn.classList.remove('d-none');
          composer.focus();
          return;
        }

        try {
          const result = await moderateText();
          if (result && result.allowed === false) {
            const cat = result.category ? ` <span class="badge bg-warning text-dark ms-2">Violation: ${result.category}</span>` : '';
            aiWarn.innerHTML = `<strong>Message blocked by policy:</strong> ${result.reason || 'Not allowed.'}${cat}`;
            aiWarn.classList.remove('d-none');
            composer.focus();
            return; // block send
          }
        } catch { /* fail open */ }

        sendForm.removeEventListener('submit', arguments.callee);
        sendForm.submit();
      });

      function init() {
        ensureFriendlyDefaults();
        scanTokens();

        const quickSaveForm = document.getElementById('quickSaveForm');
        const quickSaveBody = document.getElementById('quickSaveBody');
        const useNowField = document.getElementById('quickSaveUseNow');

        function prepForm(useNow) {
          quickSaveBody.value = composer.value || '';
          useNowField.value = useNow ? 'true' : 'false';
        }

        const btnSaveOnly = document.getElementById('btnSaveOnly');
        const btnSaveUse = document.getElementById('btnSaveUse');
        if (btnSaveOnly) btnSaveOnly.addEventListener('click', function () { prepForm(false); });
        if (btnSaveUse) btnSaveUse.addEventListener('click', function () { prepForm(true); });
      }

      composer.addEventListener('input', scanTokens);
      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
}