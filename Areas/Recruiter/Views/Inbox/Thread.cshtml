@* ============================================
   File: Areas/Recruiter/Views/Inbox/Thread.cshtml
   CHANGES:
   - Wire "Save as Template" button directly to Templates/QuickSave
   - Keep AI moderation + AJAX send
   ============================================ *@
@{
  ViewData["Title"] = ViewData["Title"] ?? "Thread";
  var messages = (IEnumerable<JobPortal.Areas.Recruiter.Models.NoteVM>)ViewBag.Messages;
  var threadId = (int)ViewBag.ThreadId;
  string otherFirst = ViewBag.OtherUserFirst ?? "there";
  string jobTitle = ViewBag.JobTitle ?? "";
  string recruiterName = ViewBag.RecruiterNameFirst ?? "";
  string company = ViewBag.Company ?? "";
  string? draft = ViewBag.Draft as string;

  bool isBlocked = false;
  try { isBlocked = (bool)(ViewBag.IsBlocked ?? false); } catch { isBlocked = false; }
  string blockedReason = (string)(ViewBag.BlockedReason ?? "");
}

<div class="d-flex justify-content-between align-items-center mb-3">
  <a asp-area="Recruiter" asp-controller="Inbox" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
    &leftarrow; Back to Inbox
  </a>
  <a class="btn btn-outline-secondary"
     href="@(Url.Action("Index", "Templates", new { area = "Recruiter", threadId = threadId, firstName = otherFirst, jobTitle = jobTitle }))">
    Open Templates
  </a>
</div>

@if (isBlocked)
{
  <div class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="bi bi-shield-exclamation me-2"></i>
    <div>
      <strong>Chat is blocked by admin.</strong>
      @if (!string.IsNullOrWhiteSpace(blockedReason))
      {
        <span class="ms-1">@blockedReason</span>
      }
    </div>
  </div>
}

<div id="aiWarn" class="alert alert-warning d-none" role="alert"></div> @* NEW: AI policy warning *@

<div class="card mb-3">
  <div class="card-header">Conversation with @ViewBag.OtherUser</div>
  <div class="card-body">
    @foreach (var m in messages)
    {
      <div class="mb-3 @(m.FromRecruiter ? "text-end" : "text-start")">
        <div class="d-inline-block border rounded p-2">
          <div class="small text-muted">@m.Author • @m.CreatedAt</div>
          <div>@m.Text</div>
        </div>
      </div>
    }
  </div>
</div>

<form asp-action="Send" asp-controller="Inbox" asp-area="Recruiter" method="post" class="card" id="sendForm">
  @Html.AntiForgeryToken()
  <input type="hidden" name="id" value="@threadId" />
  <div id="token-helper" class="card-header d-none">
    <div class="row g-2 align-items-end" id="token-fields">
      <div class="col-auto">
        <span class="small text-muted">Placeholders detected. Fill to auto-merge.</span>
      </div>
    </div>
  </div>
  <div class="card-body">
    <textarea name="text" id="composer" class="form-control" rows="3"
              placeholder="@(isBlocked ? "Chat is blocked by admin." : "Type a message…")"
              @(isBlocked ? "readonly disabled" : "")>
@(isBlocked ? "" : draft)
    </textarea>
  </div>
  <div class="card-footer d-flex justify-content-end align-items-center gap-2">
    @* CHANGED: Simple button with id; no modal attributes *@
    <button id="btnSaveTemplate" class="btn btn-outline-secondary" type="button">
      Save as Template
    </button>

    <span id="sendStatus" class="small text-muted d-none me-2">Sending…</span>

    <button id="sendBtn" class="btn btn-primary" type="submit" @(isBlocked ? "disabled aria-disabled=\"true\"" : "")>
      <span class="js-send-text">Send</span>
      <span class="spinner-border spinner-border-sm ms-1 d-none js-send-spin" role="status" aria-hidden="true"></span>
    </button>
  </div>
</form>

@* (no modal needed anymore for quick save) *@

@section Scripts {
  <script>
    (function () {
      const composer = document.getElementById('composer');
      const helper = document.getElementById('token-helper');
      const fields = document.getElementById('token-fields');
      const sendForm = document.getElementById('sendForm');
      const aiWarn = document.getElementById('aiWarn');
      const sendBtn = document.getElementById('sendBtn');
      const sendSpin = sendBtn ? sendBtn.querySelector('.js-send-spin') : null;
      const sendTxt = sendBtn ? sendBtn.querySelector('.js-send-text') : null;
      const sendStatus = document.getElementById('sendStatus');
      const btnSaveTemplate = document.getElementById('btnSaveTemplate');

      const ctx = {
        FirstName: '@otherFirst',
        JobTitle: '@jobTitle',
        RecruiterName: '@recruiterName',
        Company: '@company'
      };

      const IS_BLOCKED = @(isBlocked ? "true" : "false");

      function replaceAllCaseInsensitive(s, find, repl) {
        const esc = find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return s.replace(new RegExp(esc, 'ig'), repl);
      }

      function ensureFriendlyDefaults() {
        if (IS_BLOCKED === true || IS_BLOCKED === 'true') return;
        let v = composer.value || '';
        if (/hi\s+user/i.test(v)) v = v.replace(/hi\s+user/ig, 'Hi ' + ctx.FirstName);
        v = replaceAllCaseInsensitive(v, '{{FirstName}}', ctx.FirstName);
        v = replaceAllCaseInsensitive(v, '{{JobTitle}}', ctx.JobTitle);
        v = replaceAllCaseInsensitive(v, '{{RecruiterName}}', ctx.RecruiterName);
        v = replaceAllCaseInsensitive(v, '{{Company}}', ctx.Company);
        composer.value = v;
      }

      function scanTokens() {
        if (IS_BLOCKED === true || IS_BLOCKED === 'true') {
          helper.classList.add('d-none');
          return;
        }
        const v = composer.value || '';
        const re = /\{\{\s*([A-Za-z0-9_]+)\s*\}\}/g;
        const found = new Set();
        let m;
        while ((m = re.exec(v)) !== null) found.add(m[1]);

        fields.innerHTML = '<div class="col-auto"><span class="small text-muted">Placeholders detected. Fill to auto-merge.</span></div>';

        const needs = Array.from(found);
        const visible = needs.length > 0;
        helper.classList.toggle('d-none', !visible);
        if (!visible) return;

        needs.forEach(tok => {
          if (['FirstName', 'JobTitle', 'RecruiterName', 'Company'].includes(tok)) {
            const hint = document.createElement('div');
            hint.className = 'col-auto';
            hint.innerHTML = `<span class="badge bg-light text-dark"> ${tok}: ${ctx[tok] || '(auto)'} </span>`;
            fields.appendChild(hint);
            return;
          }
          const col = document.createElement('div');
          col.className = 'col-auto';
          let inputType = 'text';
          if (tok.toLowerCase() === 'date' || tok.toLowerCase() === 'duedate') inputType = 'date';
          else if (tok.toLowerCase() === 'time') inputType = 'time';
          col.innerHTML = `
            <label class="form-label mb-0 small">${tok}</label>
            <input class="form-control form-control-sm" type="${inputType}" name="tokens[${tok}]" />
          `;
          fields.appendChild(col);
        });
      }

      async function moderateText() {
        const tokenInput = sendForm.querySelector('input[name="__RequestVerificationToken"]');
        const token = tokenInput ? tokenInput.value : '';

        const payload = {
          threadId: @threadId,
          text: composer.value || ''
        };

        const resp = await fetch('@Url.Action("Moderate", "Inbox", new { area = "Recruiter" })', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': token
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          return { allowed: true, reason: 'AI check unavailable.' }; // fail open
        }
        return await resp.json();
      }

      // ===== Send message (AI moderation + AJAX) =====
      sendForm.addEventListener('submit', async function (e) {
        if (@(isBlocked ? "true" : "false")) return;
        e.preventDefault();

        aiWarn.classList.add('d-none');
        aiWarn.textContent = '';

        const txt = (composer.value || '').trim();
        if (!txt) {
          aiWarn.textContent = 'Message is empty.';
          aiWarn.classList.remove('d-none');
          composer.focus();
          return;
        }

        if (sendBtn) sendBtn.disabled = true;
        if (sendSpin) sendSpin.classList.remove('d-none');
        if (sendTxt) sendTxt.textContent = 'Sending';
        if (sendStatus) {
          sendStatus.classList.remove('d-none', 'text-success');
          sendStatus.classList.add('text-muted');
          sendStatus.textContent = 'Checking…';
        }

        try {
          const result = await moderateText();
          if (result && result.allowed === false) {
            const cat = result.category
              ? ` <span class="badge bg-warning text-dark ms-2">Violation: ${result.category}</span>` : '';
            aiWarn.innerHTML = `<strong>Message blocked by policy:</strong> ${result.reason || 'Not allowed.'}${cat}`;
            aiWarn.classList.remove('d-none');

            if (sendSpin) sendSpin.classList.add('d-none');
            if (sendTxt) sendTxt.textContent = 'Send';
            if (sendBtn) sendBtn.disabled = false;
            if (sendStatus) {
              sendStatus.textContent = 'Blocked';
              sendStatus.classList.remove('text-muted');
              sendStatus.classList.add('text-danger');
              setTimeout(() => sendStatus.classList.add('d-none'), 2000);
            }
            composer.focus();
            return;
          }
        } catch { /* fail-open */ }

        if (sendStatus) sendStatus.textContent = 'Sending…';

        try {
          const formData = new FormData(sendForm);
          const body = new URLSearchParams(formData);

          const resp = await fetch('@Url.Action("Send", "Inbox", new { area = "Recruiter" })', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body
          });

          let ok = false;
          try {
            const data = await resp.json();
            ok = !!data.ok;
          } catch {
            ok = resp.ok;
          }

          if (ok) {
            if (sendStatus) {
              sendStatus.textContent = 'Delivered';
              sendStatus.classList.remove('text-muted');
              sendStatus.classList.add('text-success');
            }
            setTimeout(() => { window.location.reload(); }, 150);
          } else {
            if (sendStatus) {
              sendStatus.textContent = 'Failed to send';
              sendStatus.classList.remove('text-muted');
              sendStatus.classList.add('text-danger');
            }
          }
        } catch {
          if (sendStatus) {
            sendStatus.textContent = 'Failed to send';
            sendStatus.classList.remove('text-muted');
            sendStatus.classList.add('text-danger');
          }
        } finally {
          if (sendSpin) sendSpin.classList.add('d-none');
          if (sendTxt) sendTxt.textContent = 'Send';
          if (sendBtn) sendBtn.disabled = false;
          if (sendStatus) setTimeout(() => sendStatus.classList.add('d-none'), 1800);
        }
      });

      // ===== Quick Save as Template (no modal) =====
      if (btnSaveTemplate) {
        btnSaveTemplate.addEventListener('click', async function () {
          if (IS_BLOCKED === true || IS_BLOCKED === 'true') return;

          const bodyText = (composer.value || '').trim();
          if (!bodyText) {
            alert('Type a message first before saving it as a template.');
            composer.focus();
            return;
          }

          const name = prompt('Template name:', '');
          if (!name) {
            return; // cancelled
          }

          const tokenInput = sendForm.querySelector('input[name="__RequestVerificationToken"]');
          const token = tokenInput ? tokenInput.value : '';

          const payload = new URLSearchParams();
          payload.append('name', name);
          payload.append('subject', '');
          payload.append('body', bodyText);
          payload.append('threadId', '@threadId');
          payload.append('useNow', 'false');

          try {
            const resp = await fetch('@Url.Action("QuickSave", "Templates", new { area = "Recruiter" })', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                'RequestVerificationToken': token
              },
              body: payload.toString()
            });

            if (resp.ok) {
              alert('Template saved. You can find it on the Templates page.');
            } else {
              alert('Failed to save template.');
            }
          } catch {
            alert('Failed to save template.');
          }
        });
      }

      function init() {
        ensureFriendlyDefaults();
        scanTokens();
      }

      composer.addEventListener('input', scanTokens);
      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
}
