@* File: Areas/Admin/Views/Dashboard/Index.cshtml *@
@model JobPortal.Areas.Admin.Models.DashboardViewModel

@{
  ViewData["Title"] = "Admin Dashboard";

  string ChipClass(string status) => status switch
  {
    "Approved" => "badge text-bg-success",
    "Rejected" => "badge text-bg-danger",
    "ChangesRequested" => "badge text-bg-warning",
    "Pending" => "badge text-bg-secondary",
    _ => "badge text-bg-light"
  };

  /* --- Sparkline prep --- */
  var data = Model.ApplicationsSparkline?.ToArray() ?? Array.Empty<int>();
  int n = data.Length;
  int max = n > 0 ? Math.Max(1, data.Max()) : 1;
  int W = 320, H = 120, pad = 6;            // drawing area
  Func<int, double> X = i => n <= 1 ? pad : pad + (i * (W - pad * 2) / (double)(n - 1));
  Func<int, int, double> Y = (val, m) => H - pad - (m == 0 ? 0 : (val * (H - pad * 2) / (double)m));
  string points = n <= 0 ? "" : string.Join(" ", Enumerable.Range(0, n).Select(i => $"{X(i):0.##},{Y(data[i], max):0.##}"));
  var start = Model.SparkFromDate; // inclusive

  int pctOpen = Model.TotalJobs == 0 ? 0 : Math.Min(100, (int)Math.Round(100.0 * Model.ActiveJobs / Model.TotalJobs));
}

<style>
  /* ---- Enhanced stat cards ---- */
  .stat-card{border:0;background:linear-gradient(180deg,#fff 0%,#f7faff 100%);box-shadow:0 1px 2px rgba(16,24,40,.04),0 1px 1px rgba(16,24,40,.02);transition:transform .08s ease,box-shadow .12s ease}
  .stat-card:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(16,24,40,.10)}
  .stat-icon{width:44px;height:44px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;background:#e8f1ff;color:#0d6efd}
  .stat-title{font-weight:600;color:#344054}
  .stat-value{font-size:2.25rem;line-height:1.1;font-weight:700;color:#101828}
  .stat-foot{font-size:.85rem;color:#667085}
  .stat-divider{height:1px;background:rgba(13,110,253,.08);margin:.5rem 0 .75rem}
  .progress-slim{height:6px;background:#eef2ff;border-radius:999px;overflow:hidden}
  .progress-slim>span{display:block;height:100%;background:#0d6efd}
</style>

@* ===== Top KPI row (enhanced cards) ===== *@
<div class="row g-3 mb-3">
  <div class="col-sm-4">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">Total Users</div>
            <div class="stat-value mt-1">@Model.TotalUsers</div>
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.67 0-7 2.34-7 5v1h14v-1c0-2.66-2.33-5-7-5Z"/></svg>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-foot">All registered accounts</div>
      </div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">Job Listings</div>
            <div class="stat-value mt-1">@Model.TotalJobs</div>
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6V5a2 2 0 1 1 4 0v1h4a2 2 0 0 1 2 2v3H2V8a2 2 0 0 1 2-2h6Zm12 6v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-6h20Zm-10 2v2h2v-2h-2Z"/></svg>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="progress-slim"><span style="width:@pctOpen%"></span></div>
        <div class="stat-foot mt-1">@Model.ActiveJobs of @Model.TotalJobs open</div>
      </div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">Audit Log Entries</div>
            <div class="stat-value mt-1">@Model.TotalLogs</div>
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1v5h5"/></svg>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-foot">System activity</div>
      </div>
    </div>
  </div>
</div>

@* ===== Mini-metrics row (enhanced) ===== *@
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">Active Jobs</div>
            <div class="stat-value mt-1">@Model.ActiveJobs</div>
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 7h16v10H4zM9 3h6v2H9z"/></svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">Pending Approvals</div>
            <div class="stat-value mt-1">@Model.Approvals.Count</div>
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">Candidates (7 days)</div>
            <div class="stat-value mt-1">@Model.Candidates7d</div>
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.67 0-7 2.34-7 5v1h14v-1c0-2.66-2.33-5-7-5Z"/></svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="stat-title">AI Flags</div>
            <div class="stat-value mt-1">5</div> @* placeholder *@
          </div>
          <div class="stat-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2 1 21h22L12 2Zm0 5 6.93 12H5.07L12 7Zm-1 3v5h2v-5h-2Zm0 6v2h2v-2h-2Z"/></svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@* ===== Extra charts row (added) ===== *@
<div class="row g-3 mb-4">
  <div class="col-xl-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Applications (last 14 days)</h6>
          <small class="text-muted">@start.ToString("yyyy-MM-dd") â†’ @DateTime.UtcNow.ToString("yyyy-MM-dd")</small>
        </div>
        <canvas id="appsTrendChart" height="220"></canvas>
      </div>
    </div>
  </div>
  <div class="col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Jobs Status</h6>
        <canvas id="jobsStatusChart" height="220"></canvas>
      </div>
    </div>
  </div>
  <div class="col-xl-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Flagged Unread</h6>
        <canvas id="flaggedUnreadChart" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

@* ===== Needs attention (table) ===== *@
<div class="card shadow-sm mb-4">
  <div class="card-header bg-white fw-semibold">Needs attention</div>
  <div class="card-body p-0">
    <table class="table mb-0">
      <thead>
        <tr>
          <th>Job</th>
          <th>Candidate</th>
          <th>Last Message</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @if (!Model.Attention.Any())
        {
          <tr>
            <td colspan="4" class="text-muted text-center py-4">No flagged conversations</td>
          </tr>
        }
        else
        {
          foreach (var item in Model.Attention)
          {
            <tr>
              <td>@(string.IsNullOrWhiteSpace(item.JobTitle) ? $"Conversation #{item.ConversationId}" : item.JobTitle)</td>
              <td>@item.Candidate</td>
              <td>@item.LastMessageAt?.ToString("g")</td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary"
                   asp-area="Admin" asp-controller="Messages" asp-action="Thread"
                   asp-route-id="@item.ConversationId">View</a>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>

@* ===== Bottom row: Bulk approvals (sparkline card removed) ===== *@
<div class="row g-3">
  <div class="col-md-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Pending job approvals (Quick Bulk)</div>
      <form method="post" asp-area="Admin" asp-controller="Approvals" asp-action="Bulk">
        @Html.AntiForgeryToken()
        <input type="hidden" name="returnStatus" value="Pending" />
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th style="width:36px"><input type="checkbox" id="dashChkAll" /></th>
                <th style="width:80px">#</th>
                <th>Job</th>
                <th>Company</th>
                <th style="width:160px">Submitted</th>
                <th style="width:120px">Status</th>
              </tr>
            </thead>
            <tbody>
              @if (!Model.Approvals.Any())
              {
                <tr>
                  <td colspan="6" class="text-muted text-center py-4">Nothing pending</td>
                </tr>
              }
              else
              {
                foreach (var a in Model.Approvals)
                {
                  <tr>
                    <td><input type="checkbox" name="ids" value="@a.Id" class="dashRowChk" /></td>
                    <td>@a.Id</td>
                    <td>@a.JobTitle</td>
                    <td>@a.Company</td>
                    <td>@a.Date?.ToString("g")</td>
                    <td><span class="@ChipClass(a.Status)">@a.Status</span></td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
        <div class="card-footer d-flex flex-wrap gap-2">
          <input type="text" name="comments" class="form-control" style="min-width:260px" placeholder="Optional comment" />
          <button type="submit" class="btn btn-success" name="actionType" value="Approve">Approve Selected</button>
          <button type="submit" class="btn btn-warning" name="actionType" value="Changes">Request Changes</button>
          <button type="submit" class="btn btn-outline-danger" name="actionType" value="Reject">Reject Selected</button>
          <a class="btn btn-link ms-auto" asp-area="Admin" asp-controller="Approvals" asp-action="Index" asp-route-status="Pending">Open Approvals</a>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function () {
      // Data for charts
      const trend = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ApplicationsSparkline ?? Array.Empty<int>()));
      const totalJobs = @Model.TotalJobs;
      const openJobs = @Model.ActiveJobs;
      const otherJobs = Math.max(0, totalJobs - openJobs);

      const att = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                  (Model.Attention ?? new List<JobPortal.Areas.Admin.Models.AttentionRow>())
                    .Select(a => new { r=a.UnreadForRecruiter, c=a.UnreadForCandidate })));
      const unreadR = (att||[]).reduce((n,x)=>n+(+x.r||0),0);
      const unreadC = (att||[]).reduce((n,x)=>n+(+x.c||0),0);

      const t = document.getElementById('appsTrendChart');
      if (t) {
        const labels = Array.from({ length: trend.length }, (_, i) => i + 1);
        new Chart(t, {
          type: 'line',
          data: { labels, datasets: [{ data: trend, tension: .35, fill: false, label: 'Applications' }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
      }

      const j = document.getElementById('jobsStatusChart');
      if (j) {
        new Chart(j, {
          type: 'doughnut',
          data: { labels: ['Open', 'Other'], datasets: [{ data: [openJobs, otherJobs] }] },
          options: { plugins: { legend: { position: 'bottom' } }, cutout: '55%' }
        });
      }

      const f = document.getElementById('flaggedUnreadChart');
      if (f) {
        new Chart(f, {
          type: 'bar',
          data: { labels: ['Recruiter', 'Candidate'], datasets: [{ data: [unreadR, unreadC], label: 'Unread' }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
      }

      // Select all in approvals table
      const dAll = document.getElementById('dashChkAll');
      const dRows = document.querySelectorAll('.dashRowChk');
      if (dAll) dAll.addEventListener('change', () => dRows.forEach(c => c.checked = dAll.checked));
    })();
  </script>
}
