@* File: Areas/Admin/Views/Shared/_AdminLayout.cshtml *@
@using Microsoft.AspNetCore.Http
@{
    int currentUserId =
        Context.Session.GetInt32("UserId")
        ?? Context.Session.GetInt32("user_id")
        ?? 0;

    bool hasUser = currentUserId > 0;

    string? fullName =
        Context.Session.GetString("FullName")
        ?? Context.Session.GetString("UserName")
        ?? $"{(Context.Session.GetString("FirstName") ?? "").Trim()} {(Context.Session.GetString("LastName") ?? "").Trim()}".Trim();
    if (string.IsNullOrWhiteSpace(fullName))
    {
        fullName = hasUser ? $"User #{currentUserId}" : "Guest";
    }

    string? role =
        Context.Session.GetString("UserRole")
        ?? Context.Session.GetString("role")
        ?? Context.Session.GetString("user_role")
        ?? "Admin";

    string currentController = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "");
    string currentAction = (ViewContext.RouteData.Values["action"]?.ToString() ?? "");
    bool inSettings = string.Equals(currentController, "Settings", StringComparison.OrdinalIgnoreCase);
    //New for the AI SubMenu
    bool inAI = string.Equals(currentController, "AI", StringComparison.OrdinalIgnoreCase);
    Func<string, string> ActiveAction = (string action) =>
        (inSettings && string.Equals(currentAction, action, StringComparison.OrdinalIgnoreCase)) ? "active" : "";

    Func<string, bool> ActiveController = (string controller) =>
        string.Equals(currentController, controller, StringComparison.OrdinalIgnoreCase);
}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>@ViewData["Title"] - Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <style>
    /* ===== App foundation ===== */
    :root{
      --header-h: 64px;
      --sidebar-w: 260px;
      --surface: #ffffff;
      --surface-soft: #f5f7fb;
      --ink-weak: #6c757d;
      --brand: #0D6EFD;
      --brand-ink: #0a58ca;
      --ring: rgba(13,110,253,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--surface-soft);
      color: #1f2937;
      font-feature-settings: "kern","liga";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Header ===== */
    .site-header{
      position: sticky; top: 0; z-index: 1020;
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid #e9ecef;
    }
    .site-header .brand{
      gap:.5rem; font-weight: 700; letter-spacing:.2px;
    }
    .chip{
      display:inline-block; padding:.2rem .5rem; border-radius:.5rem;
      background:#eef2ff; font-size:.8rem; color:#334155;
    }

    /* ===== Layout grid ===== */
    .layout{
      display: grid;
      grid-template-columns: var(--sidebar-w) minmax(0,1fr);
      min-height: calc(100vh - var(--header-h));
    }

    /* ===== Sidebar ===== */
    .sidebar{
      background: #0D6EFD;
      color:#fff;
      position: sticky; top: var(--header-h);
      align-self: start;
      height: calc(100vh - var(--header-h));
      overflow-y:auto;
      padding: 1rem .75rem 1rem 1rem;
    }
    .nav-label{
      text-transform: uppercase;
      font-size:.72rem;
      letter-spacing:.08em;
      color: rgba(255,255,255,.7);
      margin: .25rem .75rem  .5rem .75rem;
    }
    .side-nav{ list-style:none; margin:0; padding:0; }
    .side-item{ margin:.125rem 0; }
    .side-link{
      display:flex; align-items:center; gap:.6rem;
      padding:.5rem .75rem;
      border-radius:.5rem;
      color:#ffffff; text-decoration:none;
      outline: none; border: 0;
      transition: background-color .15s ease, transform .02s ease;
    }
    .side-link:hover,
    .side-link:focus{ background: rgba(255,255,255,.12); }
    .side-link.active{
      color:#0D6EFD; background:#ffffff; font-weight:600;
      box-shadow: 0 0 0 2px #ffffff inset;
    }
    .side-caret{ margin-left:auto; opacity:.9; }

    .settings-nest{ margin-left:.25rem; padding-left:.5rem; border-left:1px dashed rgba(255,255,255,.3); }
    .settings-nest .side-link{ padding-left: 1.25rem; font-size: .95rem; }

    /* ===== Main ===== */
    .content{ padding: 1.25rem 1.5rem 2.25rem; }
    .content-inner{ max-width: 1400px; margin-inline: auto; }
    .page-title{ margin-bottom: .75rem; }

    /* ===== Cards / panels ===== */
    .card-clean{
      border: 1px solid #e9ecef;
      border-radius: .75rem;
      background: var(--surface);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    /* ===== Notifications (improved) ===== */
    .notif-btn{
      position:relative;width:34px;height:34px;border-radius:.5rem;padding:0;
      display:inline-flex;align-items:center;justify-content:center;line-height:1;
      cursor:pointer;transition:background-color .15s ease, box-shadow .15s ease;
    }
    .notif-btn:hover,.notif-btn:focus-visible{background:#f1f5ff;box-shadow:inset 0 0 0 1px #dbe4ff}
    .notif-badge{
      position:absolute; top:-6px; right:-6px;
      min-width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center;
      padding:0 .25rem; font-size:.65rem; border-radius:999px; box-shadow:0 0 0 2px #fff;
    }
    .notif-dropdown { min-width: 380px; max-width: 440px; padding-top:.35rem; padding-bottom:.35rem; }
    .notif-dropdown .dropdown-header { font-weight:600; padding:.5rem .75rem; }
    .notif-dropdown hr { margin:.35rem 0; }
    .notif-list { max-height: 360px; overflow:auto; }
    .notif-item { padding:.55rem .75rem; border-radius:.5rem; margin:.15rem .5rem; transition: background-color .15s ease, transform .05s ease; }
    .notif-item:hover { background-color:#f7f7f7; }
    .notif-type { font-size:.675rem; border-radius:.4rem; padding:.15rem .4rem; background:#eef1f5; }
    .notif-title { font-weight:600; }
    .notif-time { color:#6c757d; font-size:.75rem; white-space:nowrap; }
    .notif-body-truncate { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:#6c757d; }
    .notif-dot { width:.5rem; height:.5rem; border-radius:50%; background:#dc3545; margin-left:.5rem; flex:0 0 auto; }
    .notif-empty { padding:.9rem .75rem; color:#6c757d; }

    .btn-ghost{ background: transparent; border:1px solid #e9ecef; }
    .btn-ghost:hover{ background:#f8f9fa; }

   @@media (max-width: 992px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position: static; height:auto; overflow: visible; padding: 1rem; border-right: none; }
      .content{ padding: 1rem; }
      .site-header .hamburger{ display: inline-flex !important; }
    }

    .hamburger{ display:none; align-items:center; justify-content:center; width:38px; height:38px; border:1px solid #e9ecef; border-radius:.5rem; background:#fff; }
  </style>
</head>

<body>

  <!-- Toasts (unchanged) -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="appToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="appToastBody">Action done.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script>
    function showToast(message, variant = "primary", redirectTo = null, delayMs = 1200) {
      const toastEl = document.getElementById("appToast");
      const bodyEl  = document.getElementById("appToastBody");
      bodyEl.textContent = message;
      toastEl.className = toastEl.className.replace(/text-bg-\w+/g, "text-bg-" + variant);
      const t = new bootstrap.Toast(toastEl, { delay: delayMs });
      toastEl.addEventListener("hidden.bs.toast", () => { if (redirectTo) window.location.href = redirectTo; }, { once: true });
      t.show();
    }
  </script>

  <!-- Flash (unchanged) -->
  @if (TempData["Flash.Message"] is string flashMsg && !string.IsNullOrWhiteSpace(flashMsg))
  {
      var flashType = (TempData["Flash.Type"] as string ?? "info").ToLowerInvariant();
      <div class="container mt-3">
          <div class="alert alert-@flashType alert-dismissible fade show shadow-sm" role="alert">
              @flashMsg
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
      </div>
      <script>
          setTimeout(function () {
              var el = document.querySelector('.alert');
              if (el) bootstrap.Alert.getOrCreateInstance(el).close();
          }, 3000);
      </script>
  }

  <!-- Header -->
  <header class="site-header d-flex align-items-center">
    <div class="container-fluid px-3 d-flex justify-content-between align-items-center">

      <!-- Mobile sidebar toggle -->
      <button class="hamburger" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-controls="mobileNav" aria-label="Open navigation">
        ‚ò∞
      </button>

      <div class="brand d-flex align-items-center">
        <img src="/img/FYP_Logo.jpg" alt="Joboria Logo" style="height: 24px;">
        <span>Joboria ‚Ä¢ Admin</span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <!-- Notifications (improved icon + badge position) -->
        <div class="dropdown me-1">
          <button id="notifDropdownBtn"
                  class="btn btn-link notif-btn p-0 text-decoration-none"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  title="Notifications"
                  aria-label="Notifications">
            <span class="fs-5" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm7-6v-5a7 7 0 0 0-6-6.92V3a1 1 0 1 0-2 0v1.08A7 7 0 0 0 5 11v5l-2 2v1h18v-1l-2-2Z"/>
              </svg>
            </span>
            <span id="notifBadge" class="badge rounded-pill bg-danger notif-badge d-none">0</span>
          </button>

          <div class="dropdown-menu dropdown-menu-end shadow notif-dropdown" aria-labelledby="notifDropdownBtn">
            <div class="dropdown-header d-flex justify-content-between align-items-center">
              <span>Notifications</span>
              <form asp-area="Admin" asp-controller="Notifications" asp-action="MarkAllAsRead" method="post" class="m-0">
                <button type="submit" class="btn btn-link btn-sm" id="notifMarkAllBtn" disabled>Mark all read</button>
              </form>
            </div>

            <hr class="mb-0" />
            <div id="notifList" class="notif-list py-2">
              <div class="notif-empty small px-3">No notifications.</div>
            </div>
            <hr class="mt-0" />
            <a class="dropdown-item text-center" asp-area="Admin" asp-controller="Notifications" asp-action="Index">
              Open Notification Centre
            </a>
          </div>
        </div>
        <!-- end notifications -->

        <span class="chip">@fullName (@role)</span>
        <a class="btn btn-outline-danger btn-sm" asp-area="Admin" asp-controller="Dashboard" asp-action="Logout">Logout</a>
      </div>
    </div>
  </header>

  <!-- App layout -->
  <div class="layout">
    <!-- Desktop Sidebar -->
    <aside class="sidebar d-none d-lg-block">
      <div class="nav-label">Navigation</div>
      <ul class="side-nav">
        <li class="side-item"><a class="side-link @(ActiveController("Dashboard") ? "active" : "")" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
        <li class="side-item"><a class="side-link @(ActiveController("Users") ? "active" : "")" asp-area="Admin" asp-controller="Users" asp-action="Index">Users</a></li>
        <li class="side-item"><a class="side-link @(ActiveController("Approvals") ? "active" : "")" asp-area="Admin" asp-controller="Approvals" asp-action="Index">Job Approvals</a></li>
        <li class="side-item"><a class="side-link @(ActiveController("Companies") ? "active" : "")" asp-area="Admin" asp-controller="Companies" asp-action="Index">Companies</a></li>
        @* <li class="side-item"><a class="side-link @((ActiveController("AI") && string.Equals(currentAction, "Templates", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Templates">AI Settings</a></li>
        <li class="side-item"><a class="side-link @((ActiveController("AI") && string.Equals(currentAction, "Health", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Health">AI Health</a></li> *@


              <!-- AI Monitor collapsible -->
@{
  var aiShowClass = inAI ? "show" : "";
}
<li class="side-item">
  <a class="side-link d-flex align-items-center" data-bs-toggle="collapse" href="#aiMonitorMenu" role="button" aria-expanded="@(inAI.ToString().ToLower())" aria-controls="aiMonitorMenu">
    AI Monitor
    <span class="side-caret">‚ñæ</span>
  </a>
  <div class="collapse @aiShowClass settings-nest" id="aiMonitorMenu">
    <ul class="side-nav">
      @* <li class="side-item"><a class="side-link @((ActiveController("AI") && string.Equals(currentAction, "Templates", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Templates">AI Settings</a></li> *@
      <li class="side-item"><a class="side-link @((ActiveController("AI") && string.Equals(currentAction, "Health", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Health">AI Health</a></li>
    </ul>
  </div>
</li>



        <li class="side-item"><a class="side-link @(ActiveController("Messages") ? "active" : "")" asp-area="Admin" asp-controller="Messages" asp-action="Index">Conversation Monitor</a></li>
        <li class="side-item"><a class="side-link @(ActiveController("Audit") ? "active" : "")" asp-area="Admin" asp-controller="Audit" asp-action="Index">Audit Log</a></li>
        <li class="side-item"><a class="side-link @(ActiveController("Reports") ? "active" : "")" asp-area="Admin" asp-controller="Reports" asp-action="Index">Reports</a></li>

        @* Settings collapsible
        @{
          var showClass = inSettings ? "show" : "";
        }
        <li class="side-item">
          <a class="side-link d-flex align-items-center" data-bs-toggle="collapse" href="#settingsMenu" role="button" aria-expanded="@(inSettings.ToString().ToLower())" aria-controls="settingsMenu">
            Settings
            <span class="side-caret">‚ñæ</span>
          </a>
          <div class="collapse @showClass settings-nest" id="settingsMenu">
            <ul class="side-nav">
              <li class="side-item"><a class="side-link @ActiveAction("Branding")" asp-area="Admin" asp-controller="Settings" asp-action="Branding">Branding</a></li>
              <li class="side-item"><a class="side-link @ActiveAction("Legal")" asp-area="Admin" asp-controller="Settings" asp-action="Legal">Legal</a></li>
              <li class="side-item"><a class="side-link @ActiveAction("Notifications")" asp-area="Admin" asp-controller="Settings" asp-action="Notifications">Notifications</a></li>
            </ul>
          </div>
        </li> *@
      </ul>
    </aside>

    <!-- Mobile Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
      <div class="offcanvas-header">
        <h6 class="offcanvas-title" id="mobileNavLabel">Navigation</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="side-nav">
          <li class="side-item"><a class="side-link text-white @(ActiveController("Dashboard") ? "active" : "")" asp-area="Admin" asp-controller="Dashboard" asp-action="Index" data-bs-dismiss="offcanvas">Dashboard</a></li>
          <li class="side-item"><a class="side-link text-white @(ActiveController("Users") ? "active" : "")" asp-area="Admin" asp-controller="Users" asp-action="Index" data-bs-dismiss="offcanvas">Users</a></li>
          <li class="side-item"><a class="side-link text-white @(ActiveController("Approvals") ? "active" : "")" asp-area="Admin" asp-controller="Approvals" asp-action="Index" data-bs-dismiss="offcanvas">Job Approvals</a></li>
          <li class="side-item"><a class="side-link text-white @(ActiveController("Companies") ? "active" : "")" asp-area="Admin" asp-controller="Companies" asp-action="Index" data-bs-dismiss="offcanvas">Companies</a></li>



          @* <li class="side-item"><a class="side-link text-white @((ActiveController("AI") && string.Equals(currentAction, "Templates", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Templates" data-bs-dismiss="offcanvas">AI Settings</a></li>
          <li class="side-item"><a class="side-link text-white @((ActiveController("AI") && string.Equals(currentAction, "Health", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Health" data-bs-dismiss="offcanvas">AI Health</a></li> *@


          <!-- AI Monitor collapsible for mobile -->
<li class="side-item">
  <a class="side-link text-white d-flex align-items-center" data-bs-toggle="collapse" href="#mAiMonitorMenu" role="button" aria-expanded="@(inAI.ToString().ToLower())" aria-controls="mAiMonitorMenu">
    AI Monitor <span class="side-caret ms-auto">‚ñæ</span>
  </a>
  <div class="collapse @aiShowClass settings-nest" id="mAiMonitorMenu">
    <ul class="side-nav">
      @* <li class="side-item"><a class="side-link text-white @((ActiveController("AI") && string.Equals(currentAction, "Templates", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Templates" data-bs-dismiss="offcanvas">AI Settings</a></li> *@
      <li class="side-item"><a class="side-link text-white @((ActiveController("AI") && string.Equals(currentAction, "Health", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" asp-area="Admin" asp-controller="AI" asp-action="Health" data-bs-dismiss="offcanvas">AI Health</a></li>
    </ul>
  </div>
</li>






          <li class="side-item"><a class="side-link text-white @(ActiveController("Messages") ? "active" : "")" asp-area="Admin" asp-controller="Messages" asp-action="Index" data-bs-dismiss="offcanvas">Conversation Monitor</a></li>
          <li class="side-item"><a class="side-link text-white @(ActiveController("Audit") ? "active" : "")" asp-area="Admin" asp-controller="Audit" asp-action="Index" data-bs-dismiss="offcanvas">Audit Log</a></li>
          <li class="side-item"><a class="side-link text-white @(ActiveController("Reports") ? "active" : "")" asp-area="Admin" asp-controller="Reports" asp-action="Index" data-bs-dismiss="offcanvas">Reports</a></li>
          <li class="side-item mt-2">
            <a class="side-link text-white d-flex align-items-center" data-bs-toggle="collapse" href="#mSettingsMenu" role="button" aria-expanded="@(inSettings.ToString().ToLower())" aria-controls="mSettingsMenu">
              Settings <span class="side-caret ms-auto">‚ñæ</span>
            </a>
            @* <div class="collapse @showClass settings-nest" id="mSettingsMenu">
              <ul class="side-nav">
                <li class="side-item"><a class="side-link text-white @ActiveAction("Branding")" asp-area="Admin" asp-controller="Settings" asp-action="Branding" data-bs-dismiss="offcanvas">Branding</a></li>
                <li class="side-item"><a class="side-link text-white @ActiveAction("Legal")" asp-area="Admin" asp-controller="Settings" asp-action="Legal" data-bs-dismiss="offcanvas">Legal</a></li>
                <li class="side-item"><a class="side-link text-white @ActiveAction("Notifications")" asp-area="Admin" asp-controller="Settings" asp-action="Notifications" data-bs-dismiss="offcanvas">Notifications</a></li>
              </ul>
            </div> *@
          </li>
        </ul>
      </div>
    </div>

    <!-- Main -->
    <main class="content">
      <div class="content-inner">
        <h1 class="h5 page-title">@ViewData["Title"]</h1>
        @RenderBody()
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function () {
      try {
        history.pushState(null, '', location.href);
        window.addEventListener('popstate', function () { history.pushState(null, '', location.href); });
        window.addEventListener('pageshow', function (e) { if (e.persisted) { history.pushState(null, '', location.href); } });
      } catch (_) {}

      function syncCaret(toggleEl, collapseEl) {
        var caret = toggleEl.querySelector('.side-caret, .caret');
        if (!caret) return;
        var isOpen = collapseEl.classList.contains('show') || toggleEl.getAttribute('aria-expanded') === 'true';
        caret.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
      }
      function wireToggle(toggleEl) {
        var targetSel = toggleEl.getAttribute('href') || toggleEl.getAttribute('data-bs-target');
        if (!targetSel) return;
        var collapseEl = document.querySelector(targetSel);
        if (!collapseEl) return;
        syncCaret(toggleEl, collapseEl);
        collapseEl.addEventListener('shown.bs.collapse', function () { syncCaret(toggleEl, collapseEl); });
        collapseEl.addEventListener('hidden.bs.collapse', function () { syncCaret(toggleEl, collapseEl); });
      }
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(wireToggle);
      });

      // Notifications
      const notifBadge = document.getElementById('notifBadge');
      const notifList  = document.getElementById('notifList');
      const markAllBtn = document.getElementById('notifMarkAllBtn');
      const dropdownEl = document.getElementById('notifDropdownBtn');
      async function fetchJSON(url) {
        try {
          const res = await fetch(url, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return await res.json();
        } catch (e) { return null; }
      }
      function renderBadge(count) {
        const n = Number(count || 0);
        if (n > 0) {
          notifBadge.textContent = (n > 99 ? '99+' : String(n));
          notifBadge.classList.remove('d-none');
          markAllBtn?.removeAttribute('disabled');
        } else {
          notifBadge.classList.add('d-none');
          markAllBtn?.setAttribute('disabled', 'disabled');
        }
      }
      function iconFor(t) {
        if (!t) return 'üîî';
        t = String(t).toLowerCase();
        if (t.includes('system')) return '‚öôÔ∏è';
        if (t.includes('message')) return 'üì®';
        if (t.includes('approval') || t.includes('review')) return '‚úÖ';
        return 'üîî';
      }
      function typeClass(t) {
        if (!t) return '';
        t = String(t).toLowerCase();
        if (t.includes('system')) return 'notif-type--System';
        if (t.includes('message')) return 'notif-type--Message';
        if (t.includes('approval') || t.includes('review')) return 'notif-type--Approval';
        return '';
      }
      function renderItems(items) {
        if (!Array.isArray(items) || items.length === 0) {
          notifList.innerHTML = '<div class="notif-empty small px-3">No notifications.</div>';
          return;
        }
        notifList.innerHTML = items.map(function (n) {
          const title = (n.title || 'Notification');
          const type  = (n.type || 'General');
          const body  = (n.textPreview || n.message || '');
          const time  = (n.createdAtLocal || n.createdAt || '');
          const url   = (n.url || '/Admin/Notifications');
          const unreadDot = n.isRead ? '' : '<span class="notif-dot" aria-hidden="true"></span>';
          return `
            <a class="dropdown-item notif-item d-flex align-items-start ${n.isRead ? '' : 'notif-item-unread'}" href="${url}">
              <div class="me-2" aria-hidden="true" style="font-size:1.05rem; line-height:1;">${iconFor(type)}</div>
              <div class="flex-fill">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex align-items-center gap-2">
                    <span class="notif-title">${title}</span>
                    <span class="notif-type ${typeClass(type)}">${type || 'General'}</span>
                  </div>
                  <small class="notif-time">${time}</small>
                </div>
                <div class="notif-body-truncate small">${body}</div>
              </div>
              ${unreadDot}
            </a>`;
        }).join('');
      }
      async function refreshBadge() {
        const data = await fetchJSON('/Admin/Notifications/UnreadCount');
        if (data && typeof data.count !== 'undefined') renderBadge(data.count);
      }
      async function refreshPeek() {
        const data = await fetchJSON('/Admin/Notifications/Peek');
        if (data && Array.isArray(data.items)) renderItems(data.items);
        else renderItems([]);
      }
      refreshBadge();
      if (dropdownEl) dropdownEl.addEventListener('show.bs.dropdown', refreshPeek);
      setInterval(refreshBadge, 60000);
    })();
  </script>

  @RenderSection("Scripts", required: false)
</body>
</html>
