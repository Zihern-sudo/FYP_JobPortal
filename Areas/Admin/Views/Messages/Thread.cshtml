@* File: Areas/Admin/Views/Messages/Thread.cshtml *@
@model JobPortal.Areas.Admin.Models.ConversationThreadViewModel
@{
  ViewData["Title"] = $"Thread #{Model.ConversationId}";
  string Chip(string s) => s switch
  {
    "Active" => "badge text-bg-success",
    "Suspended" => "badge text-bg-danger",
    "Inactive" => "badge text-bg-secondary",
    _ => "badge text-bg-light"
  };
}

<a asp-area="Admin" asp-controller="Messages" asp-action="Index" class="d-inline-block text-decoration-none mb-3">
  &leftarrow; Back to Conversation Monitor
</a>

@* Flash (for non-AJAX posts) *@
@if (TempData["Flash.Message"] is string fm)
{
  var ft = (TempData["Flash.Type"] as string) ?? "info";
  <div class="alert alert-@ft">@fm</div>
}

<!-- Global anti-forgery token for AJAX -->
<form id="__af" method="post" class="d-none">@Html.AntiForgeryToken()</form>

<!-- Blocked banner -->
@if (Model.IsBlocked)
{
  <div class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="bi bi-shield-exclamation me-2"></i>
    <div>
      <strong>Chat is blocked by admin.</strong>
      @if (!string.IsNullOrWhiteSpace(Model.BlockedReason))
      {
        <span class="ms-1">@Model.BlockedReason</span>
      }
    </div>
  </div>
}

<div class="d-flex align-items-center gap-2 mb-3">

  <!-- Flag/Unblock + Mark all read -->
  <div class="d-flex gap-2">
    @* Flag/Block (AJAX modal) or Unblock *@
    @if (!Model.IsBlocked)
    {
      <a href="#" class="btn btn-danger btn-sm"
        data-flag-modal="@Url.Action("FlagModal", "Messages", new { area = "Admin", conversationId = Model.ConversationId })">
        <i class="bi bi-flag"></i> Flag & Block
      </a>
    }
    else
    {
      <a href="#" class="btn btn-outline-secondary btn-sm"
        data-unflag="@Url.Action("UnflagConversation", "Messages", new { area = "Admin", conversationId = Model.ConversationId })">
        <i class="bi bi-unlock"></i> Unblock
      </a>
    }

    <form method="post" asp-action="MarkAllRead" class="d-inline">
      @Html.AntiForgeryToken()
      <input type="hidden" name="conversationId" value="@Model.ConversationId" />
      <button class="btn btn-outline-secondary btn-sm">Mark all as read</button>
    </form>
  </div>

  <div class="ms-auto d-flex gap-2">
    @if (Model.ParticipantA is not null)
    {
      <div class="btn-group">
        <button type="button" class="btn btn-sm btn-outline-primary">
          @Model.ParticipantA.Name <span class="ms-1 @Chip(Model.ParticipantA.Status)">@Model.ParticipantA.Status</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split"
          data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <form method="post" asp-action="RestrictMessaging" class="px-3 py-1">
              @Html.AntiForgeryToken()
              <input type="hidden" name="conversationId" value="@Model.ConversationId" />
              <input type="hidden" name="userId" value="@Model.ParticipantA.UserId" />
              <button class="dropdown-item text-danger" type="submit">Suspend Messaging</button>
            </form>
          </li>
          <li>
            <form method="post" asp-action="AllowMessaging" class="px-3 py-1">
              @Html.AntiForgeryToken()
              <input type="hidden" name="conversationId" value="@Model.ConversationId" />
              <input type="hidden" name="userId" value="@Model.ParticipantA.UserId" />
              <button class="dropdown-item" type="submit">Allow Messaging</button>
            </form>
          </li>
        </ul>
      </div>
    }
    @if (Model.ParticipantB is not null)
    {
      <div class="btn-group">
        <button type="button" class="btn btn-sm btn-outline-primary">
          @Model.ParticipantB.Name <span class="ms-1 @Chip(Model.ParticipantB.Status)">@Model.ParticipantB.Status</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split"
          data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <form method="post" asp-action="RestrictMessaging" class="px-3 py-1">
              @Html.AntiForgeryToken()
              <input type="hidden" name="conversationId" value="@Model.ConversationId" />
              <input type="hidden" name="userId" value="@Model.ParticipantB.UserId" />
              <button class="dropdown-item text-danger" type="submit">Suspend Messaging</button>
            </form>
          </li>
          <li>
            <form method="post" asp-action="AllowMessaging" class="px-3 py-1">
              @Html.AntiForgeryToken()
              <input type="hidden" name="conversationId" value="@Model.ConversationId" />
              <input type="hidden" name="userId" value="@Model.ParticipantB.UserId" />
              <button class="dropdown-item" type="submit">Allow Messaging</button>
            </form>
          </li>
        </ul>
      </div>
    }
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    @if (!Model.Messages.Any())
    {
      <div class="text-muted">No messages in this conversation.</div>
    }
    else
    {
      foreach (var m in Model.Messages)
      {
        <div class="mb-3">
          <div class="fw-semibold">@m.SenderName <span class="text-muted small">(@(m.SenderRole ?? "User"))</span></div>
          <div class="border rounded p-2">@m.Text</div>
          <div class="text-muted small mt-1">@m.Timestamp.ToString("g")</div>
        </div>
      }
    }
  </div>
</div>

<!-- Modal shell (content loaded via GET /Admin/Messages/FlagModal) -->
<div class="modal fade" id="flagModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content"><!-- _FlagModal.cshtml will be injected here via AJAX --></div>
  </div>
</div>

<!-- Ensure the AJAX handler is available (keep if not already included by layout) -->
<script src="~/js/admin-messages.js"></script>