// ===============================
// File: Areas/Admin/Views/Messages/Index.cshtml (UPDATED)
// ===============================
@* File: Areas/Admin/Views/Messages/Index.cshtml *@
@model JobPortal.Areas.Admin.Models.MessagesIndexViewModel

@{
  string FlagBadge(bool flagged) => flagged ? "badge text-bg-danger" : "badge text-bg-secondary";
  string UnreadBadge(int n) => n > 0 ? "badge text-bg-primary" : "badge text-bg-light";
  string Snip(string? s) => string.IsNullOrWhiteSpace(s) ? "-" : (s!.Length > 80 ? s.Substring(0, 80) + "…" : s);

  // ADDED: sorting state
  var sort = string.IsNullOrWhiteSpace(Model.Sort) ? "id_desc" : Model.Sort;
  var idNext = sort == "id_desc" ? "id_asc" : "id_desc";
  var arrow = sort == "id_asc" ? "▲" : "▼";
}

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form class="row g-2" method="get" asp-area="Admin" asp-controller="Messages" asp-action="Index">
      <div class="col-sm-6 col-md-5 col-lg-4">
        <input type="text" class="form-control" name="q" value="@Model.Filter.Q"
          placeholder="Search company or job title..." />
      </div>
      <div class="col-sm-3 col-md-3 col-lg-2 d-flex align-items-center">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="flaggedOnly" value="true" id="flaggedOnly"
            @(Model.Filter.FlaggedOnly ? "checked" : "") />
          <label class="form-check-label" for="flaggedOnly">Flagged only</label>
        </div>
      </div>
      <input type="hidden" name="pageSize" value="@Model.Filter.PageSize" />
      @* ADDED: preserve sort on search *@
      <input type="hidden" name="sort" value="@sort" />
      <div class="col-sm-3 col-md-4 col-lg-6 text-end">
        <button class="btn btn-primary">Apply</button>
        <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Messages" asp-action="Index">Reset</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          @* ADDED: ID sort toggle (cell-wide clickable, non-blue arrow) *@
          <th class="position-relative" style="width:80px">
            <span>#</span>
            <span class="ms-1">@arrow</span>
            <a class="stretched-link text-decoration-none" asp-area="Admin" asp-controller="Messages" asp-action="Index"
              asp-route-q="@Model.Filter.Q" asp-route-flaggedOnly="@Model.Filter.FlaggedOnly"
              asp-route-page="@Model.Items.Page" asp-route-pageSize="@Model.Filter.PageSize" asp-route-sort="@idNext"
              aria-label="Sort by ID"></a>
          </th>
          <th>Company</th>
          <th>Job Title</th>
          <th>Last Message</th>
          <th>Last Snippet</th>
          <th class="text-center" style="width:110px">Messages</th>
          <th style="width:140px">Unread</th>
          <th style="width:110px">Flag</th>
          <th style="width:120px"></th>
        </tr>
      </thead>
      <tbody>
        @if (!Model.Items.Items.Any())
        {
          <tr>
            <td colspan="9" class="text-center text-muted py-4">No conversations</td>
          </tr>
        }
        else
        {
          foreach (var t in Model.Items.Items)
          {
            <tr>
              <td>@t.ConversationId</td>
              <td>@t.CompanyName</td>
              <td>
                @t.JobTitle
                @if (t.Flagged)
                {
                  <span class="badge text-bg-danger ms-1" title="Blocked by admin">Blocked</span>
                }
              </td>
              <td>@t.LastMessageAt?.ToString("g")</td>
              <td class="text-muted">@Snip(t.LastSnippet)</td>
              <td class="text-center"><span class="badge text-bg-dark">@t.MessageCount</span></td>
              <td>
                <span class="@UnreadBadge(t.UnreadForRecruiter)" title="Unread for recruiter">R:
                  @t.UnreadForRecruiter</span>
                <span class="@UnreadBadge(t.UnreadForCandidate) ms-1" title="Unread for candidate">C:
                  @t.UnreadForCandidate</span>
              </td>
              <td>
                <span class="@FlagBadge(t.Flagged)">@((t.Flagged) ? "Flagged" : "OK")</span>
              </td>
              <td class="text-end">
                @if (t.Flagged)
                {
                  <button type="button" class="btn btn-sm btn-outline-secondary disabled" title="Blocked by admin"
                    tabindex="-1" aria-disabled="true">Open</button>
                }
                else
                {
                  <a class="btn btn-sm btn-outline-primary" asp-area="Admin" asp-controller="Messages" asp-action="Thread"
                    asp-route-id="@t.ConversationId">Open</a>
                }
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <div class="card-footer d-flex justify-content-between align-items-center">
    <div class="text-muted small">
      Page @Model.Items.Page of @Model.Items.TotalPages · @Model.Items.TotalItems items
    </div>
    <nav>
      <ul class="pagination mb-0">
        @{
          var prevDisabled = Model.Items.Page <= 1 ? " disabled" : "";
          var nextDisabled = Model.Items.Page >= Model.Items.TotalPages ? " disabled" : "";
          var prevPage = Math.Max(1, Model.Items.Page - 1);
          var nextPage = Math.Min(Model.Items.TotalPages, Model.Items.Page + 1);
        }
        <li class="page-item@prevDisabled">
          <a class="page-link" asp-area="Admin" asp-controller="Messages" asp-action="Index"
            asp-route-q="@Model.Filter.Q" asp-route-flaggedOnly="@Model.Filter.FlaggedOnly" asp-route-page="@prevPage"
            asp-route-pageSize="@Model.Filter.PageSize" asp-route-sort="@sort">Prev</a>
        </li>
        <li class="page-item@nextDisabled">
          <a class="page-link" asp-area="Admin" asp-controller="Messages" asp-action="Index"
            asp-route-q="@Model.Filter.Q" asp-route-flaggedOnly="@Model.Filter.FlaggedOnly" asp-route-page="@nextPage"
            asp-route-pageSize="@Model.Filter.PageSize" asp-route-sort="@sort">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>