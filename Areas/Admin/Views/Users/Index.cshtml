@* ============================================
   File: Areas/Admin/Views/Users/Index.cshtml
   ============================================ *@
@using Microsoft.AspNetCore.Mvc.Rendering
@model JobPortal.Areas.Admin.Models.RecruitersIndexViewModel

@{
    ViewData["Title"] = "Users";
    string role = (string?)ViewBag.Role ?? "All";
    string Active(string s) => string.Equals(Model.Status, s, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    string Chip(string s) => s switch
    {
        "Active" => "badge text-bg-success",
        "Suspended" => "badge text-bg-danger",
        "Inactive" => "badge text-bg-secondary",
        _ => "badge text-bg-light"
    };

    // ---- ADDED: sorting state from controller (default newest first) ----
    var sort = (string)(ViewBag.Sort ?? "id_desc"); // id_asc | id_desc
    var idNext = sort == "id_desc" ? "id_asc" : "id_desc";
    var arrow = sort == "id_asc" ? "▲" : "▼";
}

<div class="card shadow-sm mb-3">
    <div class="card-body">

        @* --------- FILTER (GET) --------- *@
        <form method="get" class="row g-2 align-items-end">
            <div class="col-12">
                <div class="btn-group mb-2">
                    <a class="btn btn-outline-secondary @Active("All")" asp-action="Index" asp-route-status="All"
                        asp-route-role="@role" asp-route-q="@Model.Query" asp-route-from="@((string?)ViewBag.From)"
                        asp-route-to="@((string?)ViewBag.To)" asp-route-sort="@sort">
                        All (@Model.AllCount)</a>

                    <a class="btn btn-outline-success @Active("Active")" asp-action="Index" asp-route-status="Active"
                        asp-route-role="@role" asp-route-q="@Model.Query" asp-route-from="@((string?)ViewBag.From)"
                        asp-route-to="@((string?)ViewBag.To)" asp-route-sort="@sort">
                        Active (@Model.ActiveCount)</a>

                    <a class="btn btn-outline-warning @Active("Pending")" asp-action="Index" asp-route-status="Pending"
                        asp-route-role="@role" asp-route-q="@Model.Query" asp-route-from="@((string?)ViewBag.From)"
                        asp-route-to="@((string?)ViewBag.To)" asp-route-sort="@sort">
                        Pending (@Model.PendingCount)</a>

                    <a class="btn btn-outline-danger @Active("Suspended")" asp-action="Index"
                        asp-route-status="Suspended" asp-route-role="@role" asp-route-q="@Model.Query"
                        asp-route-from="@((string?)ViewBag.From)" asp-route-to="@((string?)ViewBag.To)"
                        asp-route-sort="@sort">
                        Suspended (@Model.SuspendedCount)</a>
                </div>
            </div>

            @* Role filter without RZ1031 *@
            <div class="col-auto">
                <label class="form-label mb-0 small">Role</label>
                @{
                    var roleItems = new List<SelectListItem>
                                {
                                new SelectListItem("All", "All", role=="All"),
                                new SelectListItem("Recruiter", "Recruiter", role=="Recruiter"),
                                new SelectListItem("Job Seeker", "JobSeeker", role=="JobSeeker")
                                };
                }
                @Html.DropDownList("role", roleItems, new { @class = "form-select" })
            </div>

            <div class="col-auto">
                <input class="form-control" type="search" name="q" value="@Model.Query"
                    placeholder="Search name/email/company">
                <input type="hidden" name="status" value="@Model.Status" />
                @* ADDED: preserve sort on submit *@
                <input type="hidden" name="sort" value="@sort" />
            </div>

            <div class="col-auto">
                <label class="form-label mb-0 small">From</label>
                <input class="form-control" type="date" name="from" value="@((string?)ViewBag.From)">
            </div>

            <div class="col-auto">
                <label class="form-label mb-0 small">To</label>
                <input class="form-control" type="date" name="to" value="@((string?)ViewBag.To)">
            </div>

            <div class="col-auto">
                <button class="btn btn-primary" type="submit">Apply</button>
            </div>
        </form>

        @* --------- IMPORT (standalone POST; NOT nested) --------- *@
        <form asp-action="ImportCsv" asp-controller="Users" asp-area="Admin" method="post" enctype="multipart/form-data"
            class="mt-3 d-flex gap-2 align-items-center">
            @Html.AntiForgeryToken()
            <input type="hidden" name="status" value="@Model.Status" />
            <input type="hidden" name="q" value="@Model.Query" />
            <input type="hidden" name="page" value="@Model.Items.Page" />
            <input type="hidden" name="role" value="@role" />
            <input type="file" name="csv" accept=".csv" class="form-control" style="max-width: 340px;" />
            <button type="submit" class="btn btn-outline-primary">Import CSV</button>

            <a class="btn btn-outline-secondary ms-auto" asp-action="ExportCsv" asp-route-status="@Model.Status"
                asp-route-role="@role" asp-route-q="@Model.Query" asp-route-from="@ViewBag.From"
                asp-route-to="@ViewBag.To">
                Export CSV</a>
        </form>

    </div>
</div>

@* --------- TABLE + BULK (single POST form) --------- *@
<div class="card shadow-sm">
    <form method="post" asp-action="Bulk">
        @Html.AntiForgeryToken()
        <input type="hidden" name="status" value="@Model.Status" />
        <input type="hidden" name="q" value="@Model.Query" />
        <input type="hidden" name="from" value="@ViewBag.From" />
        <input type="hidden" name="to" value="@ViewBag.To" />
        <input type="hidden" name="page" value="@Model.Items.Page" />
        <input type="hidden" name="role" value="@role" />

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="width:36px"><input type="checkbox" id="chkAll" /></th>
                            @* ADDED: ID sort toggle (cell-wide clickable, non-blue arrow) *@
                            <th class="position-relative" style="width:80px">
                                <span>ID</span>
                                <span class="ms-1">@arrow</span>
                                <a class="stretched-link text-decoration-none" asp-action="Index"
                                    asp-route-status="@Model.Status" asp-route-role="@role" asp-route-q="@Model.Query"
                                    asp-route-from="@((string?)ViewBag.From)" asp-route-to="@((string?)ViewBag.To)"
                                    asp-route-page="@Model.Items.Page" asp-route-sort="@idNext"
                                    aria-label="Sort by ID"></a>
                            </th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Company</th>
                            <th style="width:120px">User Status</th>
                            <th style="width:120px">Company</th>
                            <th style="width:160px">Created</th>
                            <th style="width:260px" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Items.Items.Any())
                        {
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">No users found</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var r in Model.Items.Items)
                            {
                                var cchip = r.CompanyStatus switch
                                {
                                    "Active" => "badge text-bg-success",
                                    "Pending" => "badge text-bg-warning",
                                    "Suspended" => "badge text-bg-danger",
                                    null or "" => "badge text-bg-secondary",
                                    _ => "badge text-bg-secondary"
                                        };
                                <tr>
                                    <td><input type="checkbox" name="ids" value="@r.Id" class="rowChk" /></td>
                                    <td>@r.Id</td>
                                    <td>@r.Name</td>
                                    <td>@r.Email</td>
                                    <td>@r.Role</td>
                                    <td>@(string.IsNullOrWhiteSpace(r.Company) ? "-" : r.Company)</td>
                                    <td><span class="@Chip(r.Status)">@r.Status</span></td>
                                    <td><span class="@cchip">@((string.IsNullOrWhiteSpace(r.CompanyStatus) ? "—" :
                                                                                r.CompanyStatus))</span></td>
                                    <td>@r.CreatedAt.ToString("g")</td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            @* Row actions submit THIS form using formaction (no nested forms) *@
                                                    <button type="submit" class="btn btn-sm btn-outline-success"
                                                formaction="@Url.Action("Approve", "Users", new { area = "Admin" })" name="id"
                                                value="@r.Id">Approve</button>
                                            <button type="submit" class="btn btn-sm btn-outline-warning"
                                                formaction="@Url.Action("Suspend", "Users", new { area = "Admin" })" name="id"
                                                value="@r.Id">Suspend</button>
                                            <button type="submit" class="btn btn-sm btn-outline-secondary"
                                                formaction="@Url.Action("Reactivate", "Users", new { area = "Admin" })"
                                                name="id" value="@r.Id">Reactivate</button>
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                formaction="@Url.Action("Reject", "Users", new { area = "Admin" })" name="id"
                                                value="@r.Id">Reject</button>

                                            <a class="btn btn-sm btn-outline-primary" asp-action="Preview"
                                                asp-route-id="@r.Id">Open</a>

                                            @* NEW: View Company (only if recruiter and company is NOT yet verified/active) *@
                                                    @if (r.Role == "Recruiter" && (string.IsNullOrEmpty(r.CompanyStatus) ||
                                                                                r.CompanyStatus == "Pending" || r.CompanyStatus == "Incomplete" || r.CompanyStatus
                                                                                == "Rejected"))
                                            {
                                                <a class="btn btn-sm btn-outline-secondary" asp-action="CompanyProfile"
                                                    asp-route-id="@r.Id">View Company</a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer d-flex flex-wrap gap-2 align-items-center">
            <button type="submit" class="btn btn-success" name="actionType" value="Approve">Approve Selected</button>
            <button type="submit" class="btn btn-secondary" name="actionType" value="Reject">Reject Selected</button>
            <button type="submit" class="btn btn-outline-danger" name="actionType" value="Suspend">Suspend
                Selected</button>
            <button type="submit" class="btn btn-primary" name="actionType" value="Reactivate">Reactivate
                Selected</button>

            <div class="ms-auto text-muted small">
                Page @Model.Items.Page of @Model.Items.TotalPages • @Model.Items.TotalItems total
            </div>
        </div>
    </form>
</div>

<div class="mt-2 d-flex justify-content-end gap-2">
    @{
        var prev = Math.Max(1, Model.Items.Page - 1);
        var next = Math.Min(Model.Items.TotalPages, Model.Items.Page + 1);
    }
    <a class="btn btn-sm btn-outline-secondary @(Model.Items.Page == 1 ? "disabled" : "")" asp-action="Index"
        asp-route-status="@Model.Status" asp-route-role="@role" asp-route-q="@Model.Query"
        asp-route-from="@ViewBag.From" asp-route-to="@ViewBag.To" asp-route-page="@prev" asp-route-sort="@sort">Prev</a>

    <a class="btn btn-sm btn-outline-secondary @(Model.Items.Page == Model.Items.TotalPages ? "disabled" : "")"
        asp-action="Index" asp-route-status="@Model.Status" asp-route-role="@role" asp-route-q="@Model.Query"
        asp-route-from="@ViewBag.From" asp-route-to="@ViewBag.To" asp-route-page="@next" asp-route-sort="@sort">Next</a>
</div>

@section Scripts {
    <script>
        const all = document.getElementById('chkAll');
        if (all) all.addEventListener('change', () =>
            document.querySelectorAll('.rowChk').forEach(cb => cb.checked = all.checked)
        );
    </script>
}